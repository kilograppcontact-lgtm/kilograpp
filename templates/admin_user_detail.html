{% extends 'base.html' %}
{% block content %}

<!-- –ì—Ä—É–∑–∏–º Chart.js –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Jinja –≤ window -->
<script>
  if (!window.Chart) {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    s.defer = true;
    document.head.appendChild(s);
  }
  window._activityData = {
    labels: {{ activity_chart_labels|tojson }},
    steps:  {{ activity_steps_values|tojson }},
    kcal:   {{ activity_kcal_values|tojson }}
  };
</script>

<div class="max-w-7xl mx-auto px-4 py-6"
     x-data="{
       /* --- utils --- */
       parseAny(v){
         try{
           let out = v;
           if (typeof out === 'string') out = JSON.parse(out);
           return Array.isArray(out) ? out : [];
         }catch(_e){ return []; }
       },
       ensureChartReady(cb){
         if (window.Chart) return cb();
         let tries = 0;
         const t = setInterval(() => {
           if (window.Chart || tries++ > 100){ clearInterval(t); if (window.Chart) cb(); }
         }, 40);
         window.addEventListener('load', () => { if (window.Chart) cb(); }, { once:true });
       },

       /* --- toast --- */
       toasts: [],
       toast(text, type='ok'){ const id=Date.now()+Math.random(); this.toasts.push({id,text,type}); setTimeout(()=>this.dismissToast(id), 3500); },
       dismissToast(id){ this.toasts = this.toasts.filter(t=>t.id!==id); },
       copy(v){ navigator.clipboard.writeText(v).then(()=>this.toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ')).catch(()=>this.toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å','err')); },

       /* --- –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ --- */
       openTest:false, unlinkOpen:false,
       isModalOpen:false,

       /* --- —Ñ–∏–ª—å—Ç—Ä—ã --- */
       mealQ:'', mealType:'',
       bodyQ:'', dietQ:'',
       filterMeal(dateISO, type, name, analysis){
         const q = this.mealQ.toLowerCase().trim();
         const okQ = !q || (name.toLowerCase().includes(q) || analysis.toLowerCase().includes(q));
         const okT = !this.mealType || (type === this.mealType);
         return okQ && okT;
       },
       filterBody(dt, w, m, f, bmi, meta){
         const q = this.bodyQ.toLowerCase().trim();
         if(!q) return true;
         return [dt,w,m,f,bmi,meta].some(v => (''+v).toLowerCase().includes(q));
       },
       filterDiet(dt, kcal){
         const q = this.dietQ.toLowerCase().trim();
         if(!q) return true;
         return (dt.toLowerCase().includes(q) || (''+kcal).toLowerCase().includes(q));
       },

       /* --- –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ --- */
       labels: [],
       steps:  [],
       kcal:   [],

       /* --- init --- */
       init(){
         const raw = window._activityData || {};
         this.labels = this.parseAny(raw.labels);
         this.steps  = this.parseAny(raw.steps);
         this.kcal   = this.parseAny(raw.kcal);

         this.$nextTick(() => {
           this.ensureChartReady(() => this.makeCharts());
         });
       },

       /* --- –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ --- */
       makeCharts(){
         const labels = this.labels, steps = this.steps, kcal = this.kcal;

         const sctx = document.getElementById('stepsChart');
         if (sctx && labels.length && steps.length){
           new Chart(sctx, {
             type: 'line',
             data: { labels, datasets: [{ label: '–®–∞–≥–∏', data: steps, borderColor:'rgb(54,162,235)', backgroundColor:'rgba(54,162,235,0.2)', fill:true, tension:0.15 }]},
             options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true }}, plugins:{ legend:{ display:false }}}
           });
         }

         const kctx = document.getElementById('kcalChart');
         if (kctx && labels.length && kcal.length){
           new Chart(kctx, {
             type: 'line',
             data: { labels, datasets: [{ label: '–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏', data: kcal, borderColor:'rgb(75,192,192)', backgroundColor:'rgba(75,192,192,0.2)', fill:true, tension:0.15 }]},
             options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true }}, plugins:{ legend:{ display:false }}}
           });
         }
       }
     }"
>
  <style>
    [x-cloak]{display:none!important;}
    .chart-wrap{position:relative; height:260px;}
    .chart-wrap canvas{display:block; width:100% !important; height:100% !important;}
    @media (max-width: 640px){ .chart-wrap{height:220px;} }
  </style>

  <!-- toasts -->
  <div class="fixed right-4 top-4 space-y-2 z-50" x-cloak>
    <template x-for="t in toasts" :key="t.id">
      <div x-text="t.text"
           class="rounded-lg px-3 py-2 text-sm text-white shadow"
           :class="t.type==='ok' ? 'bg-emerald-600' : 'bg-red-600'"
           x-transition
           @click="dismissToast(t.id)"></div>
    </template>
  </div>

  <h1 class="text-3xl font-bold mb-6">
    –î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {{ user.name }} (ID: {{ user.id }})
  </h1>

  <div class="flex items-center gap-3 mb-6">
    <a href="{{ url_for('admin_dashboard') }}"
       class="inline-flex items-center px-4 py-2 border border-gray-200 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
      ‚Üê –ù–∞–∑–∞–¥ –∫ –ø–∞–Ω–µ–ª–∏
    </a>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="flex flex-wrap gap-2">
      <form method="post" action="{{ url_for('admin_send_magic_link', user_id=user.id) }}">
        <button class="px-3 py-2 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 text-sm">üîó –ú–∞–≥–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞</button>
      </form>
      <a href="{{ url_for('admin_impersonate_user', user_id=user.id) }}"
         class="px-3 py-2 rounded-lg text-white bg-amber-600 hover:bg-amber-700 text-sm">üë§ –ò–º–ø–µ—Ä—Å–æ–Ω–∞—Ü–∏—è</a>
      <form method="post" action="{{ url_for('admin_user_export', user_id=user.id) }}" class="inline">
        <input type="hidden" name="format" value="json">
        <button class="px-3 py-2 rounded-lg text-white bg-emerald-600 hover:bg-emerald-700 text-sm">‚¨á JSON</button>
      </form>
      <form method="post" action="{{ url_for('admin_user_export', user_id=user.id) }}" class="inline">
        <input type="hidden" name="format" value="csv">
        <button class="px-3 py-2 rounded-lg text-white bg-emerald-600 hover:bg-emerald-700 text-sm">‚¨á CSV</button>
      </form>
    </div>
  </div>

  <div class="grid lg:grid-cols-3 gap-6">
    <!-- –°–∞–π–¥–±–∞—Ä -->
    <div class="lg:col-span-1 space-y-6 h-fit lg:sticky lg:top-6">
      <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-semibold mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h2>
        <form method="post" action="{{ url_for('admin_user_edit', user_id=user.id) }}" enctype="multipart/form-data" class="space-y-4">
          <div>
            <label class="block text-sm font-medium">–ò–º—è</label>
            <input type="text" name="name" value="{{ user.name }}" class="mt-1 w-full border rounded-md px-3 py-2" required>
          </div>
          <div>
            <label class="block text-sm font-medium">Email</label>
            <input type="email" name="email" value="{{ user.email }}" class="mt-1 w-full border rounded-md px-3 py-2" required>
          </div>
          <div>
            <label class="block text-sm font-medium">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
            <input type="date" name="date_of_birth" value="{{ user.date_of_birth.isoformat() if user.date_of_birth else '' }}" class="mt-1 w-full border rounded-md px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input type="password" name="password" class="mt-1 w-full border rounded-md px-3 py-2">
          </div>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="is_trainer" value="true" {% if user.is_trainer %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-blue-600">
            <span class="text-sm">–Ø–≤–ª—è–µ—Ç—Å—è —Ç—Ä–µ–Ω–µ—Ä–æ–º</span>
          </label>
          <div>
            <label class="block text-sm font-medium">–ê–≤–∞—Ç–∞—Ä</label>
            <input type="file" name="avatar" accept="image/*" class="mt-1 w-full border rounded-md px-3 py-2">
            {% if user.avatar %}
              <img src="{{ url_for('serve_uploaded_file', filename=user.avatar) }}" alt="–ê–≤–∞—Ç–∞—Ä"
                   class="mt-2 w-16 h-16 rounded-full object-cover">
            {% endif %}
          </div>

          <div class="flex justify-end">
            <button class="px-4 py-2 rounded-lg text-white bg-blue-600 hover:bg-blue-700">
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            </button>
          </div>
        </form>
      </div>

      <!-- Telegram -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-semibold mb-4">Telegram</h2>

        {% if user.telegram_chat_id %}
          <div class="text-sm mb-3">
            <div class="text-gray-500">–ü—Ä–∏–≤—è–∑–∞–Ω:</div>
            <div class="font-medium break-all flex items-center gap-2">
              chat_id: {{ user.telegram_chat_id }}
              <button type="button" class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200"
                      @click="copy('{{ user.telegram_chat_id }}')">–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
          </div>

          <div class="flex flex-col gap-2">
            <button class="px-3 py-2 rounded-lg bg-cyan-600 text-white hover:bg-cyan-700"
                    @click="openTest = !openTest">
              ‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç-—Å–æ–æ–±—â–µ–Ω–∏–µ
            </button>
            <form x-show="openTest" x-cloak method="post" action="{{ url_for('admin_user_send_test_tg', user_id=user.id) }}" class="space-y-2">
              <textarea name="text" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="–¢–µ–∫—Å—Ç‚Ä¶">–ü—Ä–∏–≤–µ—Ç, {{ user.name }}! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ üí¨</textarea>
              <button class="px-3 py-2 rounded-lg bg-cyan-600 text-white hover:bg-cyan-700">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>

            <button class="px-3 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700"
                    @click="unlinkOpen = true">
              üîÑ –û—Ç–≤—è–∑–∞—Ç—å Telegram
            </button>
            <!-- –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–≤—è–∑–∫–∏ -->
            <div x-show="unlinkOpen" x-cloak class="fixed inset-0 z-40 flex items-center justify-center">
              <div class="absolute inset-0 bg-black/40" @click="unlinkOpen=false"></div>
              <div class="relative bg-white rounded-lg shadow p-6 w-full max-w-md">
                <h3 class="text-lg font-semibold mb-2">–û—Ç–≤—è–∑–∞—Ç—å Telegram?</h3>
                <p class="text-sm text-gray-600">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Ç–µ—Ä—è–µ—Ç —Å–≤—è–∑—å —Å –±–æ—Ç–æ–º –¥–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏.</p>
                <div class="mt-4 flex justify-end gap-2">
                  <button class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200" @click="unlinkOpen=false">–û—Ç–º–µ–Ω–∞</button>
                  <form method="post" action="{{ url_for('admin_user_unlink_telegram', user_id=user.id) }}">
                    <button class="px-3 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">–û—Ç–≤—è–∑–∞—Ç—å</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <div class="text-sm text-gray-600">Telegram –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω.</div>
          <p class="text-xs text-gray-500 mt-1">–ü–æ–ø—Ä–æ—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ –∏ –ø—Ä–æ–π—Ç–∏ –ø—Ä–∏–≤—è–∑–∫—É –ø–æ –∫–æ–¥—É/—Å—Å—ã–ª–∫–µ.</p>
          <form method="post" action="{{ url_for('admin_send_magic_link', user_id=user.id) }}" class="mt-3">
            <button class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –≤—Ö–æ–¥</button>
          </form>
        {% endif %}
      </div>

      <!-- –ü–æ–¥–ø–∏—Å–∫–∞ (–º–æ–¥–∞–ª–∫–∞ –≤–Ω—É—Ç—Ä–∏) -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-semibold mb-3">–ü–æ–¥–ø–∏—Å–∫–∞</h2>
        <button @click="isModalOpen=true" type="button"
                class="w-full px-4 py-2 rounded-lg text-white
                  {% if user.subscription and user.subscription.is_active %} bg-green-600 hover:bg-green-700
                  {% elif user.subscription and user.subscription.status == 'frozen' %} bg-blue-600 hover:bg-blue-700
                  {% else %} bg-gray-500 hover:bg-gray-600 {% endif %}">
          {% if user.subscription and user.subscription.is_active %}
            {% if user.subscription.end_date %} –ê–∫—Ç–∏–≤–Ω–∞ –¥–æ {{ user.subscription.end_date.strftime('%d.%m.%Y') }} {% else %} ‚úÖ –ë–µ–∑–ª–∏–º–∏—Ç–Ω–∞—è {% endif %}
          {% elif user.subscription and user.subscription.status == 'frozen' %}
            ‚ùÑÔ∏è –ó–∞–º–æ—Ä–æ–∂–µ–Ω–∞ (–æ—Å—Ç–∞–ª–æ—Å—å {{ user.subscription.remaining_days_on_freeze }} –¥–Ω.)
          {% else %}
            –ù–µ–∞–∫—Ç–∏–≤–Ω–∞
          {% endif %}
          (–£–ø—Ä–∞–≤–ª—è—Ç—å)
        </button>

        <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ -->
        <div x-show="isModalOpen" x-cloak class="fixed inset-0 z-40 flex items-center justify-center">
          <div class="absolute inset-0 bg-black/40" @click="isModalOpen=false"></div>
          <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h3 class="text-xl font-semibold">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π</h3>
                {% if user.subscription %}
                  <p class="text-sm text-gray-600 mt-1">
                    –°—Ç–∞—Ç—É—Å:
                    <span class="font-medium">
                      {% if user.subscription.is_active %}–ê–∫—Ç–∏–≤–Ω–∞{% elif user.subscription.status=='frozen' %}–ó–∞–º–æ—Ä–æ–∂–µ–Ω–∞{% else %}–ù–µ–∞–∫—Ç–∏–≤–Ω–∞{% endif %}
                    </span>
                    {% if user.subscription.start_date %} ‚Ä¢ –ù–∞—á–∞–ª–æ: {{ user.subscription.start_date.strftime('%d.%m.%Y') }}{% endif %}
                    {% if user.subscription.end_date %} ‚Ä¢ –ö–æ–Ω–µ—Ü: {{ user.subscription.end_date.strftime('%d.%m.%Y') }}{% endif %}
                  </p>
                {% else %}
                  <p class="text-sm text-gray-600 mt-1">–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.</p>
                {% endif %}
              </div>
              <button class="p-2 rounded-lg hover:bg-gray-100" @click="isModalOpen=false" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
            </div>

            <div class="mt-4 grid sm:grid-cols-2 gap-4">
              <div class="border rounded-lg p-4">
                <div class="text-sm text-gray-500">–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</div>
                <div class="mt-1 text-lg font-semibold">
                  {% if user.subscription %}
                    {% if user.subscription.is_active %}–ê–∫—Ç–∏–≤–Ω–∞{% elif user.subscription.status=='frozen' %}–ó–∞–º–æ—Ä–æ–∂–µ–Ω–∞{% else %}–ù–µ–∞–∫—Ç–∏–≤–Ω–∞{% endif %}
                  {% else %}–ù–µ—Ç{% endif %}
                </div>
                {% if user.subscription and user.subscription.end_date %}
                  <div class="text-sm mt-1">–î–æ: {{ user.subscription.end_date.strftime('%d.%m.%Y') }}</div>
                {% endif %}
              </div>

              <div class="border rounded-lg p-4">
                <div class="text-sm text-gray-500">–û–ø—Ü–∏–∏</div>
                <ul class="mt-2 space-y-2 text-sm text-gray-700 list-disc pl-5">
                  <li>–ü—Ä–æ–¥–ª–∏—Ç—å –∏–ª–∏ –∑–∞–º–æ—Ä–æ–∑–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É (–Ω—É–∂–Ω—ã —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã).</li>
                  <li>–í—ã—Å–ª–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.</li>
                  <li>–°–Ω—è—Ç—å –∑–∞–º–æ—Ä–æ–∑–∫—É –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.</li>
                </ul>
              </div>
            </div>

            <div class="mt-6 flex justify-end gap-2">
              <button class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200" @click="isModalOpen=false">–ó–∞–∫—Ä—ã—Ç—å</button>
              <button class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700" @click="isModalOpen=false">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </div>
        </div>
        <!-- /–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ -->
      </div>

      <!-- –£–¥–∞–ª–µ–Ω–∏–µ -->
      <div class="bg-white shadow rounded-lg p-6">
        <form action="{{ url_for('admin_delete_user', user_id=user.id) }}" method="POST"
              onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ user.name }}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.');">
          <button class="w-full px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">
            –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          </button>
        </form>
      </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="lg:col-span-2 space-y-6">
      <!-- –°—Ç–∞—Ç—É—Å –∑–∞ —Å–µ–≥–æ–¥–Ω—è -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">–°—Ç–∞—Ç—É—Å –∑–∞ —Å–µ–≥–æ–¥–Ω—è ({{ today.strftime('%d.%m.%Y') }})</h2>
        <div class="grid sm:grid-cols-2 gap-4">
          <div class="p-4 rounded-lg {{ 'bg-green-100 text-green-800' if has_meal_today else 'bg-red-100 text-red-800' }}">
            <div class="font-medium">–ü–∏—Ç–∞–Ω–∏–µ</div>
            <div class="text-lg font-bold">{{ '‚úî –ó–∞–ø–æ–ª–Ω–µ–Ω–æ' if has_meal_today else '‚úò –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö' }}</div>
          </div>
          <div class="p-4 rounded-lg {{ 'bg-green-100 text-green-800' if has_activity_today else 'bg-red-100 text-red-800' }}">
            <div class="font-medium">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
            <div class="text-lg font-bold">{{ '‚úî –ó–∞–ø–æ–ª–Ω–µ–Ω–æ' if has_activity_today else '‚úò –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö' }}</div>
          </div>
        </div>
      </div>

      <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–º–µ—Ä–æ–≤ —Ç–µ–ª–∞ -->
      <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between gap-3 mb-4 flex-wrap">
          <h2 class="text-xl font-semibold">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–º–µ—Ä–æ–≤ —Ç–µ–ª–∞</h2>
          <div class="flex items-center gap-2">
            <input x-model="bodyQ" type="text" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ/–∑–Ω–∞—á–µ–Ω–∏—è–º‚Ä¶" class="border rounded-lg px-3 py-2 text-sm">
          </div>
        </div>
        {% if body_analyses %}
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left">–î–∞—Ç–∞</th>
                  <th class="px-4 py-3 text-left">–í–µ—Å</th>
                  <th class="px-4 py-3 text-left">–ú—ã—à—Ü—ã</th>
                  <th class="px-4 py-3 text-left">–ñ–∏—Ä</th>
                  <th class="px-4 py-3 text-left">–ò–ú–¢</th>
                  <th class="px-4 py-3 text-left">–ú–µ—Ç–∞–±–æ–ª–∏–∑–º</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                {% for analysis in body_analyses %}
                <template x-if="filterBody(`{{ analysis.timestamp.strftime('%d.%m.%Y %H:%M') }}`,
                                           `{{ (analysis.weight or '') }}`,
                                           `{{ (analysis.muscle_mass or '') }}`,
                                           `{{ (analysis.fat_mass or '') }}`,
                                           `{{ (analysis.bmi or '') }}`,
                                           `{{ (analysis.metabolism or '') }}`)">
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 whitespace-nowrap">{{ analysis.timestamp.strftime('%d.%m.%Y %H:%M') }}</td>
                    <td class="px-4 py-3">{{ analysis.weight or '‚Äî' }}</td>
                    <td class="px-4 py-3">{{ analysis.muscle_mass or '‚Äî' }}</td>
                    <td class="px-4 py-3">{{ analysis.fat_mass or '‚Äî' }}</td>
                    <td class="px-4 py-3">{{ analysis.bmi or '‚Äî' }}</td>
                    <td class="px-4 py-3">{{ analysis.metabolism or '‚Äî' }}</td>
                  </tr>
                </template>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-sm text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞–º–µ—Ä–æ–≤ —Ç–µ–ª–∞.</p>
        {% endif %}
      </div>

      <!-- –ò—Å—Ç–æ—Ä–∏—è –¥–∏–µ—Ç -->
      <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between gap-3 mb-4 flex-wrap">
          <h2 class="text-xl font-semibold">–ò—Å—Ç–æ—Ä–∏—è –¥–∏–µ—Ç</h2>
          <div class="flex items-center gap-2">
            <input x-model="dietQ" type="text" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ/–∫–∫–∞–ª‚Ä¶" class="border rounded-lg px-3 py-2 text-sm">
          </div>
        </div>
        {% if diets %}
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left">–î–∞—Ç–∞</th>
                  <th class="px-4 py-3 text-left">–ö–∞–ª–æ—Ä–∏–∏</th>
                  <th class="px-4 py-3 text-left">–ë–µ–ª–∫–∏</th>
                  <th class="px-4 py-3 text-left">–ñ–∏—Ä—ã</th>
                  <th class="px-4 py-3 text-left">–£–≥–ª–µ–≤–æ–¥—ã</th>
                  <th class="px-4 py-3 text-left">–î–µ—Ç–∞–ª–∏</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                {% for diet_entry in diets %}
                <template x-if="filterDiet(`{{ diet_entry.date.strftime('%d.%m.%Y') }}`, `{{ diet_entry.total_kcal or '' }}`)">
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 whitespace-nowrap">{{ diet_entry.date.strftime('%d.%m.%Y') }}</td>
                    <td class="px-4 py-3">{{ diet_entry.total_kcal or '‚Äî' }}</td>
                    <td class="px-4 py-3">{{ diet_entry.protein or '‚Äî' }}</td>
                    <td class="px-4 py-3">{{ diet_entry.fat or '‚Äî' }}</td>
                    <td class="px-4 py-3">{{ diet_entry.carbs or '‚Äî' }}</td>
                    <td class="px-4 py-3">
                      <a href="{{ url_for('view_diet', diet_id=diet_entry.id) }}" target="_blank" class="text-blue-600 hover:text-blue-800">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>
                    </td>
                  </tr>
                </template>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-sm text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–∏–µ—Ç–∞—Ö.</p>
        {% endif %}
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</h2>

        <div class="mb-6">
          <h3 class="text-lg font-medium mb-2">–®–∞–≥–∏</h3>
          <template x-if="labels.length && steps.length">
            <div class="chart-wrap"><canvas id="stepsChart"></canvas></div>
          </template>
          <p x-show="!labels.length || !steps.length" class="text-sm text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞.</p>
        </div>

        <div>
          <h3 class="text-lg font-medium mb-2">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏</h3>
          <template x-if="labels.length && kcal.length">
            <div class="chart-wrap"><canvas id="kcalChart"></canvas></div>
          </template>
          <p x-show="!labels.length || !kcal.length" class="text-sm text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞.</p>
        </div>
      </div>

      <!-- –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ -->
      <div class="bg-white shadow rounded-lg –ø-6 p-6">
        <div class="flex items-center justify-between gap-3 mb-4 flex-wrap">
          <h2 class="text-xl font-semibold">–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏</h2>
          <div class="flex items-center gap-2">
            <input x-model="mealQ" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/–∞–Ω–∞–ª–∏–∑—É‚Ä¶" class="border rounded-lg px-3 py-2 text-sm">
            <select x-model="mealType" class="border rounded-lg px-3 py-2 text-sm">
              <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
              <option value="breakfast">–ó–∞–≤—Ç—Ä–∞–∫</option>
              <option value="lunch">–û–±–µ–¥</option>
              <option value="dinner">–£–∂–∏–Ω</option>
              <option value="snack">–ü–µ—Ä–µ–∫—É—Å</option>
            </select>
          </div>
        </div>
        {% if meal_logs %}
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left">–î–∞—Ç–∞</th>
                  <th class="px-4 py-3 text-left">–¢–∏–ø</th>
                  <th class="px-4 py-3 text-left">–ö–∞–ª–æ—Ä–∏–∏</th>
                  <th class="px-4 py-3 text-left">–ë/–ñ/–£</th>
                  <th class="px-4 py-3 text-left">–ê–Ω–∞–ª–∏–∑</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                {% for meal_log in meal_logs %}
                <template x-if="filterMeal(`{{ meal_log.date.strftime('%Y-%m-%d') }}`,
                                           '{{ meal_log.meal_type }}',
                                           `{{ (meal_log.name or '')|e }}`,
                                           `{{ (meal_log.analysis or '')|e }}`)">
                  <tr class="hover:bg-gray-50 align-top">
                    <td class="px-4 py-3 whitespace-nowrap">{{ meal_log.date.strftime('%d.%m.%Y') }}</td>
                    <td class="px-4 py-3 capitalize">{{ meal_log.meal_type }}</td>
                    <td class="px-4 py-3">{{ meal_log.calories }}</td>
                    <td class="px-4 py-3">{{ meal_log.protein }}/{{ meal_log.fat }}/{{ meal_log.carbs }}</td>
                    <td class="px-4 py-3 max-w-md">
                      <details>
                        <summary class="cursor-pointer text-blue-600 hover:text-blue-800">–ü–æ–∫–∞–∑–∞—Ç—å</summary>
                        <pre class="whitespace-pre-wrap">{{ meal_log.analysis }}</pre>
                      </details>
                    </td>
                  </tr>
                </template>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-sm text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏—ë–º–∞—Ö –ø–∏—â–∏.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
