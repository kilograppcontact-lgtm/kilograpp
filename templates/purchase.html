{% extends 'base.html' %}
{% block content %}

<style>
  /* –§–æ–Ω–æ–≤—ã–µ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—è—Ç–Ω–∞ */
  .blob {
    position: absolute; filter: blur(40px); opacity: .25; border-radius: 50%;
    animation: float 14s ease-in-out infinite;
    will-change: transform;
  }
  .blob-1 { width: 360px; height: 360px; background: #60a5fa; left: -80px; top: -60px; animation-delay: 0s; }
  .blob-2 { width: 420px; height: 420px; background: #a78bfa; right: -120px; top: 40px; animation-delay: 1.5s; }
  .blob-3 { width: 300px; height: 300px; background: #34d399; left: 40%; bottom: -120px; animation-delay: 3s; }

  @keyframes float {
    0%,100% { transform: translateY(0) translateX(0) scale(1); }
    50%     { transform: translateY(-20px) translateX(10px) scale(1.03); }
  }

  /* –ü–ª–∞–≤–Ω—ã–µ –≤—Ö–æ–¥—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
  .reveal { opacity: 0; transform: translateY(16px); transition: all .6s cubic-bezier(.22,1,.36,1); }
  .reveal.in { opacity: 1; transform: translateY(0); }

  /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤ */
  .plan {
    transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
    transform: translateZ(0);
  }
  .plan:hover {
    transform: translateY(-4px) rotateX(0.6deg) rotateY(-0.6deg);
    box-shadow: 0 20px 35px -12px rgba(0,0,0,.15);
    border-color: rgba(99,102,241,.4);
  }

  /* –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–ª–∞–Ω */
  .plan.recommended {
    position: relative; border: 2px solid rgba(99,102,241,.35);
  }
  .plan.recommended::after {
    content: ""; position: absolute; inset: -2px; border-radius: 1rem;
    background: conic-gradient(from 0deg, rgba(99,102,241,.35), transparent 40%, rgba(99,102,241,.35));
    filter: blur(14px); opacity: .45; animation: spin 6s linear infinite;
    z-index: -1;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* –õ–µ–Ω—Ç–∞ */
  .ribbon {
    position: absolute; top: 14px; right: -8px;
    background: linear-gradient(90deg, #6366f1, #8b5cf6);
    color: #fff; font-weight: 700; font-size: .70rem;
    padding: .375rem .625rem; border-radius: .5rem;
    box-shadow: 0 8px 18px rgba(99,102,241,.35);
    transform: rotate(3deg);
  }
</style>

<div class="relative overflow-hidden">
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>
  <div class="blob blob-3"></div>

  <section class="max-w-7xl mx-auto px-4 pt-12 pb-8 relative">
    <div class="card p-8 sm:p-12 text-center bg-white reveal">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-900">
        –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º—É: —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –ò–ò-–¥–∏–µ—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
      </h1>

      <div class="mt-6">

        {% if current_user.is_authenticated and current_user.subscription_status == 'active' %}
          <button onclick="showAlreadySubscribedAlert()"
                  class="btn text-base px-6 py-3 text-white
                         bg-gradient-to-r from-indigo-500 via-blue-500 to-sky-500
                         hover:from-indigo-600 hover:via-blue-600 hover:to-sky-600
                         focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-500
                         shadow-lg hover:shadow-xl active:opacity-90 transition">
            –°–≤—è–∑–∞—Ç—å—Å—è –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
          </button>
        {% else %}
          <button onclick="openContactModal()"
                  class="btn text-base px-6 py-3 text-white
                         bg-gradient-to-r from-indigo-500 via-blue-500 to-sky-500
                         hover:from-indigo-600 hover:via-blue-600 hover:to-sky-600
                         focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-500
                         shadow-lg hover:shadow-xl active:opacity-90 transition">
            –°–≤—è–∑–∞—Ç—å—Å—è –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
          </button>
        {% endif %}

      </div>
    </div>
  </section>

  <section class="max-w-7xl mx-auto px-4 pb-14 relative">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 lg:max-w-4xl lg:mx-auto">

      <div class="card plan p-6 reveal">
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-xl font-bold text-slate-900">Free</h3>
            <p class="text-slate-600 text-sm mt-1">–ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</p>
          </div>
          <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-slate-400 to-slate-500 text-white flex items-center justify-center shadow">üí°</div>
        </div>
        <div class="mt-5 space-y-2 text-slate-700">
          <div class="flex items-center gap-2"><span class="text-slate-600">‚úî</span><span class="text-sm">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ AI-–¥–∏–µ—Ç—ã</span></div>
          <div class="flex items-center gap-2"><span class="text-slate-600">‚úî</span><span class="text-sm">–ë–∞–∑–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</span></div>
          <div class="flex items-center gap-2"><span class="text-slate-600">‚úî</span><span class="text-sm">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ Telegram</span></div>
        </div>
        <div class="mt-6">
          <div class="text-sm text-slate-500">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
          <div class="text-3xl font-extrabold text-slate-900">0 —Ç–≥</div>
          <div class="text-xs text-slate-500 mt-1">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø</div>
        </div>
      </div>

      <div class="card plan recommended p-6 relative reveal" style="background: linear-gradient(180deg,#ffffff 0%,#f8fafc 100%);">
        <div class="ribbon">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º</div>
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-xl font-bold text-slate-900">PLUS</h3>
            <p class="text-slate-600 text-sm mt-1">–í—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</p>
          </div>
          <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-indigo-500 to-blue-600 text-white flex items-center justify-center shadow">‚≠ê</div>
        </div>
        <div class="mt-5 space-y-2 text-slate-700">
          <div class="flex items-center gap-2"><span class="text-indigo-600">‚úî</span><span class="text-sm">–í—Å—ë –∏–∑ Free</span></div>
          <div class="flex items-center gap-2"><span class="text-indigo-600">‚úî</span><span class="text-sm">–ì–ª—É–±–æ–∫–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</span></div>
          <div class="flex items-center gap-2"><span class="text-indigo-600">‚úî</span><span class="text-sm">–ê–Ω–∞–ª–∏–∑ –±–ª—é–¥ –ø–æ —Ñ–æ—Ç–æ (AI)</span></div>
          <div class="flex items-center gap-2"><span class="text-indigo-600">‚úî</span><span class="text-sm">–ì—Ä—É–ø–ø—ã –∏ —á–µ–ª–ª–µ–Ω–¥–∂–∏</span></div>
          <div class="flex items-center gap-2"><span class="text-indigo-600">‚úî</span><span class="text-sm">–ì–∏–±–∫–∏–µ —Å–ª–æ—Ç—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</span></div>
        </div>
        <div class="mt-6">
          <div class="text-sm text-slate-500">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
          <div class="text-3xl font-extrabold text-slate-900">9 990 —Ç–≥</div>
          <div class="text-xs text-slate-500 mt-1">–°—Ä–æ–∫: 3 –º–µ—Å—è—Ü–∞</div>
        </div>
      </div>
    </div>
  </section>
</div>

<div id="contactModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="closeContactModal()">
  <div class="card w-full max-w-lg p-0 relative animate-fade-in bg-white" onclick="event.stopPropagation()">
    <button onclick="closeContactModal()" class="absolute top-4 right-4 text-slate-400 text-2xl hover:text-slate-600">&times;</button>

    <div id="modal-content-wrapper">

      <div id="form-view">
        <div class="p-6 sm:p-8 text-center">
          <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white shadow-lg">
            <i class="bi bi-telephone-fill text-2xl"></i>
          </div>
          <h2 class="text-xl font-bold mt-4">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</h2>
          <p class="text-slate-600 text-sm mt-1">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∏ –º—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ PLUS.</p>

          <form id="application-form" class="mt-6" onsubmit="submitApplication(event)">
            <input type="tel" id="phone-input"
                   placeholder="–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–Ω–∞–ø—Ä. +7 700 123 4567)"
                   required
                   class="w-full h-12 px-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition">

            <p id="form-error" class="text-red-600 text-sm mt-2 hidden"></p>

            <button type="submit" id="submit-app-btn"
               class="btn btn-primary w-full mt-4">
              –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
            </button>
          </form>
        </div>
      </div>

      <div id="success-view" class="hidden">
        <div class="p-6 sm:p-8 text-center">
          <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 text-white shadow-lg">
            <i class="bi bi-check-lg text-3xl"></i>
          </div>
          <h2 class="text-xl font-bold mt-4">–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!</h2>
          <p class="text-slate-600 text-sm mt-1" id="success-message">
            –ú—ã —Å–∫–æ—Ä–æ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ–º—Å—è.
          </p>
          <button onclick="closeContactModal()" class="btn w-full mt-6 bg-slate-100 text-slate-700 hover:bg-slate-200">
            –ó–∞–∫—Ä—ã—Ç—å
          </button>
        </div>
      </div>

    </div>
  </div>
</div>


<script>
  // –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  const contactModal = document.getElementById('contactModal');
  const formView = document.getElementById('form-view');
  const successView = document.getElementById('success-view');
  const formError = document.getElementById('form-error');
  const submitBtn = document.getElementById('submit-app-btn');
  const phoneInput = document.getElementById('phone-input');
  const successMessage = document.getElementById('success-message');

  // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–∫—Ä–æ–ª–ª–∞
  function lockScroll(lock = true) { document.documentElement.style.overflow = lock ? 'hidden' : ''; }

  // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø ---
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç alert, –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ —É–∂–µ –µ—Å—Ç—å
  function showAlreadySubscribedAlert() {
    alert("–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –¥–µ–π—Å—Ç–≤—É—é—â–∞—è –ø–æ–¥–ø–∏—Å–∫–∞.");
  }

  // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ (—Ç–µ–ø–µ—Ä—å —Å–æ —Å–±—Ä–æ—Å–æ–º)
  function openContactModal() {
    if (!contactModal) return;

    // –°–±—Ä–æ—Å –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É, –ø—Ä—è—á–µ–º —É—Å–ø–µ—Ö)
    formView.classList.remove('hidden');
    successView.classList.add('hidden');
    formError.classList.add('hidden');
    formError.innerText = '';
    phoneInput.value = '';
    submitBtn.disabled = false;
    submitBtn.innerText = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';

    contactModal.classList.remove('hidden');
    contactModal.classList.add('flex');
    lockScroll(true);
    setTimeout(() => { phoneInput.focus(); }, 50);
  }

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
  function closeContactModal() {
    if (!contactModal) return;
    contactModal.classList.add('hidden');
    contactModal.classList.remove('flex');
    lockScroll(false);
  }

  // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø ---
  // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  async function submitApplication(event) {
    event.preventDefault(); // –ù–µ –¥–∞–µ–º —Ñ–æ—Ä–º–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É

    const phone = phoneInput.value;

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
    submitBtn.disabled = true;
    submitBtn.innerText = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
    formError.classList.add('hidden');

    try {
      const response = await fetch('/api/create_application', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          // –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å CSRF-—Ç–æ–∫–µ–Ω—ã (–∞ –≤–æ Flask-WTF –æ–Ω–∏ –µ—Å—Ç—å),
          // –∏—Ö –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏.
          // –ù–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ API-—ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –Ω—É–∂–Ω–æ.
        },
        body: JSON.stringify({ phone: phone })
      });

      const data = await response.json();

      if (response.ok) {
        // –£—Å–ø–µ—Ö! –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –º–µ–Ω—è–µ–º –≤–∏–¥ –º–æ–¥–∞–ª–∫–∏
        successMessage.innerText = data.message;
        formView.classList.add('hidden');
        successView.classList.remove('hidden');
      } else {
        // –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä. "–≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä" –∏–ª–∏ "—É–∂–µ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∞")
        formError.innerText = data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.';
        formError.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.innerText = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
      }

    } catch (error) {
      // –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ (—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏ —Ç.–¥.)
      console.error('Fetch Error:', error);
      formError.innerText = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
      formError.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.innerText = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
    }
    // 'finally' –Ω–µ –Ω—É–∂–µ–Ω, —Ç.–∫. –∫–Ω–æ–ø–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
  }

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeContactModal(); });

  // –í—Ö–æ–¥–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫/hero (—Å—Ç–∞—Ä—ã–π –∫–æ–¥)
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('in'); });
  }, { threshold: .12 });
  document.querySelectorAll('.reveal').forEach(el => io.observe(el));
</script>

{% endblock %}