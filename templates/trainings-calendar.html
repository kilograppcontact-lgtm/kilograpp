{% extends "base.html" %}
{% set title = "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫" %}

{% block content %}
<style>
@keyframes slide-left { from { opacity:0; transform: translateX(14px); } to { opacity:1; transform: translateX(0);} }
@keyframes slide-right{ from { opacity:0; transform: translateX(-14px);} to { opacity:1; transform: translateX(0);} }
@keyframes fade { from { opacity:0;} to { opacity:1;} }
.grid-animate-left { animation: slide-left .2s ease-out; }
.grid-animate-right{ animation: slide-right .2s ease-out; }
.fade-in { animation: fade .2s ease-out; }

.calendar-cell:hover .day-badge { transform: translateY(-1px); }
.pill { transition: transform .15s, box-shadow .15s, background .15s, opacity .15s; }
.pill:hover { transform: translateY(-1px); box-shadow: 0 6px 16px -10px rgba(0,0,0,.25); }
.pill.disabled { opacity:.55; pointer-events:none; }

/* –ë–µ–π–¥–∂–∏ */
.badge { font-size: 10px; line-height: 1; padding: 3px 6px; border-radius: 999px; }

/* –ö—Ä—É–ø–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
.calendar-xl .calendar-cell { min-height: 220px; }
.calendar-xl #calendarGrid { min-height: 900px; }

/* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö, —á—Ç–æ–±—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–µ "—Ç–µ—Ä—è–ª—Å—è" */
.calendar-scroll {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.calendar-inner {
  min-width: 1000px; /* —à–∏—Ä–∏–Ω–∞ –º–µ—Å—è—Ü–∞ –¥–ª—è 7 –∫–æ–ª–æ–Ω–æ–∫ –Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
}

/* –õ–∏–ø–∫–∞—è —à–∞–ø–∫–∞ –¥–Ω–µ–π –≤ –æ–±–ª–∞—Å—Ç–∏ —Å–∫—Ä–æ–ª–ª–∞ */
.weekdays-sticky {
  position: sticky;
  top: 0;
  z-index: 5;
}

/* –ú–æ–¥–∞–ª–∫–∏ */
.modal-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.45); z-index: 60; }
.modal-overlay.show { display: flex; }
.modal-card { width: min(100%, 860px); max-height: 80vh; overflow: hidden; border-radius: 20px; }
.modal-body { max-height: 60vh; overflow: auto; }

/* –ú–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ */
@media (max-width: 768px) {
  .calendar-xl .calendar-cell { min-height: 130px; }
  .calendar-xl #calendarGrid { min-height: auto; }
}

/* –û—á–µ–Ω—å —É–∑–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
@media (max-width: 420px) {
  .calendar-inner { min-width: 900px; }
}
</style>

<section class="max-w-7xl xl:max-w-8xl mx-auto px-4 py-8">
  <!-- –®–∞–ø–∫–∞ -->
  <div class="mb-6 rounded-3xl overflow-hidden">
    <div class="relative isolate rounded-3xl p-5 md:p-6 bg-gradient-to-r from-emerald-600 via-teal-600 to-cyan-600 text-white">
      <div class="absolute inset-0 opacity-20 pointer-events-none"
           style="background: radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,.25), transparent),
                   radial-gradient(1000px 500px at 90% 120%, rgba(255,255,255,.25), transparent);">
      </div>

      <div class="relative z-10 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="flex flex-wrap items-center gap-3">
          <button id="prevMonth" class="p-2 rounded-xl bg-white/15 hover:bg-white/25 transition" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">
            <i class="bi bi-chevron-left"></i>
          </button>
          <div class="flex items-center gap-2">
            <div id="monthLabel" class="text-xl font-semibold tracking-tight">–ú–µ—Å—è—Ü YYYY</div>
            <select id="monthSelect" class="text-sm bg-white/10 border border-white/20 rounded-lg px-2 py-1">
              <option value="0">–Ø–Ω–≤–∞—Ä—å</option><option value="1">–§–µ–≤—Ä–∞–ª—å</option><option value="2">–ú–∞—Ä—Ç</option><option value="3">–ê–ø—Ä–µ–ª—å</option>
              <option value="4">–ú–∞–π</option><option value="5">–ò—é–Ω—å</option><option value="6">–ò—é–ª—å</option><option value="7">–ê–≤–≥—É—Å—Ç</option>
              <option value="8">–°–µ–Ω—Ç—è–±—Ä—å</option><option value="9">–û–∫—Ç—è–±—Ä—å</option><option value="10">–ù–æ—è–±—Ä—å</option><option value="11">–î–µ–∫–∞–±—Ä—å</option>
            </select>
            <input id="yearInput" type="number" class="w-24 text-sm bg-white/10 border border-white/20 rounded-lg px-2 py-1" placeholder="2025" />
          </div>
          <button id="nextMonth" class="p-2 rounded-xl bg-white/15 hover:bg-white/25 transition" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">
            <i class="bi bi-chevron-right"></i>
          </button>

          <button id="btnToday" class="ml-1 px-3 py-1.5 rounded-xl bg-white/15 hover:bg-white/25 transition">
            –°–µ–≥–æ–¥–Ω—è
          </button>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <div class="relative">
            <i class="bi bi-search absolute left-3 top-2.5 text-white/70"></i>
            <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫: —Ç—Ä–µ–Ω–µ—Ä, –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ ID‚Ä¶"
                   class="pl-9 pr-3 py-2 text-sm rounded-xl bg-white/15 placeholder-white/70 border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/50">
          </div>
          <label class="inline-flex items-center gap-2 text-sm bg-white/15 border border-white/20 rounded-xl px-3 py-2">
            <input id="onlyJoined" type="checkbox" class="rounded accent-white"/>
            –¢–æ–ª—å–∫–æ –º–æ–∏ –∑–∞–ø–∏—Å–∏
          </label>
          <span id="tzInfo" class="text-xs text-white/80"></span>

          <button id="btnMy" class="ml-1 inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white text-emerald-700 hover:bg-white/90 transition">
            <i class="bi bi-person-check"></i> –ú–æ–∏ –∑–∞–ø–∏—Å–∏
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å: —Å–∫—Ä–æ–ª–ª-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö -->
  <div class="calendar-xl rounded-3xl border border-gray-200 bg-white shadow-sm">
    <div class="calendar-scroll">
      <div class="calendar-inner">
        <!-- –®–∞–ø–∫–∞ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ -->
        <div class="grid grid-cols-7 gap-px bg-gray-100 weekdays-sticky">
          {% set weekdays = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'] %}
          {% for w in weekdays %}
            <div class="bg-gray-50 text-center text-[12px] font-semibold py-2 uppercase tracking-wide text-gray-600">
              {{ w }}
            </div>
          {% endfor %}
        </div>
        <!-- –°–µ—Ç–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
        <div id="calendarGrid" class="grid grid-cols-7 gap-px bg-gray-100"></div>
      </div>
    </div>
  </div>
</section>

<!-- –ú–æ–¥–∞–ª–∫–∞ –î–ï–ù–¨ -->
<div id="dayModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="dayModalDate">
  <div class="modal-card bg-white text-slate-900 shadow-xl">
    <div class="flex items-center justify-between p-4 border-b">
      <div>
        <div id="dayModalDate" class="text-lg font-semibold"></div>
        <div id="dayModalCount" class="text-xs text-gray-500"></div>
      </div>
      <button id="dayModalClose" class="p-2 rounded-lg hover:bg-black/5" aria-label="–ó–∞–∫—Ä—ã—Ç—å"><i class="bi bi-x-lg"></i></button>
    </div>
    <div id="dayModalBody" class="modal-body p-4 space-y-3">
      <!-- –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ú–û–ò –ó–ê–ü–ò–°–ò -->
<div id="myModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="myModalTitle">
  <div class="modal-card bg-white text-slate-900 shadow-xl">
    <div class="flex items-center justify-between p-4 border-b">
      <div id="myModalTitle" class="text-lg font-semibold">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</div>
      <button id="myModalClose" class="p-2 rounded-lg hover:bg-black/5" aria-label="–ó–∞–∫—Ä—ã—Ç—å"><i class="bi bi-x-lg"></i></button>
    </div>
    <div id="myModalBody" class="modal-body p-4">
      <div class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </div>
  </div>
</div>

<!-- –¢–æ—Å—Ç—ã -->
<div id="toastHost" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[70] space-y-2 pointer-events-none"></div>

<script>
(() => {
  const el = id => document.getElementById(id);

  const meId = {{ me_id or 'null' }};

  const monthLabel = el('monthLabel');
  const monthSelect = el('monthSelect');
  const yearInput = el('yearInput');
  const grid = el('calendarGrid');

  const btnPrev = el('prevMonth');
  const btnNext = el('nextMonth');
  const btnToday = el('btnToday');

  const btnMy = el('btnMy');

  const searchInput = el('searchInput');
  const onlyJoined = el('onlyJoined');
  const tzInfo = el('tzInfo');

  const dayModal = el('dayModal');
  const dayModalClose = el('dayModalClose');
  const dayModalBody = el('dayModalBody');
  const dayModalDate = el('dayModalDate');
  const dayModalCount = el('dayModalCount');

  const myModal = el('myModal');
  const myModalClose = el('myModalClose');
  const myModalBody = el('myModalBody');

  const ruMonths = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];

  const saved = JSON.parse(localStorage.getItem('trainings_month_client') || 'null');
  const now = new Date();
  const state = {
    y: saved?.y ?? now.getFullYear(),
    m: saved?.m ?? now.getMonth(),
    data: [],
    search: '',
    onlyJoined: false
  };

  const MAX_VISIBLE_IN_CELL = 6;

  function fmt2(n){ return String(n).padStart(2,'0'); }
  function yyyymm(y, m){ return y + '-' + fmt2(m+1); }
  function toLocalDateStr(y, m, d){ return y + '-' + fmt2(m+1) + '-' + fmt2(d); }
  function clampYear(v){ v = parseInt(v||'',10); if(isNaN(v)) return new Date().getFullYear(); return Math.min(9999, Math.max(1900, v)); }
  function isSameDate(a, b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }

  function tzString(){
    const z = -new Date().getTimezoneOffset()/60;
    const sign = z>=0?'+':'-';
    return `–í—Ä–µ–º—è –±—Ä–∞—É–∑–µ—Ä–∞ (GMT${sign}${Math.abs(z)})`;
  }
  tzInfo.textContent = tzString();

  function notify(text, ok=true){
    const host = el('toastHost');
    const box = document.createElement('div');
    box.className = `fade-in pointer-events-auto px-3 py-2 rounded-xl text-sm shadow ${ok ? 'bg-emerald-600 text-white' : 'bg-rose-600 text-white'}`;
    box.textContent = text;
    host.appendChild(box);
    setTimeout(()=>{ box.style.opacity='0'; box.style.transition='opacity .2s'; }, 2400);
    setTimeout(()=>{ host.removeChild(box); }, 2800);
  }

  function saveMonth(){ localStorage.setItem('trainings_month_client', JSON.stringify({y: state.y, m: state.m})); }

  // ---- Filters ----
  function monthHeader(){
    monthLabel.textContent = `${ruMonths[state.m]} ${state.y}`;
    monthSelect.value = String(state.m);
    yearInput.value = String(state.y);
  }
  function filteredData(){
    const q = (state.search || '').trim().toLowerCase();
    return state.data.filter(t => {
      if(state.onlyJoined && !t.joined) return false;
      if(q){
        const hay = `${t.trainer_name||''} ${t.title||''} ${String(t.id||'')}`.toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });
  }

  // ---- Render ----
  function renderGrid(animateDir){
    monthHeader();
    const data = filteredData();

    const byDate = {};
    for(const t of data){ (byDate[t.date] ||= []).push(t); }
    for(const k in byDate){ byDate[k].sort((a,b)=> a.start_time.localeCompare(b.start_time)); }

    const first = new Date(state.y, state.m, 1);
    const last = new Date(state.y, state.m+1, 0);
    const startWeekDay = (first.getDay()+6)%7;
    const totalCells = startWeekDay + last.getDate();
    const weeks = Math.ceil(totalCells / 7);
    const cells = Math.max(42, weeks*7);

    grid.innerHTML = '';
    if(animateDir === 'left') grid.classList.add('grid-animate-left');
    if(animateDir === 'right') grid.classList.add('grid-animate-right');
    setTimeout(()=> grid.classList.remove('grid-animate-left','grid-animate-right'), 210);

    for(let i=0; i<cells; i++){
      const cell = document.createElement('div');
      cell.className = 'calendar-cell relative bg-white p-2';

      const dayNum = i - startWeekDay + 1;
      if(dayNum < 1 || dayNum > last.getDate()){
        cell.classList.add('bg-gray-50');
        grid.appendChild(cell);
        continue;
      }

      const dateStr = toLocalDateStr(state.y, state.m, dayNum);
      const dateObj = new Date(state.y, state.m, dayNum);
      const isToday = isSameDate(dateObj, new Date());

      // Header
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between mb-2';
      const dn = document.createElement('button');
      dn.className = 'day-badge inline-flex items-center justify-center w-9 h-9 text-sm font-semibold rounded-full transition ' + (isToday ? 'bg-emerald-600 text-white' : 'bg-black/5 text-gray-700');
      dn.textContent = dayNum;
      dn.title = '–û—Ç–∫—Ä—ã—Ç—å –≤—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–Ω—è';
      dn.addEventListener('click', ()=> openDayModal(dateStr));
      header.appendChild(dn);

      const moreBtnTop = document.createElement('button');
      moreBtnTop.className = 'text-[11px] text-emerald-700 hover:underline';
      moreBtnTop.textContent = '–≤—Å–µ';
      moreBtnTop.title = '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —ç—Ç–æ–≥–æ –¥–Ω—è';
      moreBtnTop.addEventListener('click', ()=> openDayModal(dateStr));
      header.appendChild(moreBtnTop);

      cell.appendChild(header);

      // List (—Ç–æ–ª—å–∫–æ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–µ–≤—å—é)
      const list = document.createElement('div');
      list.className = 'space-y-1 max-h-60 overflow-auto pr-1';
      const items = byDate[dateStr] || [];

      if(items.length === 0){
        const empty = document.createElement('div');
        empty.className = 'text-[11px] text-gray-400 select-none';
        empty.textContent = '–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫';
        list.appendChild(empty);
      }

      let rendered = 0;
      for(const t of items){
        if(rendered >= MAX_VISIBLE_IN_CELL) break;
        rendered++;

        const past = !!t.is_past;

        const wrap = document.createElement('div');
        wrap.className = 'pill group rounded-xl border flex flex-col gap-1 px-2 py-1 text-xs ' +
          (t.joined ? 'bg-emerald-50 border-emerald-200' : 'bg-gray-50 border-gray-200');
        if(past) wrap.classList.add('disabled');

        // —Å—Ç—Ä–æ–∫–∞ 1: –≤—Ä–µ–º—è + —Ç—Ä–µ–Ω–µ—Ä
        const row1 = document.createElement('div');
        row1.className = 'flex items-center justify-between gap-2';
        row1.innerHTML = `<span class="font-medium">${t.start_time}‚Äì${t.end_time}</span>
                          <span class="truncate text-gray-700">${t.trainer_name}</span>`;
        wrap.appendChild(row1);

        // —Å—Ç—Ä–æ–∫–∞ 2: –Ω–∞–∑–≤–∞–Ω–∏–µ
        const rowTitle = document.createElement('div');
        rowTitle.className = 'truncate text-gray-600';
        rowTitle.textContent = t.title || '–û–Ω–ª–∞–π–Ω-—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
        wrap.appendChild(rowTitle);

        // —Å—Ç—Ä–æ–∫–∞ 3: –æ–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
        const rowActions = document.createElement('div');
        rowActions.className = 'flex items-center justify-end';

        const btn = document.createElement('button');
        btn.className = 'px-2 py-1 rounded-lg border transition ' +
          (t.joined ? 'border-rose-300 text-rose-600 hover:bg-rose-50' : 'border-emerald-300 text-emerald-700 hover:bg-emerald-50');

        if(past){
          btn.disabled = true;
          btn.textContent = '–ø—Ä–æ—à–ª–æ';
        } else if(t.joined){
          btn.textContent = '–û—Ç–º–µ–Ω–∏—Ç—å';
          btn.addEventListener('click', async ()=>{
            if(!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
            const r = await fetch(`/api/trainings/${t.id}/signup`, { method:'DELETE' });
            const ok = r.ok; const j = await r.json().catch(()=>({}));
            if(ok){ notify('–ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞'); await loadAll(); } else { notify(j?.message||'–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã', false); }
          });
        } else {
          if((t.spots_left||0) === 0){
            btn.disabled = true;
            btn.textContent = '–ù–µ—Ç –º–µ—Å—Ç';
          } else {
            btn.textContent = '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è';
            btn.addEventListener('click', async ()=>{
              const r = await fetch(`/api/trainings/${t.id}/signup`, { method:'POST' });
              const ok = r.ok; const j = await r.json().catch(()=>({}));
              if(ok){ notify('–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã'); await loadAll(); } else { notify(j?.message||'–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è', false); }
            });
          }
        }

        rowActions.appendChild(btn);
        wrap.appendChild(rowActions);

        list.appendChild(wrap);
      }

      // ¬´–µ—â—ë N¬ª
      if(items.length > MAX_VISIBLE_IN_CELL){
        const more = document.createElement('button');
        more.className = 'w-full mt-1 px-2 py-1 text-[11px] rounded-lg border border-emerald-300 text-emerald-700 hover:bg-emerald-50';
        more.textContent = `–µ—â—ë ${items.length - MAX_VISIBLE_IN_CELL}‚Ä¶`;
        more.addEventListener('click', ()=> openDayModal(dateStr));
        list.appendChild(more);
      }

      cell.appendChild(list);
      grid.appendChild(cell);
    }
  }

  // ---- Day Modal ----
  function openDayModal(dateStr){
    const list = filteredData().filter(t => t.date === dateStr)
                               .sort((a,b)=> a.start_time.localeCompare(b.start_time));
    const [y,m,d] = dateStr.split('-');
    dayModalDate.textContent = `${d}.${m}.${y}`;
    dayModalCount.textContent = list.length ? `–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: ${list.length}` : '–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫';

    dayModalBody.innerHTML = '';
    if(list.length === 0){
      dayModalBody.innerHTML = '<div class="text-gray-500">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—É—Å—Ç–æ</div>';
    } else {
      for(const t of list){
        const past = !!t.is_past;
        const host = (()=>{ try{ return new URL(t.meeting_link).hostname; }catch(_e){ return ''; }})();

        const item = document.createElement('div');
        item.className = 'rounded-2xl border p-3 flex flex-col gap-2 ' +
          (t.joined ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-gray-200');

        item.innerHTML = `
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="text-sm font-semibold">${t.start_time}‚Äì${t.end_time}</div>
            <div class="text-xs text-gray-500">ID: <button class="copy-id underline underline-offset-2" data-id="${t.id}">${t.id}</button></div>
          </div>
          <div class="text-sm text-gray-700">${t.title || '–û–Ω–ª–∞–π–Ω-—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'} ‚Äî ${t.trainer_name}</div>
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="badge bg-white border border-gray-200 text-gray-700">
                ${(t.spots_left||0)>0 ? '–º–µ—Å—Ç: '+t.spots_left : '–Ω–µ—Ç –º–µ—Å—Ç'}
              </span>
              ${t.can_open_link && t.meeting_link
                ? `<a href="${t.meeting_link}" target="_blank" rel="noopener" class="badge bg-emerald-600 text-white hover:opacity-90">
                     <i class="bi bi-box-arrow-up-right"></i> ${host||'–ø–µ—Ä–µ–π—Ç–∏'}
                   </a>`
                : `<span class="badge bg-gray-200 text-gray-700">
                     <i class="bi bi-lock"></i> –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ ${(t.link_visible_at||'').slice(11,16) || '—Å–∫–æ—Ä–æ'}
                   </span>`
              }
            </div>
            <div>
              ${past
                ? `<button class="px-2 py-1 rounded-lg border text-gray-400 cursor-not-allowed">–ø—Ä–æ—à–ª–æ</button>`
                : t.joined
                  ? `<button class="btn-cancel px-2 py-1 rounded-lg border border-rose-300 text-rose-600 hover:bg-rose-50" data-id="${t.id}">–û—Ç–º–µ–Ω–∏—Ç—å</button>`
                  : ((t.spots_left||0)===0
                      ? `<button class="px-2 py-1 rounded-lg border text-gray-400 cursor-not-allowed">–ù–µ—Ç –º–µ—Å—Ç</button>`
                      : `<button class="btn-join px-2 py-1 rounded-lg border border-emerald-300 text-emerald-700 hover:bg-emerald-50" data-id="${t.id}">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>`)}
            </div>
          </div>
        `;

        dayModalBody.appendChild(item);
      }
    }

    // –¥–µ–π—Å—Ç–≤–∏—è –≤ –º–æ–¥–∞–ª–∫–µ
    dayModalBody.querySelectorAll('.copy-id').forEach(b=>{
      b.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(b.dataset.id); notify('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); }catch(_e){} });
    });
    dayModalBody.querySelectorAll('.btn-join').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.dataset.id;
        const r = await fetch(`/api/trainings/${id}/signup`, { method:'POST' });
        const ok = r.ok; const j = await r.json().catch(()=>({}));
        if(ok){ notify('–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã'); await loadAll(); openDayModal(dateStr); } else { notify(j?.message||'–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è', false); }
      });
    });
    dayModalBody.querySelectorAll('.btn-cancel').forEach(b=>{
      b.addEventListener('click', async ()=>{
        if(!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
        const id = b.dataset.id;
        const r = await fetch(`/api/trainings/${id}/signup`, { method:'DELETE' });
        const ok = r.ok; const j = await r.json().catch(()=>({}));
        if(ok){ notify('–ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞'); await loadAll(); openDayModal(dateStr); } else { notify(j?.message||'–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã', false); }
      });
    });

    showModal(dayModal, true);
  }

  // ---- My Modal ----
  function openMyModal(){
    const joined = state.data.filter(t => t.joined)
      .sort((a,b)=> (`${a.date} ${a.start_time}`).localeCompare(`${b.date} ${b.start_time}`));
    if(joined.length === 0){
      myModalBody.innerHTML = `
        <div class="p-10 text-center text-gray-500">
          <div class="text-3xl mb-2">üóìÔ∏è</div>
          <div class="font-medium">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>
          <div class="text-sm">–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ.</div>
        </div>`;
    } else {
      myModalBody.innerHTML = joined.map(t=>{
        const host = (()=>{ try{ return new URL(t.meeting_link).hostname; }catch(_e){ return ''; }})();
        const linkHtml = t.can_open_link && t.meeting_link
          ? `<a href="${t.meeting_link}" target="_blank" rel="noopener" class="text-xs text-emerald-600 hover:underline">${host||'–ø–µ—Ä–µ–π—Ç–∏'}</a>`
          : `<span class="text-xs text-gray-500">–°—Å—ã–ª–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –≤ ${(t.link_visible_at||'').slice(11,16) || '–±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è'}</span>`;
        const btnHtml = t.is_past
          ? `<button disabled class="px-2 py-1 rounded-lg border text-gray-400">–ø—Ä–æ—à–ª–æ</button>`
          : `<button data-cancel="${t.id}" class="px-2 py-1 rounded-lg border border-rose-300 text-rose-600 hover:bg-rose-50">–û—Ç–º–µ–Ω–∏—Ç—å</button>`;
        return `
          <div class="p-4 border-b flex items-start gap-3">
            <div class="shrink-0 mt-0.5 text-emerald-600"><i class="bi bi-broadcast-pin"></i></div>
            <div class="flex-1 min-w-0">
              <div class="text-sm font-semibold">${t.date} ¬∑ ${t.start_time}‚Äì${t.end_time}</div>
              <div class="text-xs text-gray-500">ID: <button class="copy-id underline underline-offset-2" data-id="${t.id}">${t.id}</button></div>
              <div class="text-sm text-gray-700 truncate">${t.title || '–û–Ω–ª–∞–π–Ω-—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'} ‚Äî ${t.trainer_name}</div>
              <div class="flex items-center justify-between mt-1">
                ${linkHtml}
                ${btnHtml}
              </div>
            </div>
          </div>`;
      }).join('');
      myModalBody.querySelectorAll('[data-cancel]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          if(!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
          const id = btn.getAttribute('data-cancel');
          const r = await fetch(`/api/trainings/${id}/signup`, { method:'DELETE' });
          const ok = r.ok; const j = await r.json().catch(()=>({}));
          if(ok){ notify('–ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞'); await loadAll(); openMyModal(); } else { notify(j?.message||'–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã', false); }
        });
      });
      myModalBody.querySelectorAll('.copy-id').forEach(b=>{
        b.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(b.dataset.id); notify('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); }catch(_e){} });
      });
    }
    showModal(myModal, true);
  }

  // ---- Modals helpers ----
  function showModal(node, yes){
    if(yes){ node.classList.add('show'); }
    else { node.classList.remove('show'); }
  }
  function closeModals(){ showModal(dayModal,false); showModal(myModal,false); }

  dayModalClose.addEventListener('click', ()=> showModal(dayModal,false));
  myModalClose.addEventListener('click', ()=> showModal(myModal,false));
  dayModal.addEventListener('click', e=>{ if(e.target === dayModal) showModal(dayModal,false); });
  myModal.addEventListener('click', e=>{ if(e.target === myModal) showModal(myModal,false); });
  document.addEventListener('keydown', e=>{ if(e.key === 'Escape') closeModals(); });

  // ---- Loaders ----
  async function loadMonth(animate){
    const r = await fetch(`/api/trainings?month=${yyyymm(state.y, state.m)}`);
    const j = await r.json().catch(()=>({}));
    state.data = Array.isArray(j?.data) ? j.data : [];
    renderGrid(animate);
  }
  async function loadAll(){ await loadMonth(); }

  // ---- Events ----
  btnPrev.addEventListener('click', async ()=>{ if(state.m===0){ state.m=11; state.y--; } else state.m--; saveMonth(); await loadMonth('right'); });
  btnNext.addEventListener('click', async ()=>{ if(state.m===11){ state.m=0; state.y++; } else state.m++; saveMonth(); await loadMonth('left'); });
  btnToday.addEventListener('click', async ()=>{ const d=new Date(); state.y=d.getFullYear(); state.m=d.getMonth(); saveMonth(); await loadMonth(); });

  monthSelect.addEventListener('change', async (e)=>{ state.m = parseInt(e.target.value,10); saveMonth(); await loadMonth(); });
  yearInput.addEventListener('change', async (e)=>{ state.y = clampYear(e.target.value); saveMonth(); await loadMonth(); });

  document.addEventListener('keydown', (e)=>{
    if(e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
    if(e.key==='ArrowLeft'){ e.preventDefault(); btnPrev.click(); }
    if(e.key==='ArrowRight'){ e.preventDefault(); btnNext.click(); }
    if(e.key.toLowerCase()==='t'){ e.preventDefault(); btnToday.click(); }
  });

  searchInput.addEventListener('input', ()=>{ state.search = searchInput.value; renderGrid(); });
  onlyJoined.addEventListener('change', ()=>{ state.onlyJoined = !!onlyJoined.checked; renderGrid(); });
  btnMy.addEventListener('click', openMyModal);

  // init
  (async ()=>{ await loadAll(); })();
})();
</script>
{% endblock %}
