{% extends 'base.html' %}
{% block content %}

<script>
  window.__pendingUsers = [
    {% for u in users %}
    {
      id: {{ u.id }},
      name: {{ u.name|tojson }},
      email: {{ u.email|tojson }},
      pref_time: {{ (u.squad_pref_time or '')|tojson }},
      fitness_level: {{ (u.squad_fitness_level or '')|tojson }},
      date: "{{ u.updated_at.strftime('%Y-%m-%d') }}",
      display_date: "{{ u.updated_at.strftime('%d.%m %H:%M') }}"
    }{{ '' if loop.last else ',' }}
    {% endfor %}
  ];

  window.__groups = [
    {% for g in groups %}
    {
      id: {{ g.id }},
      name: {{ g.name|tojson }},
      count: {{ g.count }},
      trainer: {{ g.trainer_name|tojson }}
    }{{ '' if loop.last else ',' }}
    {% endfor %}
  ];
</script>

<div class="max-w-7xl mx-auto px-4 py-6" x-data="squadDistribution()">

  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
    <div class="flex items-center gap-4">
      <a href="{{ url_for('admin_dashboard') }}" class="p-2 rounded-full hover:bg-gray-200 transition text-gray-500">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
      </a>
      <div>
        <h1 class="text-3xl font-bold text-gray-900">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ Squads</h1>
        <p class="text-sm text-gray-500 mt-1">
          –ó–∞—è–≤–æ–∫ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏: <span class="font-bold text-orange-600" x-text="users.length"></span>
        </p>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">

    <div class="xl:col-span-3 space-y-6">

      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row gap-4 items-end md:items-center">
        <div class="flex-1 w-full">
          <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">–ü–æ–∏—Å–∫</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </span>
            <input type="text" x-model="search" placeholder="–ò–º—è –∏–ª–∏ Email..."
                   class="pl-10 block w-full rounded-lg border-gray-300 bg-gray-50 border focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm py-2">
          </div>
        </div>

        <div class="w-full md:w-48">
          <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏</label>
          <select x-model="filterTime" class="block w-full rounded-lg border-gray-300 bg-gray-50 border focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm py-2 px-3">
            <option value="">–í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</option>
            <option value="morning">üåÖ –£—Ç—Ä–æ</option>
            <option value="day">‚òÄÔ∏è –î–µ–Ω—å</option>
            <option value="evening">üåô –í–µ—á–µ—Ä</option>
          </select>
        </div>

        <div class="w-full md:w-48">
          <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">–£—Ä–æ–≤–µ–Ω—å</label>
          <select x-model="filterLevel" class="block w-full rounded-lg border-gray-300 bg-gray-50 border focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm py-2 px-3">
            <option value="">–õ—é–±–æ–π —É—Ä–æ–≤–µ–Ω—å</option>
            <option value="newbie">üü¢ –ù–æ–≤–∏—á–æ–∫</option>
            <option value="pro">üî¥ –û–ø—ã—Ç–Ω—ã–π</option>
          </select>
        </div>

        <button @click="resetFilters" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-sm font-medium transition">
          –°–±—Ä–æ—Å
        </button>
      </div>

      <div class="space-y-4">
        <template x-if="filteredUsers.length === 0">
          <div class="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
            <p class="text-gray-500 text-lg">–ó–∞—è–≤–æ–∫ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ü§∑‚Äç‚ôÇÔ∏è</p>
          </div>
        </template>

        <template x-for="user in filteredUsers" :key="user.id">
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 hover:shadow-md transition duration-200 flex flex-col sm:flex-row gap-5 items-start sm:items-center justify-between">

            <div class="flex items-start gap-4 flex-1">
              <div class="h-12 w-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl shrink-0">
                <span x-text="user.name.charAt(0).toUpperCase()"></span>
              </div>
              <div>
                <div class="flex items-center gap-2 flex-wrap">
                  <h3 class="text-lg font-bold text-gray-900 leading-tight" x-text="user.name"></h3>
                  <span class="text-xs text-gray-400 font-mono" x-text="'#' + user.id"></span>
                </div>
                <p class="text-sm text-gray-500" x-text="user.email"></p>
                <p class="text-xs text-gray-400 mt-1">–ó–∞—è–≤–∫–∞ –æ—Ç: <span x-text="user.display_date"></span></p>

                <div class="flex flex-wrap gap-2 mt-3">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium border"
                    :class="{
                      'bg-orange-50 text-orange-700 border-orange-200': user.pref_time === 'morning',
                      'bg-sky-50 text-sky-700 border-sky-200': user.pref_time === 'day',
                      'bg-indigo-50 text-indigo-700 border-indigo-200': user.pref_time === 'evening',
                      'bg-gray-100 text-gray-600 border-gray-200': !user.pref_time
                    }">
                    <template x-if="user.pref_time === 'morning'"><span>üåÖ –£—Ç—Ä–æ (07-10)</span></template>
                    <template x-if="user.pref_time === 'day'"><span>‚òÄÔ∏è –î–µ–Ω—å (12-16)</span></template>
                    <template x-if="user.pref_time === 'evening'"><span>üåô –í–µ—á–µ—Ä (18-21)</span></template>
                    <template x-if="!user.pref_time"><span>–í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ</span></template>
                  </span>

                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium border"
                    :class="{
                      'bg-green-50 text-green-700 border-green-200': user.fitness_level === 'newbie',
                      'bg-rose-50 text-rose-700 border-rose-200': user.fitness_level === 'pro',
                      'bg-gray-100 text-gray-600 border-gray-200': !user.fitness_level
                    }">
                    <template x-if="user.fitness_level === 'newbie'"><span>üü¢ –ù–æ–≤–∏—á–æ–∫</span></template>
                    <template x-if="user.fitness_level === 'pro'"><span>üî¥ –ü—Ä–æ—Ñ–∏</span></template>
                    <template x-if="!user.fitness_level"><span>–û–ø—ã—Ç –Ω–µ —É–∫–∞–∑–∞–Ω</span></template>
                  </span>
                </div>
              </div>
            </div>

            <form action="{{ url_for('admin_assign_squad') }}" method="POST"
                  class="w-full sm:w-auto bg-gray-50 p-3 rounded-lg border border-gray-200 flex flex-col gap-2">
              <input type="hidden" name="user_id" :value="user.id">

              <label class="text-xs font-semibold text-gray-500 uppercase">–ù–∞–∑–Ω–∞—á–∏—Ç—å –≤ –æ—Ç—Ä—è–¥:</label>

              <div class="flex gap-2">
                <select name="group_id" required class="block w-full sm:w-48 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm py-2 px-3">
                  <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                  <template x-for="g in groups" :key="g.id">
                    <option :value="g.id" x-text="`${g.name} (${g.count} —á–µ–ª.)`"></option>
                  </template>
                </select>

                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-md px-3 py-2 transition shadow-sm">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                  </svg>
                </button>
              </div>
            </form>

          </div>
        </template>
      </div>
    </div>

    <div class="xl:col-span-1">
      <div class="sticky top-6 space-y-6">

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-gray-900">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—Ä—è–¥–æ–≤</h2>
            <a href="{{ url_for('admin_groups_list') }}" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ &rarr;</a>
          </div>

          <div class="space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto pr-2 custom-scrollbar">
            <template x-for="g in groups" :key="g.id">
              <div class="group border border-gray-100 rounded-lg p-3 hover:border-indigo-200 hover:bg-indigo-50/30 transition">
                <div class="flex justify-between items-start mb-2">
                  <div>
                    <h4 class="font-bold text-gray-800 text-sm" x-text="g.name"></h4>
                    <p class="text-xs text-gray-500 mt-0.5" x-text="'–¢—Ä–µ–Ω–µ—Ä: ' + g.trainer"></p>
                  </div>
                  <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded" x-text="g.count"></span>
                </div>

                <div class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                  <div class="h-1.5 rounded-full transition-all duration-500"
                       :class="{
                         'bg-green-500': g.count < 10,
                         'bg-yellow-500': g.count >= 10 && g.count < 15,
                         'bg-red-500': g.count >= 15
                       }"
                       :style="`width: ${Math.min((g.count / 15) * 100, 100)}%`"></div>
                </div>
                <div class="flex justify-between mt-1">
                  <span class="text-[10px] text-gray-400">0</span>
                  <span class="text-[10px] text-gray-400">15 –º–µ—Å—Ç</span>
                </div>
              </div>
            </template>

            <template x-if="groups.length === 0">
              <p class="text-sm text-gray-500 text-center py-4">–ì—Ä—É–ø–ø –ø–æ–∫–∞ –Ω–µ—Ç</p>
            </template>
          </div>
        </div>

        <div class="bg-blue-50 border border-blue-100 rounded-xl p-4">
          <div class="flex gap-3">
            <div class="shrink-0 text-blue-500">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
              </svg>
            </div>
            <div>
              <h4 class="text-sm font-bold text-blue-800">–ö–∞–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å?</h4>
              <p class="text-xs text-blue-700 mt-1 leading-relaxed">
                –°—Ç–∞—Ä–∞–π—Ç–µ—Å—å –æ–±—ä–µ–¥–∏–Ω—è—Ç—å –ª—é–¥–µ–π —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º —É—Ä–æ–≤–Ω–µ–º –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏ –≤—Ä–µ–º–µ–Ω–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. –≠—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å –∏ —Å–Ω–∏–∂–∞–µ—Ç –æ—Ç—Ç–æ–∫.
              </p>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<script>
function squadDistribution() {
  return {
    users: window.__pendingUsers || [],
    groups: window.__groups || [],
    search: '',
    filterTime: '',
    filterLevel: '',

    get filteredUsers() {
      return this.users.filter(u => {
        // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É (–ò–º—è –∏–ª–∏ Email)
        const s = this.search.toLowerCase();
        const matchesSearch = !s || u.name.toLowerCase().includes(s) || u.email.toLowerCase().includes(s);

        // –§–∏–ª—å—Ç—Ä –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        const matchesTime = !this.filterTime || u.pref_time === this.filterTime;

        // –§–∏–ª—å—Ç—Ä –ø–æ —É—Ä–æ–≤–Ω—é
        const matchesLevel = !this.filterLevel || u.fitness_level === this.filterLevel;

        return matchesSearch && matchesTime && matchesLevel;
      });
    },

    resetFilters() {
      this.search = '';
      this.filterTime = '';
      this.filterLevel = '';
    }
  }
}
</script>

<style>
  /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø */
  .custom-scrollbar::-webkit-scrollbar {
    width: 4px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 4px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
  }
</style>

{% endblock %}