{% extends 'base.html' %}
{% block content %}

<style>
  .flip-card { perspective: 1200px; transition: transform .4s ease; }
  .flip-card:hover { transform: scale(1.03); }
  .flip-inner { transition: transform 1s ease; transform-style: preserve-3d; position: relative; width: 100%; height: 100%; }
  .flipped .flip-inner { transform: rotateY(180deg); }
  .flip-front, .flip-back {
    backface-visibility: hidden; position: absolute; inset: 0;
    padding: 1.5rem; border-radius: 1.25rem; box-shadow: 0 12px 25px rgba(0,0,0,.2);
    display: flex; flex-direction: column; justify-content: space-between;
  }
  .flip-back { transform: rotateY(180deg); overflow-y: auto; }
  .click-arrow { position: absolute; bottom: 1rem; right: 1rem; font-size: 1.4rem; transform: rotate(-45deg); transition: .3s ease; color: rgba(255,255,255,.5); }
  .flip-card:hover .click-arrow { transform: rotate(-45deg) translate(5px,-5px) scale(1.2); color:#fff; }
  .flip-back .click-arrow { color:#444; }
  .flip-card:hover .flip-back .click-arrow { color:#000; }
  /* mini skeleton */
  .skeleton { position: relative; overflow: hidden; background: #eef2f7; border-radius: .5rem; }
  .skeleton::after { content:""; position:absolute; inset:0; transform: translateX(-100%);
    background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.6), rgba(255,255,255,0));
    animation: shimmer 1.2s infinite; }
  @keyframes shimmer { 100% { transform: translateX(100%); } }
</style>

<div class="container mx-auto px-4 py-10">
  <h1 class="text-4xl font-extrabold text-center mb-14 text-black tracking-wide">üç± –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –î–∏–µ—Ç–∞</h1>

  {% set meals = {
    '–ó–∞–≤—Ç—Ä–∞–∫': {'items': breakfast, 'color': 'bg-gradient-to-br from-amber-300 to-amber-500'},
    '–û–±–µ–¥': {'items': lunch, 'color': 'bg-gradient-to-br from-orange-300 to-orange-500'},
    '–£–∂–∏–Ω': {'items': dinner, 'color': 'bg-gradient-to-br from-purple-300 to-purple-500'}
  } %}

  <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
    {% for meal_name, meal in meals.items() %}
      <div class="flip-card h-[420px] cursor-pointer w-[90%] mx-auto" onclick="this.classList.toggle('flipped')">
        <div class="flip-inner rounded-2xl">
          <!-- FRONT -->
          <div class="flip-front {{ meal.color }} text-gray-900 relative overflow-hidden">
            <div>
              <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold mb-5 tracking-wide">{{ meal_name }}</h2>
                <span class="text-xs opacity-70">{{ (meal['items']|length) }} –±–ª—é–¥(–∞)</span>
              </div>
              <ul class="space-y-3 text-sm leading-relaxed">
                {% for food in meal['items'] %}
                  <li class="bg-white bg-opacity-40 rounded-lg px-3 py-2 shadow-sm">
                    <p class="font-semibold">{{ food.name }}</p>
                    <div class="flex flex-wrap gap-2 mt-1">
                      <span class="inline-block bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">{{ food.kcal }} –∫–∫–∞–ª</span>
                      <span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">{{ food.grams }} –≥</span>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            </div>
            <div class="click-arrow">‚ûú</div>
          </div>
          <!-- BACK -->
          <div class="flip-back bg-white text-gray-800">
            <div>
              <h3 class="text-2xl font-bold mb-4">{{ meal_name }} ‚Äî –†–µ—Ü–µ–ø—Ç—ã</h3>
              <div class="space-y-4 text-sm leading-relaxed max-h-60 overflow-y-auto pr-2">
                {% for food in meal['items'] %}
                  <div>
                    <p class="font-semibold">{{ food.name }}</p>
                    <p class="whitespace-pre-line text-gray-600">{{ food.recipe }}</p>
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="click-arrow">‚ûú</div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- –ü–µ—Ä–µ–∫—É—Å -->
  {% if snack|default([]) %}
    <div class="flex justify-center mt-12">
      <div class="flip-card h-[420px] cursor-pointer w-[90%] md:w-1/3" onclick="this.classList.toggle('flipped')">
        <div class="flip-inner rounded-2xl">
          <!-- FRONT -->
          <div class="flip-front bg-gradient-to-br from-lime-200 to-lime-400 text-gray-900 relative overflow-hidden">
            <div class="flex items-center justify-between">
              <h2 class="text-2xl font-bold mb-5 tracking-wide">–ü–µ—Ä–µ–∫—É—Å</h2>
              <span class="text-xs opacity-70">{{ (snack|default([]))|length }} –±–ª—é–¥(–∞)</span>
            </div>
            <ul class="space-y-3 text-sm leading-relaxed">
              {% for food in (snack|default([])) %}
                <li class="bg-white bg-opacity-40 rounded-lg px-3 py-2 shadow-sm">
                  <p class="font-semibold">{{ food.name }}</p>
                  <div class="flex flex-wrap gap-2 mt-1">
                    <span class="inline-block bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">{{ food.kcal }} –∫–∫–∞–ª</span>
                    <span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">{{ food.grams }} –≥</span>
                  </div>
                </li>
              {% endfor %}
            </ul>
            <div class="click-arrow">‚ûú</div>
          </div>
          <!-- BACK -->
          <div class="flip-back bg-white text-gray-800">
            <div>
              <h3 class="text-2xl font-bold mb-4">–ü–µ—Ä–µ–∫—É—Å ‚Äî –†–µ—Ü–µ–ø—Ç—ã</h3>
              <div class="space-y-4 text-sm leading-relaxed max-h-60 overflow-y-auto pr-2">
                {% for food in (snack|default([])) %}
                  <div>
                    <p class="font-semibold">{{ food.name }}</p>
                    <p class="whitespace-pre-line text-gray-600">{{ food.recipe }}</p>
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="click-arrow">‚ûú</div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- –ò—Ç–æ–≥–∏ -->
  <div class="mt-16 bg-white p-6 rounded-xl text-center shadow-xl">
    <h2 class="text-2xl font-bold mb-4">–°—É—Ç–æ—á–Ω—ã–π –∏—Ç–æ–≥</h2>
    <div class="flex flex-wrap justify-center gap-8 text-lg font-medium text-gray-700">
      <div><p class="text-gray-500">–ö–∞–ª–æ—Ä–∏–∏</p><p class="text-2xl text-green-600 font-bold">{{ diet.total_kcal }} –∫–∫–∞–ª</p></div>
      <div><p class="text-gray-500">–ë–µ–ª–∫–∏</p><p class="text-2xl text-blue-600 font-bold">{{ diet.protein }} –≥</p></div>
      <div><p class="text-gray-500">–ñ–∏—Ä—ã</p><p class="text-2xl text-yellow-600 font-bold">{{ diet.fat }} –≥</p></div>
      <div><p class="text-gray-500">–£–≥–ª–µ–≤–æ–¥—ã</p><p class="text-2xl text-pink-600 font-bold">{{ diet.carbs }} –≥</p></div>
    </div>
  </div>

  <!-- üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ -->
  <div id="cartSection" class="mt-10 bg-white rounded-xl shadow-xl p-6">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <h2 class="text-xl font-bold text-slate-900">üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø–æ —ç—Ç–æ–π –¥–∏–µ—Ç–µ</h2>
        <span id="cartStatus" class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-700">–°—Ç–∞—Ç—É—Å: ‚Äî</span>
      </div>
      <div class="flex gap-2">
        <button id="buildCartBtn" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
        <button id="resetCartBtn" class="btn btn-outline hidden">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
    </div>

    <div id="cartHint" class="mt-2 text-sm text-slate-500">
      –°—Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ Kaspi, —á—Ç–æ–±—ã –∫—É–ø–∏—Ç—å –≤—Å—ë –∑–∞ –ø–∞—Ä—É –∫–ª–∏–∫–æ–≤.
    </div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å/—Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="cartFlash" class="mt-4 text-sm"></div>

    <div id="cartContent" class="mt-5 space-y-6">
      <!-- —Å—é–¥–∞ —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è –±–ª–æ–∫–∏ -->
    </div>
  </div>
</div>

<script>
(function(){
  const dietId = {{ diet.id }};
  const $status = document.getElementById('cartStatus');
  const $btnBuild = document.getElementById('buildCartBtn');
  const $btnReset = document.getElementById('resetCartBtn');
  const $flash = document.getElementById('cartFlash');
  const $content = document.getElementById('cartContent');

  function setStatus(text, tone){
    $status.textContent = '–°—Ç–∞—Ç—É—Å: ' + text;
    $status.className = 'text-xs px-2 py-1 rounded-full ' + (tone === 'ok'
      ? 'bg-green-100 text-green-700'
      : tone === 'warn' ? 'bg-yellow-100 text-yellow-700'
      : 'bg-slate-100 text-slate-700');
  }

  function showFlash(msg, kind='info'){
    const classes = {
      info: 'text-slate-700',
      ok: 'text-green-700',
      err: 'text-red-700',
      warn: 'text-yellow-700'
    };
    $flash.className = 'mt-4 text-sm ' + (classes[kind]||classes.info);
    $flash.textContent = msg || '';
  }

  function toggleButtons(hasCart){
    if(hasCart){
      $btnBuild.classList.add('hidden');
      $btnReset.classList.remove('hidden');
    }else{
      $btnBuild.classList.remove('hidden');
      $btnReset.classList.add('hidden');
    }
  }

  function skeleton(){
    $content.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="skeleton h-24"></div>
        <div class="skeleton h-24"></div>
        <div class="skeleton h-24"></div>
        <div class="skeleton h-24"></div>
      </div>
    `;
  }

  function groupItemsFlat(items){
    const out = {breakfast:[],lunch:[],dinner:[],snack:[]};
    (items||[]).forEach(it=>{
      const k = (it.meal_type || 'other').toLowerCase();
      (out[k] || (out[k]=[])).push(it);
    });
    return out;
  }

  function render(itemsByMeal){
    const order = [
      ['breakfast','üç≥ –ó–∞–≤—Ç—Ä–∞–∫'],
      ['lunch','üç≤ –û–±–µ–¥'],
      ['dinner','üçù –£–∂–∏–Ω'],
      ['snack','üçé –ü–µ—Ä–µ–∫—É—Å'],
    ];
    let totalCount = 0;
    let html = '';
    order.forEach(([key, title])=>{
      const items = (itemsByMeal && itemsByMeal[key]) || [];
      totalCount += items.length;

      const cards = items.map(it=>{
        const name = it.product_name || it.item_name || it.name || '';
        const qty = (it.quantity_packs ?? it.qty ?? 1);
        const unit = it.unit || '—à—Ç';
        const totalGr = it.total_grams || it.total_g || null;
        const packGr = it.pack_grams || it.pack_g || null;
        const price = it.price ? String(it.price) : null;
        const kaspiUrl = (it.kaspi_url && it.kaspi_url.trim()) || null;
        const kaspiQuery = (it.kaspi_query && it.kaspi_query.trim()) || (name ? name.trim() : '');
        const link = kaspiUrl || (kaspiQuery ? ('https://kaspi.kz/shop/search/?text=' + encodeURIComponent(kaspiQuery)) : null);

        return `
          <div class="p-4 rounded-lg border border-slate-200 bg-slate-50">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-semibold text-slate-900">${name || '–¢–æ–≤–∞—Ä'}</div>
                <div class="text-xs text-slate-500 mt-1">
                  ${ totalGr ? `–ù—É–∂–Ω–æ: <b>${totalGr}</b> –≥ ¬∑ ` : '' }
                  ${ packGr ? `–§–∞—Å–æ–≤–∫–∞: <b>${packGr}</b> –≥ ¬∑ ` : '' }
                  –ö–æ–ª-–≤–æ: <b>${qty}</b> ${unit}
                  ${ price ? ` ¬∑ ‚âà <b>${price}</b> ‚Ç∏` : '' }
                </div>
              </div>
              ${ link ? `<a href="${link}" target="_blank" rel="noopener" class="text-sm text-blue-600 hover:underline shrink-0">–û—Ç–∫—Ä—ã—Ç—å</a>` : '' }
            </div>
          </div>
        `;
      }).join('');

      html += `
        <div>
          <div class="text-sm font-semibold text-slate-700 mb-2">${title}</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3">
            ${cards || ''}
            ${items.length ? '' : '<div class="text-slate-400 text-xs">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</div>'}
          </div>
        </div>
      `;
    });

    $content.innerHTML = html;
    toggleButtons(totalCount > 0);
    setStatus(totalCount > 0 ? '–≥–æ—Ç–æ–≤–æ' : '–Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å', totalCount > 0 ? 'ok' : 'warn');
    showFlash(totalCount > 0 ? '–ö–æ—Ä–∑–∏–Ω–∞ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞. –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –≤ Kaspi.' : '–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–∫–∞ –ø—É—Å—Ç–∞—è. –ù–∞–∂–º–∏ ¬´–°–æ–∑–¥–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É¬ª.',
      totalCount > 0 ? 'ok' : 'info');
  }

  async function loadCart(){
    try{
      skeleton();
      const r = await fetch(`/shopping/list?diet_id=${dietId}`, {cache:'no-store'});
      const j = await r.json();
      if(!r.ok || j.ok === false){
        setStatus('–æ—à–∏–±–∫–∞', 'err');
        toggleButtons(false);
        showFlash(j.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É', 'err');
        $content.innerHTML = '';
        return;
      }
      const byMeal = j.items_by_meal || groupItemsFlat(j.items || []);
      render(byMeal);
    }catch(e){
      setStatus('–æ—à–∏–±–∫–∞', 'err');
      toggleButtons(false);
      showFlash('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã', 'err');
      $content.innerHTML = '';
    }
  }

  async function buildCart(){
    try{
      $btnBuild.disabled = true;
      skeleton();
      setStatus('—Å–æ–±–∏—Ä–∞–µ–º‚Ä¶', 'warn');
      showFlash('–§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å GPT –∏ Kaspi‚Ä¶', 'info');
      const r = await fetch('/shopping/build', {
        method: 'POST',
        headers: {'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify({diet_id: dietId})
      });
      const j = await r.json();
      if(!r.ok || j.ok === false){
        throw new Error(j.message || j.error || '–û—à–∏–±–∫–∞');
      }
      const byMeal = j.items_by_meal || groupItemsFlat(j.items || []);
      render(byMeal);
    }catch(e){
      setStatus('–æ—à–∏–±–∫–∞', 'err');
      toggleButtons(false);
      showFlash(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É: ${e.message || e}`, 'err');
      $content.innerHTML = '';
    }finally{
      $btnBuild.disabled = false;
    }
  }

  async function resetCart(){
    if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ—Ä–∑–∏–Ω—É?')) return;
    try{
      $btnReset.disabled = true;
      setStatus('—Å–±—Ä–∞—Å—ã–≤–∞–µ–º‚Ä¶', 'warn');
      showFlash('–£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏‚Ä¶', 'info');
      const r = await fetch('/shopping/reset', {
        method: 'POST',
        headers: {'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify({diet_id: dietId})
      });
      const j = await r.json();
      if(!r.ok || j.ok === false){
        throw new Error(j.message || j.error || '–û—à–∏–±–∫–∞');
      }
      // –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ ‚Äî –ø—É—Å—Ç–æ–π —Ä–µ–Ω–¥–µ—Ä
      render({breakfast:[],lunch:[],dinner:[],snack:[]});
    }catch(e){
      setStatus('–æ—à–∏–±–∫–∞', 'err');
      showFlash(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É: ${e.message || e}`, 'err');
    }finally{
      $btnReset.disabled = false;
    }
  }

  $btnBuild?.addEventListener('click', buildCart, {passive:true});
  $btnReset?.addEventListener('click', resetCart, {passive:true});

  // –∞–≤—Ç–æ-–∑–∞–≥—Ä—É–∑–∫–∞
  loadCart();
})();
</script>

{% endblock %}
