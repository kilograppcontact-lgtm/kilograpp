{% extends "base.html" %}
{% set title = "Тренировки" %}

{% block content %}
<style>
/* Анимации и эффекты */
@keyframes slide-left { from { opacity:0; transform: translateX(12px); } to { opacity:1; transform: translateX(0);} }
@keyframes slide-right{ from { opacity:0; transform: translateX(-12px);} to { opacity:1; transform: translateX(0);} }
@keyframes pop { from { transform: scale(.96); opacity:0;} to { transform: scale(1); opacity:1;} }
@keyframes fade { from { opacity:0;} to { opacity:1;} }
.grid-animate-left { animation: slide-left .18s ease-out; }
.grid-animate-right{ animation: slide-right .18s ease-out; }
.modal-pop         { animation: pop .18s ease-out; }
.fade-in           { animation: fade .18s ease-out; }

/* Календарь */
.calendar-cell:hover .day-badge { transform: translateY(-1px); }
.calendar-cell:hover { box-shadow: 0 6px 22px -10px rgba(16,24,40,.25); }
.pill { transition: transform .15s ease, box-shadow .15s ease, background .15s ease; }
.pill:hover { transform: translateY(-1px); box-shadow: 0 6px 16px -10px rgba(0,0,0,.25); }

/* Горизонтальный скролл на мобилке, чтобы календарь не «терялся» */
.calendar-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
.calendar-inner  { min-width: 1000px; }
.weekdays-sticky { position: sticky; top: 0; z-index: 5; }

/* Модалки */
.modal-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.40); z-index: 60; }
.modal-overlay.show { display: flex; }
.modal-card { width: min(100%, 860px); max-height: 80vh; overflow: hidden; border-radius: 20px; }
.modal-body { max-height: 60vh; overflow: auto; }

/* Мобильные правки */
@media (max-width: 1024px) {
  .layout { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
  .calendar-inner { min-width: 900px; }
}
</style>

<section class="max-w-7xl mx-auto px-4 py-8">
  <!-- ШАПКА -->
  <div class="mb-6 rounded-3xl overflow-hidden">
    <div class="relative isolate rounded-3xl p-5 md:p-6 bg-gradient-to-r from-indigo-600 via-violet-600 to-fuchsia-600 text-white">
      <div class="absolute inset-0 opacity-20 pointer-events-none"
           style="background: radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,.25), transparent),
                   radial-gradient(1000px 500px at 90% 120%, rgba(255,255,255,.25), transparent);">
      </div>

      <div class="relative z-10 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="flex items-center gap-3">
          <button id="prevMonth" class="p-2 rounded-xl bg-white/15 hover:bg-white/25 transition" aria-label="Предыдущий месяц">
            <i class="bi bi-chevron-left"></i>
          </button>
          <div class="flex items-center gap-2">
            <div id="monthLabel" class="text-xl font-semibold tracking-tight">Месяц YYYY</div>
            <select id="monthSelect" class="text-sm bg-white/10 border border-white/20 rounded-lg px-2 py-1">
              <option value="0">Январь</option><option value="1">Февраль</option><option value="2">Март</option><option value="3">Апрель</option>
              <option value="4">Май</option><option value="5">Июнь</option><option value="6">Июль</option><option value="7">Август</option>
              <option value="8">Сентябрь</option><option value="9">Октябрь</option><option value="10">Ноябрь</option><option value="11">Декабрь</option>
            </select>
            <input id="yearInput" type="number" class="w-24 text-sm bg-white/10 border border-white/20 rounded-lg px-2 py-1" placeholder="2025" />
          </div>
          <button id="nextMonth" class="p-2 rounded-xl bg-white/15 hover:bg-white/25 transition" aria-label="Следующий месяц">
            <i class="bi bi-chevron-right"></i>
          </button>

          <button id="btnToday" class="ml-2 px-3 py-1.5 rounded-xl bg-white/15 hover:bg-white/25 transition">
            Сегодня
          </button>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <div class="relative">
            <i class="bi bi-search absolute left-3 top-2.5 text-white/70"></i>
            <input id="searchInput" type="text" placeholder="Поиск: тренер или название…"
                   class="pl-9 pr-3 py-2 text-sm rounded-xl bg-white/15 placeholder-white/70 border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/50">
          </div>
          <label class="inline-flex items-center gap-2 text-sm bg-white/15 border border-white/20 rounded-xl px-3 py-2">
            <input id="onlyMine" type="checkbox" class="rounded accent-white"/>
            Только мои
          </label>
          <span id="tzInfo" class="text-xs text-white/80"></span>

          {% if is_trainer %}
          <button id="btnNew" class="hidden md:inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white text-indigo-700 hover:bg-white/90 shadow-sm">
            <i class="bi bi-plus-circle"></i> Создать
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ОСНОВА -->
  <div class="layout grid lg:grid-cols-[1fr,360px] gap-8 items-start">
    <!-- КАЛЕНДАРЬ -->
    <div class="rounded-3xl border border-gray-200 bg-white shadow-sm overflow-hidden dark:border-white/10 dark:bg-slate-900/60">
      <div class="calendar-scroll">
        <div class="calendar-inner">
          <!-- заголовки дней -->
          <div class="grid grid-cols-7 gap-px bg-gray-100 dark:bg-white/10 weekdays-sticky">
            {% set weekdays = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'] %}
            {% for w in weekdays %}
              <div class="bg-gray-50 dark:bg-slate-800/60 text-center text-[12px] font-semibold py-2 uppercase tracking-wide text-gray-600 dark:text-gray-300">
                {{ w }}
              </div>
            {% endfor %}
          </div>
          <!-- сетка -->
          <div id="calendarGrid" class="grid grid-cols-7 gap-px bg-gray-100 dark:bg-white/10 min-h-[560px]"></div>
        </div>
      </div>
    </div>

    <!-- МОИ ТРЕНИРОВКИ (для тренера) -->
    <aside class="rounded-3xl border border-gray-200 bg-white shadow-sm overflow-hidden dark:border-white/10 dark:bg-slate-900/60">
      <div class="p-4 border-b border-gray-200 dark:border-white/10 flex items-center justify-between">
        <h2 class="font-semibold">Мои тренировки</h2>
        {% if is_trainer %}
        <span class="text-xs px-2 py-1 rounded bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300">тренер</span>
        {% endif %}
      </div>
      <div id="myList" class="divide-y divide-gray-100 dark:divide-white/10 max-h-[70vh] overflow-auto">
        <div class="p-4 animate-pulse">
          <div class="h-3 w-2/3 bg-gray-200 dark:bg-white/10 rounded mb-2"></div>
          <div class="h-3 w-1/2 bg-gray-200 dark:bg-white/10 rounded"></div>
        </div>
      </div>
      <div class="p-3 text-xs text-gray-500 dark:text-gray-400">
        Лайфхаки: ←/→ переключают месяцы, T — сегодня, N — новая (для тренера), двойной клик по дню — создать.
      </div>
    </aside>
  </div>

  {% if is_trainer %}
  <!-- FAB на мобиле -->
  <button id="fabNew"
          class="md:hidden fixed bottom-5 right-5 inline-flex items-center gap-2 px-4 py-3 rounded-full text-white shadow-lg
                 bg-gradient-to-r from-indigo-600 to-fuchsia-600 hover:opacity-95 focus:ring-4 focus:ring-indigo-300">
    <i class="bi bi-plus-lg text-lg"></i><span class="font-medium">Создать</span>
  </button>
  {% endif %}
</section>

<!-- МОДАЛКА СОЗДАНИЯ/РЕДАКТИРОВАНИЯ -->
<div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
  <div class="modal-pop bg-white dark:bg-slate-900/90 w-full max-w-lg rounded-2xl shadow-xl border border-gray-200 dark:border-white/10">
    <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-white/10">
      <h3 id="modalTitle" class="font-semibold">Новая тренировка</h3>
      <button id="modalClose" class="p-2 rounded hover:bg-black/5 dark:hover:bg-white/10"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="p-4 space-y-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">Дата</label>
          <input id="fDate" type="date" class="w-full border rounded-xl px-3 py-2 bg-white dark:bg-slate-900/60" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">Начало</label>
            <input id="fStart" type="time" class="w-full border rounded-xl px-3 py-2 bg-white dark:bg-slate-900/60" />
          </div>
          <div>
            <label class="block text-sm mb-1">Окончание</label>
            <input id="fEnd" type="time" class="w-full border rounded-xl px-3 py-2 bg-white dark:bg-slate-900/60" />
          </div>
        </div>
      </div>

      <div>
  <label class="block text-sm mb-1">Название тренировки</label>
  <input id="fTitle" type="text" placeholder="Например: Калистеника"
         class="w-full border rounded-xl px-3 py-2 bg-white dark:bg-slate-900/60" />
</div>

<div>
  <label class="block text-sm mb-1">Ссылка на занятие</label>
  <input id="fLink" type="url" placeholder="https://zoom.u..." class="w-full border rounded-xl px-3 py-2 bg-white dark:bg-slate-900/60" />
  <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">В превью видны: имя тренера, время и название, остальное — в деталях.</p>
</div>


      <div id="formError" class="text-sm text-red-600 hidden"></div>
    </div>
    <div class="p-4 border-t border-gray-200 dark:border-white/10 flex items-center justify-end gap-2">
      <button id="btnCancel" class="px-3 py-2 rounded-xl border hover:bg-black/5 dark:hover:bg-white/10">Отмена</button>
      <button id="btnSave" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-60">Сохранить</button>
    </div>
  </div>
</div>

<!-- МОДАЛКА ДЕТАЛЕЙ ТРЕНИРОВКИ -->
<div id="trainingModal" class="modal-overlay">
  <div class="modal-card bg-white dark:bg-slate-900 text-slate-900 dark:text-white shadow-xl">
    <div class="flex items-center justify-between p-4 border-b dark:border-white/10">
      <div class="text-lg font-semibold">Детали тренировки</div>
      <button id="trainingModalClose" class="p-2 rounded-lg hover:bg-black/5 dark:hover:bg-white/10"><i class="bi bi-x-lg"></i></button>
    </div>
    <div id="trainingModalBody" class="modal-body p-4 space-y-3"></div>
  </div>
</div>

<!-- TOASTS -->
<div id="toastHost" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[60] space-y-2 pointer-events-none"></div>

<script>
(() => {
  // -------- helpers --------
  const $ = sel => document.querySelector(sel);
  const el = id => document.getElementById(id);

  const isTrainer = {{ 'true' if is_trainer else 'false' }};
  const meId = {{ me_id or 'null' }};

  const monthLabel = el('monthLabel');
  const monthSelect = el('monthSelect');
  const yearInput = el('yearInput');
  const grid = el('calendarGrid');
  const myList = el('myList');

  const btnPrev = el('prevMonth');
  const btnNext = el('nextMonth');
  const btnToday = el('btnToday');
  const btnNew = el('btnNew');
  const fabNew = el('fabNew');

  const modal = el('modal');
  const modalTitle = el('modalTitle');
  const modalClose = el('modalClose');
  const btnCancel = el('btnCancel');
  const btnSave = el('btnSave');

  const fDate = el('fDate');
  const fStart = el('fStart');
  const fEnd = el('fEnd');
  const fLink = el('fLink');
  const formError = el('formError');

  const onlyMine = el('onlyMine');
  const searchInput = el('searchInput');
  const tzInfo = el('tzInfo');

  const trainingModal = el('trainingModal');
  const trainingModalClose = el('trainingModalClose');
  const trainingModalBody = el('trainingModalBody');

  const ruMonths = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];

  const now = new Date();
  const saved = JSON.parse(localStorage.getItem('trainings_month_v2') || 'null');
  const state = {
    y: saved?.y ?? now.getFullYear(),
    m: saved?.m ?? now.getMonth(),
    data: [],
    filterMine: false,
    search: ''
  };

  function fmt2(n){ return String(n).padStart(2,'0'); }
  function yyyymm(y, m){ return y + '-' + fmt2(m+1); }
  function yyyymmdd(d){ return `${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())}`; }
  function toLocalDateStr(y, m, d){ return y + '-' + fmt2(m+1) + '-' + fmt2(d); }
  function isSameDate(a, b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function clampYear(v){ v = parseInt(v||'',10); if(isNaN(v)) return new Date().getFullYear(); return Math.min(9999, Math.max(1900, v)); }

  function notify(text, type='ok'){
    const host = el('toastHost');
    const box = document.createElement('div');
    box.className = `fade-in pointer-events-auto px-3 py-2 rounded-xl text-sm shadow ${type==='ok' ? 'bg-emerald-600 text-white' : 'bg-rose-600 text-white'}`;
    box.textContent = text;
    host.appendChild(box);
    setTimeout(()=>{ box.style.opacity='0'; box.style.transition='opacity .2s'; }, 2400);
    setTimeout(()=>{ host.removeChild(box); }, 2800);
  }

  function copy(text){ return navigator.clipboard?.writeText(text).then(()=>true).catch(()=>false); }

  function tzString(){
    const z = -new Date().getTimezoneOffset()/60;
    const sign = z>=0?'+':'-';
    return `Время браузера (GMT${sign}${Math.abs(z)})`;
  }
  tzInfo.textContent = tzString();

  // -------- modal create/edit --------
  let editingId = null;
  function openModal(dateStr, initial=null){
    if(!isTrainer) return;
    modal.classList.remove('hidden'); modal.classList.add('flex');
    modalTitle.textContent = initial ? 'Редактировать тренировку' : 'Новая тренировка';
    editingId = initial ? initial.id : null;

    formError.classList.add('hidden'); formError.textContent = '';
    fDate.value = dateStr || '';
fStart.value = initial ? initial.start_time : '';
fEnd.value   = initial ? initial.end_time   : '';
fLink.value  = initial ? (initial.meeting_link || '') : '';
fTitle.value = initial ? (initial.title || '') : '';
btnSave.disabled = false;

  }
  function closeModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); editingId = null; }

  modalClose?.addEventListener('click', closeModal);
  btnCancel?.addEventListener('click', closeModal);
  btnNew?.addEventListener('click', () => openModal(yyyymmdd(new Date(state.y, state.m, new Date().getDate()))));
  fabNew?.addEventListener('click', () => openModal(yyyymmdd(new Date(state.y, state.m, new Date().getDate()))));

  btnSave.addEventListener('click', async () => {
    const payload = {
  date: fDate.value,
  start_time: fStart.value,
  end_time: fEnd.value,
  meeting_link: fLink.value.trim(),
  title: (fTitle.value || '').trim()
};

    const err = [];
    if(!payload.date) err.push('Укажите дату');
    if(!payload.start_time) err.push('Укажите время начала');
    if(!payload.end_time) err.push('Укажите время окончания');
    if(!/^https?:\/\//i.test(payload.meeting_link)) err.push('Ссылка должна начинаться с http(s)://');
    if(err.length){
      formError.textContent = err.join('. ');
      formError.classList.remove('hidden');
      return;
    }
    formError.classList.add('hidden'); formError.textContent = '';
    btnSave.disabled = true; const restoreText = btnSave.textContent; btnSave.textContent = editingId ? 'Сохраняю…' : 'Создаю…';

    try{
      const r = await fetch(editingId ? `/api/trainings/${editingId}` : '/api/trainings', {
        method: editingId ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const ok = r.ok;
      const j = await r.json().catch(()=>({}));
      if(!ok) throw new Error(j?.message || j?.error || 'Ошибка сохранения');
      closeModal();
      notify(editingId ? 'Тренировка обновлена' : 'Тренировка создана');
      await Promise.all([loadMonth(true), loadMine()]);
    }catch(e){
      formError.textContent = e.message || String(e);
      formError.classList.remove('hidden');
    }finally{
      btnSave.disabled = false; btnSave.textContent = restoreText;
    }
  });

  // -------- ICS --------
  function toICSDate(dateStr, timeStr){
    const [y,m,d] = dateStr.split('-').map(Number);
    const [hh,mm] = timeStr.split(':').map(Number);
    return `${y}${fmt2(m)}${fmt2(d)}T${fmt2(hh)}${fmt2(mm)}00`;
  }
  function downloadICS(t){
    const uid = `training-${t.id || Math.random().toString(36).slice(2)}@kilogr`;
    const dtStart = toICSDate(t.date, t.start_time);
    const dtEnd = toICSDate(t.date, t.end_time);
    const title = `${t.title || 'Онлайн-тренировка'} (${t.trainer_name})`;
    const desc = `Ссылка: ${t.meeting_link}`;
    const host = (()=>{ try{ return new URL(t.meeting_link).hostname; }catch(_e){ return 'online'; }})();
    const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Kilogr.app//Trainings//EN
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtStart}Z
DTSTART:${dtStart}
DTEND:${dtEnd}
SUMMARY:${title}
DESCRIPTION:${desc}
LOCATION:${host}
END:VEVENT
END:VCALENDAR`;
    const blob = new Blob([ics], {type: 'text/calendar;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `training_${t.date}_${t.start_time}.ics`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
  }

  // -------- загрузка --------
  async function loadMonth(animateDirection){
    const r = await fetch(`/api/trainings?month=${yyyymm(state.y, state.m)}`);
    const j = await r.json().catch(()=>({}));
    state.data = Array.isArray(j?.data) ? j.data : [];
    renderGrid(animateDirection);
  }
  async function loadMine(){
    if(!isTrainer){
      myList.innerHTML = '<div class="p-4 text-gray-400 text-sm">Недоступно — вы не тренер</div>';
      return;
    }
    const r = await fetch('/api/trainings/mine');
    const j = await r.json().catch(()=>({}));
    const items = Array.isArray(j?.data) ? j.data : [];
    if(items.length === 0){
      myList.innerHTML = `
        <div class="p-8 text-center text-gray-500">
          <div class="text-3xl mb-2">🗓️</div>
          <div class="font-medium">Пока нет тренировок</div>
          <div class="text-sm">Создайте первую — она появится здесь.</div>
        </div>`;
      return;
    }
    myList.innerHTML = items.map(t => {
      const host = (()=>{ try{ return new URL(t.meeting_link).hostname; }catch(_e){ return 'ссылка'; }})();
      return `
      <div class="p-4 flex items-start gap-3 group">
        <div class="shrink-0 mt-0.5 text-indigo-600"><i class="bi bi-broadcast-pin"></i></div>
        <div class="flex-1 min-w-0">
          <div class="text-sm font-semibold">${t.date} · ${t.start_time}–${t.end_time}</div>
          <div class="text-sm text-gray-700 dark:text-gray-200 truncate">${t.title || 'Онлайн-тренировка'} — ${t.trainer_name}</div>
          <a href="${t.meeting_link}" target="_blank" rel="noopener" class="text-xs text-indigo-600 hover:underline truncate">${host}</a>
          <div class="mt-2 flex items-center gap-2 opacity-100">
            <button data-edit="${t.id}" class="px-2 py-1 text-xs rounded-lg border hover:bg-black/5 dark:hover:bg-white/10"><i class="bi bi-pencil"></i> Изменить</button>
            <button data-ics="${t.id}" class="px-2 py-1 text-xs rounded-lg border hover:bg-black/5 dark:hover:bg-white/10"><i class="bi bi-calendar-plus"></i> .ics</button>
            <button data-del="${t.id}" class="px-2 py-1 text-xs rounded-lg border border-rose-300 text-rose-600 hover:bg-rose-50 dark:border-rose-600/40 dark:hover:bg-rose-900/20"><i class="bi bi-trash"></i> Удалить</button>
          </div>
        </div>
      </div>`;
    }).join('');

    const itemsMap = Object.fromEntries(items.map(x=>[String(x.id), x]));
    myList.querySelectorAll('[data-edit]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const t = itemsMap[String(btn.getAttribute('data-edit'))];
        openModal(t.date, t);
      });
    });
    myList.querySelectorAll('[data-ics]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const t = itemsMap[String(btn.getAttribute('data-ics'))];
        downloadICS(t);
      });
    });
    myList.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-del');
        if(!confirm('Удалить тренировку?')) return;
        const r = await fetch(`/api/trainings/${id}`, { method:'DELETE' });
        if(r.ok){ await Promise.all([loadMonth(), loadMine()]); notify('Удалено'); } else { notify('Не удалось удалить','err'); }
      });
    });
  }

  // -------- рендер календаря (минимальный превью) --------
  function monthHeader(){
    monthLabel.textContent = `${ruMonths[state.m]} ${state.y}`;
    monthSelect.value = String(state.m);
    yearInput.value = String(state.y);
  }

  function filteredData(){
    const q = (state.search || '').trim().toLowerCase();
    return state.data.filter(t => {
      if(state.filterMine && !t.mine) return false;
      const hay = `${t.trainer_name||''} ${t.title||''}`.toLowerCase();
      if(q && !hay.includes(q)) return false;
      return true;
    });
  }

  function renderGrid(animateDirection){
    monthHeader();
    const data = filteredData();

    const byDate = {};
    for(const t of data){ (byDate[t.date] ||= []).push(t); }
    for(const k in byDate){ byDate[k].sort((a,b)=> a.start_time.localeCompare(b.start_time)); }

    const first = new Date(state.y, state.m, 1);
    const last = new Date(state.y, state.m+1, 0);
    const startWeekDay = (first.getDay()+6)%7; // 0..6, 0=Пн
    const totalCells = startWeekDay + last.getDate();
    const weeks = Math.ceil(totalCells / 7);
    const cells = Math.max(42, weeks*7);

    grid.innerHTML = '';
    if(animateDirection === 'left') grid.classList.add('grid-animate-left');
    if(animateDirection === 'right') grid.classList.add('grid-animate-right');
    setTimeout(()=>{ grid.classList.remove('grid-animate-left','grid-animate-right'); }, 190);

    for(let i=0; i<cells; i++){
      const cell = document.createElement('div');
      cell.className = 'calendar-cell relative bg-white dark:bg-slate-900/40 min-h-[140px] p-2 transition rounded-none';

      const dayNum = i - startWeekDay + 1;
      if(dayNum < 1 || dayNum > last.getDate()){
        cell.classList.add('bg-gray-50','dark:bg-slate-800/50');
        grid.appendChild(cell);
        continue;
      }

      const dateStr = toLocalDateStr(state.y, state.m, dayNum);
      const dateObj = new Date(state.y, state.m, dayNum);

      const w = (dateObj.getDay()+6)%7;
      const isWeekend = [5,6].includes(w);
      const isToday = isSameDate(dateObj, new Date());
      if(isWeekend) cell.classList.add('bg-rose-50/40','dark:bg-rose-900/10');
      if(isToday) cell.classList.add('ring-2','ring-indigo-300');

      // Хедер дня
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between mb-2';
      const dn = document.createElement('div');
      dn.className = 'day-badge inline-flex items-center justify-center w-7 h-7 text-sm font-semibold rounded-full transition ' + (isToday ? 'bg-indigo-600 text-white' : 'bg-black/5 dark:bg-white/10 text-gray-700 dark:text-gray-200');
      dn.textContent = dayNum;
      header.appendChild(dn);

      if(isTrainer){
        const plus = document.createElement('button');
        plus.className = 'p-1.5 rounded-lg text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-white/10 transition';
        plus.title = 'Создать тренировку';
        plus.innerHTML = '<i class="bi bi-plus-circle"></i>';
        plus.addEventListener('click', () => openModal(dateStr));
        header.appendChild(plus);
      }
      cell.appendChild(header);

      // Список событий (минимальный превью)
      const list = document.createElement('div');
      list.className = 'space-y-1 max-h-40 overflow-auto pr-1';
      const items = byDate[dateStr] || [];

      if(items.length === 0){
        const empty = document.createElement('div');
        empty.className = 'text-[11px] text-gray-400 select-none';
        empty.textContent = 'Нет тренировок';
        list.appendChild(empty);
      }

      for(const t of items){
        const wrap = document.createElement('div');
        wrap.className = 'pill group rounded-xl border flex flex-col gap-1 px-2 py-1 text-xs ' +
          (t.mine ? 'bg-indigo-50 border-indigo-200 dark:bg-indigo-900/20 dark:border-indigo-700' : 'bg-gray-50 border-gray-200 dark:bg-slate-800/60 dark:border-white/10');

        // строка 1: время + тренер
        const row1 = document.createElement('div');
        row1.className = 'flex items-center justify-between gap-2';
        row1.innerHTML = `<span class="font-medium">${t.start_time}–${t.end_time}</span>
                          <span class="truncate text-gray-700 dark:text-gray-200">${t.trainer_name}</span>`;
        wrap.appendChild(row1);

        // строка 2: название
        const row2 = document.createElement('div');
        row2.className = 'truncate text-gray-600 dark:text-gray-300';
        row2.textContent = t.title || 'Онлайн-тренировка';
        wrap.appendChild(row2);

        // строка 3: одна кнопка — «Подробнее» (все детали в модалке)
        const row3 = document.createElement('div');
        row3.className = 'flex items-center justify-end';
        const btn = document.createElement('button');
        btn.className = 'px-2 py-1 rounded-lg border text-indigo-700 border-indigo-300 hover:bg-indigo-50 dark:border-indigo-600/40 dark:hover:bg-indigo-900/20';
        btn.textContent = 'Подробнее';
        btn.addEventListener('click', ()=> openTrainingModal(t));
        row3.appendChild(btn);
        wrap.appendChild(row3);

        list.appendChild(wrap);
      }

      cell.appendChild(list);

      // даблклик — быстрое создание (только тренеру)
      if(isTrainer){
        cell.addEventListener('dblclick', ()=>{
          const startH = 19;
          openModal(dateStr, {start_time:`${fmt2(startH)}:00`, end_time:`${fmt2(startH+1)}:00`, meeting_link:''});
          editingId = null;
        });
      }

      grid.appendChild(cell);
    }
  }

  // -------- модалка деталей тренировки --------
  function openTrainingModal(t){
    const host = (()=>{ try{ return new URL(t.meeting_link).hostname; }catch(_e){ return ''; }})();
    trainingModalBody.innerHTML = `
      <div class="space-y-2">
        <div class="text-sm text-gray-500">${t.date}</div>
        <div class="text-base font-semibold">${t.title || 'Онлайн-тренировка'}</div>
        <div class="text-sm">Тренер: <span class="font-medium">${t.trainer_name}</span></div>
        <div class="text-sm">Время: <span class="font-medium">${t.start_time}–${t.end_time}</span></div>
        <div class="pt-2 flex items-center justify-between gap-3">
          ${t.meeting_link
            ? `<a href="${t.meeting_link}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
                 <i class="bi bi-box-arrow-up-right"></i> Перейти
               </a>`
            : `<span class="text-sm text-gray-500">Ссылка появится позже</span>`
          }
          <div class="flex items-center gap-2">
            <button id="btnCopyLink" class="px-2 py-1 rounded-lg border hover:bg-black/5 dark:hover:bg-white/10" ${t.meeting_link ? '' : 'disabled'}><i class="bi bi-clipboard"></i> Копировать</button>
            <button id="btnICS" class="px-2 py-1 rounded-lg border hover:bg-black/5 dark:hover:bg-white/10"><i class="bi bi-calendar-plus"></i> .ics</button>
            ${isTrainer && t.mine
              ? `<button id="btnEdit" class="px-2 py-1 rounded-lg border hover:bg-black/5 dark:hover:bg-white/10"><i class="bi bi-pencil"></i> Редактировать</button>
                 <button id="btnDel" class="px-2 py-1 rounded-lg border border-rose-300 text-rose-600 hover:bg-rose-50 dark:border-rose-600/40 dark:hover:bg-rose-900/20"><i class="bi bi-trash"></i> Удалить</button>`
              : ''
            }
          </div>
        </div>
      </div>
    `;
    // привязка действий
    trainingModalBody.querySelector('#btnICS')?.addEventListener('click', ()=> downloadICS(t));
    trainingModalBody.querySelector('#btnCopyLink')?.addEventListener('click', async ()=>{
      const ok = await copy(t.meeting_link||''); notify(ok ? 'Ссылка скопирована' : 'Не удалось скопировать', ok?'ok':'err');
    });
    if(isTrainer && t.mine){
      trainingModalBody.querySelector('#btnEdit')?.addEventListener('click', ()=>{ showModal(trainingModal,false); openModal(t.date, t); });
      trainingModalBody.querySelector('#btnDel')?.addEventListener('click', async ()=>{
        if(!confirm('Удалить тренировку?')) return;
        const r = await fetch(`/api/trainings/${t.id}`, { method:'DELETE' });
        if(r.ok){ showModal(trainingModal,false); await Promise.all([loadMonth(), loadMine()]); notify('Удалено'); } else { notify('Не удалось удалить','err'); }
      });
    }
    showModal(trainingModal, true);
  }

  // ---- helpers для модалок ----
  function showModal(node, yes){ if(yes){ node.classList.add('show'); } else { node.classList.remove('show'); } }
  trainingModalClose.addEventListener('click', ()=> showModal(trainingModal,false));
  trainingModal.addEventListener('click', e=>{ if(e.target === trainingModal) showModal(trainingModal,false); });
  document.addEventListener('keydown', e=>{ if(e.key === 'Escape') showModal(trainingModal,false); });

  // -------- навигация --------
  function saveMonth(){ localStorage.setItem('trainings_month_v2', JSON.stringify({y: state.y, m: state.m})); }
  async function goPrev(){ if(state.m===0){ state.m=11; state.y--; } else state.m--; saveMonth(); await loadMonth('right'); }
  async function goNext(){ if(state.m===11){ state.m=0; state.y++; } else state.m++; saveMonth(); await loadMonth('left'); }
  async function goToday(){ const d=new Date(); state.y=d.getFullYear(); state.m=d.getMonth(); saveMonth(); await loadMonth(); }

  btnPrev.addEventListener('click', goPrev);
  btnNext.addEventListener('click', goNext);
  btnToday.addEventListener('click', goToday);
  monthSelect.addEventListener('change', async (e)=>{ state.m = parseInt(e.target.value,10); saveMonth(); await loadMonth(); });
  yearInput.addEventListener('change', async (e)=>{ state.y = clampYear(e.target.value); saveMonth(); await loadMonth(); });

  // клавиатура
  document.addEventListener('keydown', (e)=>{
    if(e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
    if(e.key==='ArrowLeft'){ e.preventDefault(); goPrev(); }
    if(e.key==='ArrowRight'){ e.preventDefault(); goNext(); }
    if(e.key.toLowerCase()==='t'){ e.preventDefault(); goToday(); }
    if(e.key.toLowerCase()==='n' && isTrainer){ e.preventDefault(); openModal(yyyymmdd(new Date(state.y, state.m, new Date().getDate())), null); }
  });

  // фильтры
  onlyMine.addEventListener('change', ()=>{ state.filterMine = !!onlyMine.checked; renderGrid(); });
  searchInput.addEventListener('input', ()=>{ state.search = searchInput.value; renderGrid(); });

  // загрузка
  async function refresh(){ await Promise.all([loadMonth(), loadMine()]); }
  refresh();
})();
</script>
{% endblock %}
