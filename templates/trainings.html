{% extends "base.html" %}
{% set title = "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏" %}

{% block content %}
<style>
/* –ê–Ω–∏–º–∞—Ü–∏–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã */
@keyframes slide-left { from { opacity:0; transform: translateX(12px); } to { opacity:1; transform: translateX(0);} }
@keyframes slide-right{ from { opacity:0; transform: translateX(-12px);} to { opacity:1; transform: translateX(0);} }
@keyframes pop { from { transform: scale(.96); opacity:0;} to { transform: scale(1); opacity:1;} }
@keyframes fade { from { opacity:0;} to { opacity:1;} }
.grid-animate-left { animation: slide-left .18s ease-out; }
.grid-animate-right{ animation: slide-right .18s ease-out; }
.modal-pop         { animation: pop .18s ease-out; }
.fade-in           { animation: fade .18s ease-out; }

/* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
.calendar-cell:hover .day-badge { transform: translateY(-1px); }
.calendar-cell:hover { box-shadow: 0 6px 22px -10px rgba(16,24,40,.25); }
.pill { transition: transform .15s ease, box-shadow .15s ease, background .15s ease; }
.pill:hover { transform: translateY(-1px); box-shadow: 0 6px 16px -10px rgba(0,0,0,.25); }

/* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –Ω–∞ –º–æ–±–∏–ª–∫–µ, —á—Ç–æ–±—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–µ ¬´—Ç–µ—Ä—è–ª—Å—è¬ª */
.calendar-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
.calendar-inner  { min-width: 1000px; }
.weekdays-sticky { position: sticky; top: 0; z-index: 5; }

/* –ú–æ–¥–∞–ª–∫–∏ */
.modal-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.40); z-index: 60; }
.modal-overlay.show { display: flex; }
.modal-card { width: min(100%, 860px); max-height: 80vh; overflow: hidden; border-radius: 20px; }
.modal-body { max-height: 60vh; overflow: auto; }

/* –ú–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ */
@media (max-width: 1024px) {
  .layout { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
  .calendar-inner { min-width: 900px; }
}
</style>

<section class="max-w-7xl mx-auto px-4 py-8">
  <!-- –®–ê–ü–ö–ê -->
  <div class="mb-6 rounded-3xl overflow-hidden">
    <div class="relative isolate rounded-3xl p-5 md:p-6 bg-gradient-to-r from-indigo-600 via-violet-600 to-fuchsia-600 text-white">
      <div class="absolute inset-0 opacity-20 pointer-events-none"
           style="background: radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,.25), transparent),
                   radial-gradient(1000px 500px at 90% 120%, rgba(255,255,255,.25), transparent);">
      </div>

      <div class="relative z-10 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="flex items-center gap-3">
          <button id="prevMonth" class="p-2 rounded-xl bg-white/15 hover:bg-white/25 transition" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">
            <i class="bi bi-chevron-left"></i>
          </button>
          <div class="flex items-center gap-2">
            <div id="monthLabel" class="text-xl font-semibold tracking-tight">–ú–µ—Å—è—Ü YYYY</div>
            <select id="monthSelect" class="text-sm bg-white/10 border border-white/20 rounded-lg px-2 py-1">
              <option value="0">–Ø–Ω–≤–∞—Ä—å</option><option value="1">–§–µ–≤—Ä–∞–ª—å</option><option value="2">–ú–∞—Ä—Ç</option><option value="3">–ê–ø—Ä–µ–ª—å</option>
              <option value="4">–ú–∞–π</option><option value="5">–ò—é–Ω—å</option><option value="6">–ò—é–ª—å</option><option value="7">–ê–≤–≥—É—Å—Ç</option>
              <option value="8">–°–µ–Ω—Ç—è–±—Ä—å</option><option value="9">–û–∫—Ç—è–±—Ä—å</option><option value="10">–ù–æ—è–±—Ä—å</option><option value="11">–î–µ–∫–∞–±—Ä—å</option>
            </select>
            <input id="yearInput" type="number" class="w-24 text-sm bg-white/10 border border-white/20 rounded-lg px-2 py-1" placeholder="2025" />
          </div>
          <button id="nextMonth" class="p-2 rounded-xl bg-white/15 hover:bg-white/25 transition" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">
            <i class="bi bi-chevron-right"></i>
          </button>

          <button id="btnToday" class="ml-2 px-3 py-1.5 rounded-xl bg-white/15 hover:bg-white/25 transition">
            –°–µ–≥–æ–¥–Ω—è
          </button>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <div class="relative">
            <i class="bi bi-search absolute left-3 top-2.5 text-white/70"></i>
            <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫: —Ç—Ä–µ–Ω–µ—Ä –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ‚Ä¶"
                   class="pl-9 pr-3 py-2 text-sm rounded-xl bg-white/15 placeholder-white/70 border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/50">
          </div>
          <label class="inline-flex items-center gap-2 text-sm bg-white/15 border border-white/20 rounded-xl px-3 py-2">
            <input id="onlyMine" type="checkbox" class="rounded accent-white"/>
            –¢–æ–ª—å–∫–æ –º–æ–∏
          </label>
          <span id="tzInfo" class="text-xs text-white/80"></span>

          {% if is_trainer %}
          <button id="btnNew" class="hidden md:inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white text-indigo-700 hover:bg-white/90 shadow-sm">
            <i class="bi bi-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- –û–°–ù–û–í–ê -->
  <div class="layout grid lg:grid-cols-[1fr,360px] gap-8 items-start">
    <!-- –ö–ê–õ–ï–ù–î–ê–†–¨ -->
    <div class="rounded-3xl border border-gray-200 bg-white shadow-sm overflow-hidden">
      <div class="calendar-scroll">
        <div class="calendar-inner">
          <!-- –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π -->
          <div class="grid grid-cols-7 gap-px bg-gray-100 weekdays-sticky">
            {% set weekdays = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'] %}
            {% for w in weekdays %}
              <div class="bg-gray-50 text-center text-[12px] font-semibold py-2 uppercase tracking-wide text-gray-600">
                {{ w }}
              </div>
            {% endfor %}
          </div>
          <!-- —Å–µ—Ç–∫–∞ -->
          <div id="calendarGrid" class="grid grid-cols-7 gap-px bg-gray-100 min-h-[560px]"></div>
        </div>
      </div>
    </div>

    <!-- –ú–û–ò –¢–†–ï–ù–ò–†–û–í–ö–ò (–¥–ª—è —Ç—Ä–µ–Ω–µ—Ä–∞) -->
    <aside class="rounded-3xl border border-gray-200 bg-white shadow-sm overflow-hidden">
      <div class="p-4 border-b border-gray-200 flex items-center justify-between">
        <h2 class="font-semibold">–ú–æ–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h2>
        {% if is_trainer %}
        <span class="text-xs px-2 py-1 rounded bg-emerald-100 text-emerald-700">—Ç—Ä–µ–Ω–µ—Ä</span>
        {% endif %}
      </div>
      <div id="myList" class="divide-y divide-gray-100 max-h-[70vh] overflow-auto">
        <div class="p-4 animate-pulse">
          <div class="h-3 w-2/3 bg-gray-200 rounded mb-2"></div>
          <div class="h-3 w-1/2 bg-gray-200 rounded"></div>
        </div>
      </div>
      <div class="p-3 text-xs text-gray-500">
        –õ–∞–π—Ñ—Ö–∞–∫–∏: ‚Üê/‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Ç –º–µ—Å—è—Ü—ã, T ‚Äî —Å–µ–≥–æ–¥–Ω—è, N ‚Äî –Ω–æ–≤–∞—è (–¥–ª—è —Ç—Ä–µ–Ω–µ—Ä–∞), –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –¥–Ω—é ‚Äî —Å–æ–∑–¥–∞—Ç—å.
      </div>
    </aside>
  </div>

  {% if is_trainer %}
  <!-- FAB –Ω–∞ –º–æ–±–∏–ª–µ -->
  <button id="fabNew"
          class="md:hidden fixed bottom-5 right-5 inline-flex items-center gap-2 px-4 py-3 rounded-full text-white shadow-lg
                 bg-gradient-to-r from-indigo-600 to-fuchsia-600 hover:opacity-95 focus:ring-4 focus:ring-indigo-300">
    <i class="bi bi-plus-lg text-lg"></i><span class="font-medium">–°–æ–∑–¥–∞—Ç—å</span>
  </button>
  {% endif %}
</section>

<!-- –ú–û–î–ê–õ–ö–ê –°–û–ó–î–ê–ù–ò–Ø/–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø -->
<div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
  <div class="modal-pop bg-white w-full max-w-lg rounded-2xl shadow-xl border border-gray-200">
    <div class="flex items-center justify-between p-4 border-b border-gray-200">
      <h3 id="modalTitle" class="font-semibold">–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3>
      <button id="modalClose" class="p-2 rounded hover:bg-black/5"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="p-4 space-y-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">–î–∞—Ç–∞</label>
          <input id="fDate" type="date" class="w-full border rounded-xl px-3 py-2 bg-white" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">–ù–∞—á–∞–ª–æ</label>
            <input id="fStart" type="time" class="w-full border rounded-xl px-3 py-2 bg-white" />
          </div>
          <div>
            <label class="block text-sm mb-1">–û–∫–æ–Ω—á–∞–Ω–∏–µ</label>
            <input id="fEnd" type="time" class="w-full border rounded-xl px-3 py-2 bg-white" />
          </div>
        </div>
      </div>

      <div>
        <label class="block text-sm mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</label>
        <input id="fTitle" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–ª–∏—Å—Ç–µ–Ω–∏–∫–∞"
               class="w-full border rounded-xl px-3 py-2 bg-white" />
      </div>

      <div>
        <label class="block text-sm mb-1">–°—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ</label>
        <input id="fLink" type="url" placeholder="https://zoom.u..." class="w-full border rounded-xl px-3 py-2 bg-white" />
        <p class="mt-1 text-xs text-gray-500">–í –ø—Ä–µ–≤—å—é –≤–∏–¥–Ω—ã: –∏–º—è —Ç—Ä–µ–Ω–µ—Ä–∞, –≤—Ä–µ–º—è –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –≤ –¥–µ—Ç–∞–ª—è—Ö.</p>
      </div>


      <div id="formError" class="text-sm text-red-600 hidden"></div>
    </div>
    <div class="p-4 border-t border-gray-200 flex items-center justify-end gap-2">
      <button id="btnCancel" class="px-3 py-2 rounded-xl border hover:bg-black/5">–û—Ç–º–µ–Ω–∞</button>
      <button id="btnSave" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-60">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –î–ï–¢–ê–õ–ï–ô –¢–†–ï–ù–ò–†–û–í–ö–ò -->
<div id="trainingModal" class="modal-overlay">
  <div class="modal-card bg-white text-slate-900 shadow-xl">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="text-lg font-semibold">–î–µ—Ç–∞–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
      <button id="trainingModalClose" class="p-2 rounded-lg hover:bg-black/5"><i class="bi bi-x-lg"></i></button>
    </div>
    <div id="trainingModalBody" class="modal-body p-4 space-y-3"></div>
  </div>
</div>

<!-- TOASTS -->
<div id="toastHost" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[60] space-y-2 pointer-events-none"></div>

<script>
(() => {
  // -------- helpers --------
  const $ = sel => document.querySelector(sel);
  const el = id => document.getElementById(id);

  const isTrainer = {{ 'true' if is_trainer else 'false' }};
  const meId = {{ me_id or 'null' }};

  const monthLabel = el('monthLabel');
  const monthSelect = el('monthSelect');
  const yearInput = el('yearInput');
  const grid = el('calendarGrid');
  const myList = el('myList');

  const btnPrev = el('prevMonth');
  const btnNext = el('nextMonth');
  const btnToday = el('btnToday');
  const btnNew = el('btnNew');
  const fabNew = el('fabNew');

  const modal = el('modal');
  const modalTitle = el('modalTitle');
  const modalClose = el('modalClose');
  const btnCancel = el('btnCancel');
  const btnSave = el('btnSave');

  const fDate = el('fDate');
  const fStart = el('fStart');
  const fEnd = el('fEnd');
  const fLink = el('fLink');
  const fTitle = el('fTitle');
  const formError = el('formError');

  const onlyMine = el('onlyMine');
  const searchInput = el('searchInput');
  const tzInfo = el('tzInfo');

  const trainingModal = el('trainingModal');
  const trainingModalClose = el('trainingModalClose');
  const trainingModalBody = el('trainingModalBody');

  const ruMonths = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];

  const now = new Date();
  const saved = JSON.parse(localStorage.getItem('trainings_month_v2') || 'null');
  const state = {
    y: saved?.y ?? now.getFullYear(),
    m: saved?.m ?? now.getMonth(),
    data: [],
    filterMine: false,
    search: ''
  };

  function fmt2(n){ return String(n).padStart(2,'0'); }
  function yyyymm(y, m){ return y + '-' + fmt2(m+1); }
  function yyyymmdd(d){ return `${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())}`; }
  function toLocalDateStr(y, m, d){ return y + '-' + fmt2(m+1) + '-' + fmt2(d); }
  function isSameDate(a, b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function clampYear(v){ v = parseInt(v||'',10); if(isNaN(v)) return new Date().getFullYear(); return Math.min(9999, Math.max(1900, v)); }

  function notify(text, type='ok'){
    const host = el('toastHost');
    const box = document.createElement('div');
    box.className = `fade-in pointer-events-auto px-3 py-2 rounded-xl text-sm shadow ${type==='ok' ? 'bg-emerald-600 text-white' : 'bg-rose-600 text-white'}`;
    box.textContent = text;
    host.appendChild(box);
    setTimeout(()=>{ box.style.opacity='0'; box.style.transition='opacity .2s'; }, 2400);
    setTimeout(()=>{ host.removeChild(box); }, 2800);
  }

  function copy(text){ return navigator.clipboard?.writeText(text).then(()=>true).catch(()=>false); }

  function tzString(){
    const z = -new Date().getTimezoneOffset()/60;
    const sign = z>=0?'+':'-';
    return `–í—Ä–µ–º—è –±—Ä–∞—É–∑–µ—Ä–∞ (GMT${sign}${Math.abs(z)})`;
  }
  tzInfo.textContent = tzString();

  // -------- modal create/edit --------
  let editingId = null;
  function openModal(dateStr, initial=null){
    if(!isTrainer) return;
    modal.classList.remove('hidden'); modal.classList.add('flex');
    modalTitle.textContent = initial ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É' : '–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
    editingId = initial ? initial.id : null;

    formError.classList.add('hidden'); formError.textContent = '';
    fDate.value = dateStr || '';
    fStart.value = initial ? initial.start_time : '';
    fEnd.value   = initial ? initial.end_time   : '';
    fLink.value  = initial ? (initial.meeting_link || '') : '';
    fTitle.value = initial ? (initial.title || '') : '';
    btnSave.disabled = false;
  }
  function closeModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); editingId = null; }

  modalClose?.addEventListener('click', closeModal);
  btnCancel?.addEventListener('click', closeModal);
  btnNew?.addEventListener('click', () => openModal(yyyymmdd(new Date(state.y, state.m, new Date().getDate()))));
  fabNew?.addEventListener('click', () => openModal(yyyymmdd(new Date(state.y, state.m, new Date().getDate()))));

  btnSave.addEventListener('click', async () => {
    const payload = {
      date: fDate.value,
      start_time: fStart.value,
      end_time: fEnd.value,
      meeting_link: fLink.value.trim(),
      title: (fTitle.value || '').trim()
    };

    const err = [];
    if(!payload.date) err.push('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É');
    if(!payload.start_time) err.push('–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞');
    if(!payload.end_time) err.push('–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è');
    if(!/^https?:\/\//i.test(payload.meeting_link)) err.push('–°—Å—ã–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http(s)://');
    if(err.length){
      formError.textContent = err.join('. ');
      formError.classList.remove('hidden');
      return;
    }
    formError.classList.add('hidden'); formError.textContent = '';
    btnSave.disabled = true; const restoreText = btnSave.textContent; btnSave.textContent = editingId ? '–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶' : '–°–æ–∑–¥–∞—é‚Ä¶';

    try{
      const r = await fetch(editingId ? `/api/trainings/${editingId}` : '/api/trainings', {
        method: editingId ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const ok = r.ok;
      const j = await r.json().catch(()=>({}));
      if(!ok) throw new Error(j?.message || j?.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      closeModal();
      notify(editingId ? '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞' : '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞');
      await Promise.all([loadMonth(true), loadMine()]);
    }catch(e){
      formError.textContent = e.message || String(e);
      formError.classList.remove('hidden');
    }finally{
      btnSave.disabled = false; btnSave.textContent = restoreText;
    }
  });

  // -------- ICS --------
  function toICSDate(dateStr, timeStr){
    const [y,m,d] = dateStr.split('-').map(Number);
    const [hh,mm] = timeStr.split(':').map(Number);
    return `${y}${fmt2(m)}${fmt2(d)}T${fmt2(hh)}${fmt2(mm)}00`;
  }
  function downloadICS(t){
    const uid = `training-${t.id || Math.random().toString(36).slice(2)}@kilogr`;
    const dtStart = toICSDate(t.date, t.start_time);
    const dtEnd = toICSDate(t.date, t.end_time);
    const title = `${t.title || '–û–Ω–ª–∞–π–Ω-—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'} (${t.trainer_name})`;
    const desc = `–°—Å—ã–ª–∫–∞: ${t.meeting_link}`;
    const host = (()=>{ try{ return new URL(t.meeting_link).hostname; }catch(_e){ return 'online'; }})();
    const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Kilogr.app//Trainings//EN
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtStart}Z
DTSTART:${dtStart}
DTEND:${dtEnd}
SUMMARY:${title}
DESCRIPTION:${desc}
LOCATION:${host}
END:VEVENT
END:VCALENDAR`;
    const blob = new Blob([ics], {type: 'text/calendar;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `training_${t.date}_${t.start_time}.ics`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
  }

  // -------- –∑–∞–≥—Ä—É–∑–∫–∞ --------
  async function loadMonth(animateDirection){
    const r = await fetch(`/api/trainings?month=${yyyymm(state.y, state.m)}`);
    const j = await r.json().catch(()=>({}));
    state.data = Array.isArray(j?.data) ? j.data : [];
    renderGrid(animateDirection);
  }
  async function loadMine(){
    if(!isTrainer){
      myList.innerHTML = '<div class="p-4 text-gray-400 text-sm">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Äî –≤—ã –Ω–µ —Ç—Ä–µ–Ω–µ—Ä</div>';
      return;
    }
    const r = await fetch('/api/trainings/mine');
    const j = await r.json().catch(()=>({}));
    const items = Array.isArray(j?.data) ? j.data : [];
    if(items.length === 0){
      myList.innerHTML = `
        <div class="p-8 text-center text-gray-500">
          <div class="text-3xl mb-2">üóìÔ∏è</div>
          <div class="font-medium">–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
          <div class="text-sm">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é ‚Äî –æ–Ω–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.</div>
        </div>`;
      return;
    }
    myList.innerHTML = items.map(t => {
      const host = (()=>{ try{ return new URL(t.meeting_link).hostname; }catch(_e){ return '—Å—Å—ã–ª–∫–∞'; }})();
      return `
      <div class="p-4 flex items-start gap-3 group">
        <div class="shrink-0 mt-0.5 text-indigo-600"><i class="bi bi-broadcast-pin"></i></div>
        <div class="flex-1 min-w-0">
          <div class="text-sm font-semibold">${t.date} ¬∑ ${t.start_time}‚Äì${t.end_time}</div>
          <div class="text-sm text-gray-700 truncate">${t.title || '–û–Ω–ª–∞–π–Ω-—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'} ‚Äî ${t.trainer_name}</div>
          <a href="${t.meeting_link}" target="_blank" rel="noopener" class="text-xs text-indigo-600 hover:underline truncate">${host}</a>
          <div class="mt-2 flex items-center gap-2 opacity-100">
            <button data-edit="${t.id}" class="px-2 py-1 text-xs rounded-lg border hover:bg-black/5"><i class="bi bi-pencil"></i> –ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button data-ics="${t.id}" class="px-2 py-1 text-xs rounded-lg border hover:bg-black/5"><i class="bi bi-calendar-plus"></i> .ics</button>
            <button data-del="${t.id}" class="px-2 py-1 text-xs rounded-lg border border-rose-300 text-rose-600 hover:bg-rose-50"><i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      </div>`;
    }).join('');

    const itemsMap = Object.fromEntries(items.map(x=>[String(x.id), x]));
    myList.querySelectorAll('[data-edit]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const t = itemsMap[String(btn.getAttribute('data-edit'))];
        openModal(t.date, t);
      });
    });
    myList.querySelectorAll('[data-ics]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const t = itemsMap[String(btn.getAttribute('data-ics'))];
        downloadICS(t);
      });
    });
    myList.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-del');
        if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')) return;
        const r = await fetch(`/api/trainings/${id}`, { method:'DELETE' });
        if(r.ok){ await Promise.all([loadMonth(), loadMine()]); notify('–£–¥–∞–ª–µ–Ω–æ'); } else { notify('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å','err'); }
      });
    });
  }

  // -------- —Ä–µ–Ω–¥–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–µ–≤—å—é) --------
  function monthHeader(){
    monthLabel.textContent = `${ruMonths[state.m]} ${state.y}`;
    monthSelect.value = String(state.m);
    yearInput.value = String(state.y);
  }

  function filteredData(){
    const q = (state.search || '').trim().toLowerCase();
    return state.data.filter(t => {
      if(state.filterMine && !t.mine) return false;
      const hay = `${t.trainer_name||''} ${t.title||''}`.toLowerCase();
      if(q && !hay.includes(q)) return false;
      return true;
    });
  }

  function renderGrid(animateDirection){
    monthHeader();
    const data = filteredData();

    const byDate = {};
    for(const t of data){ (byDate[t.date] ||= []).push(t); }
    for(const k in byDate){ byDate[k].sort((a,b)=> a.start_time.localeCompare(b.start_time)); }

    const first = new Date(state.y, state.m, 1);
    const last = new Date(state.y, state.m+1, 0);
    const startWeekDay = (first.getDay()+6)%7; // 0..6, 0=–ü–Ω
    const totalCells = startWeekDay + last.getDate();
    const weeks = Math.ceil(totalCells / 7);
    const cells = Math.max(42, weeks*7);

    grid.innerHTML = '';
    if(animateDirection === 'left') grid.classList.add('grid-animate-left');
    if(animateDirection === 'right') grid.classList.add('grid-animate-right');
    setTimeout(()=>{ grid.classList.remove('grid-animate-left','grid-animate-right'); }, 190);

    for(let i=0; i<cells; i++){
      const cell = document.createElement('div');
      cell.className = 'calendar-cell relative bg-white min-h-[140px] p-2 transition rounded-none';

      const dayNum = i - startWeekDay + 1;
      if(dayNum < 1 || dayNum > last.getDate()){
        cell.classList.add('bg-gray-50');
        grid.appendChild(cell);
        continue;
      }

      const dateStr = toLocalDateStr(state.y, state.m, dayNum);
      const dateObj = new Date(state.y, state.m, dayNum);

      const w = (dateObj.getDay()+6)%7;
      const isWeekend = [5,6].includes(w);
      const isToday = isSameDate(dateObj, new Date());
      if(isWeekend) cell.classList.add('bg-rose-50/40');
      if(isToday) cell.classList.add('ring-2','ring-indigo-300');

      // –•–µ–¥–µ—Ä –¥–Ω—è
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between mb-2';
      const dn = document.createElement('div');
      dn.className = 'day-badge inline-flex items-center justify-center w-7 h-7 text-sm font-semibold rounded-full transition ' + (isToday ? 'bg-indigo-600 text-white' : 'bg-black/5 text-gray-700');
      dn.textContent = dayNum;
      header.appendChild(dn);

      if(isTrainer){
        const plus = document.createElement('button');
        plus.className = 'p-1.5 rounded-lg text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 transition';
        plus.title = '–°–æ–∑–¥–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É';
        plus.innerHTML = '<i class="bi bi-plus-circle"></i>';
        plus.addEventListener('click', () => openModal(dateStr));
        header.appendChild(plus);
      }
      cell.appendChild(header);

      // –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–µ–≤—å—é)
      const list = document.createElement('div');
      list.className = 'space-y-1 max-h-40 overflow-auto pr-1';
      const items = byDate[dateStr] || [];

      if(items.length === 0){
        const empty = document.createElement('div');
        empty.className = 'text-[11px] text-gray-400 select-none';
        empty.textContent = '–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫';
        list.appendChild(empty);
      }

      for(const t of items){
        const wrap = document.createElement('div');
        wrap.className = 'pill group rounded-xl border flex flex-col gap-1 px-2 py-1 text-xs ' +
          (t.mine ? 'bg-indigo-50 border-indigo-200' : 'bg-gray-50 border-gray-200');

        // —Å—Ç—Ä–æ–∫–∞ 1: –≤—Ä–µ–º—è + —Ç—Ä–µ–Ω–µ—Ä
        const row1 = document.createElement('div');
        row1.className = 'flex items-center justify-between gap-2';
        row1.innerHTML = `<span class="font-medium">${t.start_time}‚Äì${t.end_time}</span>
                          <span class="truncate text-gray-700">${t.trainer_name}</span>`;
        wrap.appendChild(row1);

        // —Å—Ç—Ä–æ–∫–∞ 2: –Ω–∞–∑–≤–∞–Ω–∏–µ
        const row2 = document.createElement('div');
        row2.className = 'truncate text-gray-600';
        row2.textContent = t.title || '–û–Ω–ª–∞–π–Ω-—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
        wrap.appendChild(row2);

        // —Å—Ç—Ä–æ–∫–∞ 3: –æ–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞ ‚Äî ¬´–ü–æ–¥—Ä–æ–±–Ω–µ–µ¬ª (–≤—Å–µ –¥–µ—Ç–∞–ª–∏ –≤ –º–æ–¥–∞–ª–∫–µ)
        const row3 = document.createElement('div');
        row3.className = 'flex items-center justify-end';
        const btn = document.createElement('button');
        btn.className = 'px-2 py-1 rounded-lg border text-indigo-700 border-indigo-300 hover:bg-indigo-50';
        btn.textContent = '–ü–æ–¥—Ä–æ–±–Ω–µ–µ';
        btn.addEventListener('click', ()=> openTrainingModal(t));
        row3.appendChild(btn);
        wrap.appendChild(row3);

        list.appendChild(wrap);
      }

      cell.appendChild(list);

      // –¥–∞–±–ª–∫–ª–∏–∫ ‚Äî –±—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ —Ç—Ä–µ–Ω–µ—Ä—É)
      if(isTrainer){
        cell.addEventListener('dblclick', ()=>{
          const startH = 19;
          openModal(dateStr, {start_time:`${fmt2(startH)}:00`, end_time:`${fmt2(startH+1)}:00`, meeting_link:''});
          editingId = null;
        });
      }

      grid.appendChild(cell);
    }
  }

  // -------- –º–æ–¥–∞–ª–∫–∞ –¥–µ—Ç–∞–ª–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ --------
  function openTrainingModal(t){
    const host = (()=>{ try{ return new URL(t.meeting_link).hostname; }catch(_e){ return ''; }})();
    trainingModalBody.innerHTML = `
      <div class="space-y-2">
        <div class="text-sm text-gray-500">${t.date}</div>
        <div class="text-base font-semibold">${t.title || '–û–Ω–ª–∞–π–Ω-—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'}</div>
        <div class="text-sm">–¢—Ä–µ–Ω–µ—Ä: <span class="font-medium">${t.trainer_name}</span></div>
        <div class="text-sm">–í—Ä–µ–º—è: <span class="font-medium">${t.start_time}‚Äì${t.end_time}</span></div>
        <div class="pt-2 flex items-center justify-between gap-3">
          ${t.meeting_link
            ? `<a href="${t.meeting_link}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
                 <i class="bi bi-box-arrow-up-right"></i> –ü–µ—Ä–µ–π—Ç–∏
               </a>`
            : `<span class="text-sm text-gray-500">–°—Å—ã–ª–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–∑–∂–µ</span>`
          }
          <div class="flex items-center gap-2">
            <button id="btnCopyLink" class="px-2 py-1 rounded-lg border hover:bg-black/5" ${t.meeting_link ? '' : 'disabled'}><i class="bi bi-clipboard"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="btnICS" class="px-2 py-1 rounded-lg border hover:bg-black/5"><i class="bi bi-calendar-plus"></i> .ics</button>
            ${isTrainer && t.mine
              ? `<button id="btnEdit" class="px-2 py-1 rounded-lg border hover:bg-black/5"><i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                 <button id="btnDel" class="px-2 py-1 rounded-lg border border-rose-300 text-rose-600 hover:bg-rose-50"><i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å</button>`
              : ''
            }
          </div>
        </div>
      </div>
    `;
    // –ø—Ä–∏–≤—è–∑–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π
    trainingModalBody.querySelector('#btnICS')?.addEventListener('click', ()=> downloadICS(t));
    trainingModalBody.querySelector('#btnCopyLink')?.addEventListener('click', async ()=>{
      const ok = await copy(t.meeting_link||''); notify(ok ? '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', ok?'ok':'err');
    });
    if(isTrainer && t.mine){
      trainingModalBody.querySelector('#btnEdit')?.addEventListener('click', ()=>{ showModal(trainingModal,false); openModal(t.date, t); });
      trainingModalBody.querySelector('#btnDel')?.addEventListener('click', async ()=>{
        if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')) return;
        const r = await fetch(`/api/trainings/${t.id}`, { method:'DELETE' });
        if(r.ok){ showModal(trainingModal,false); await Promise.all([loadMonth(), loadMine()]); notify('–£–¥–∞–ª–µ–Ω–æ'); } else { notify('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å','err'); }
      });
    }
    showModal(trainingModal, true);
  }

  // ---- helpers –¥–ª—è –º–æ–¥–∞–ª–æ–∫ ----
  function showModal(node, yes){ if(yes){ node.classList.add('show'); } else { node.classList.remove('show'); } }
  trainingModalClose.addEventListener('click', ()=> showModal(trainingModal,false));
  trainingModal.addEventListener('click', e=>{ if(e.target === trainingModal) showModal(trainingModal,false); });
  document.addEventListener('keydown', e=>{ if(e.key === 'Escape') showModal(trainingModal,false); });

  // -------- –Ω–∞–≤–∏–≥–∞—Ü–∏—è --------
  function saveMonth(){ localStorage.setItem('trainings_month_v2', JSON.stringify({y: state.y, m: state.m})); }
  async function goPrev(){ if(state.m===0){ state.m=11; state.y--; } else state.m--; saveMonth(); await loadMonth('right'); }
  async function goNext(){ if(state.m===11){ state.m=0; state.y++; } else state.m++; saveMonth(); await loadMonth('left'); }
  async function goToday(){ const d=new Date(); state.y=d.getFullYear(); state.m=d.getMonth(); saveMonth(); await loadMonth(); }

  btnPrev.addEventListener('click', goPrev);
  btnNext.addEventListener('click', goNext);
  btnToday.addEventListener('click', goToday);
  monthSelect.addEventListener('change', async (e)=>{ state.m = parseInt(e.target.value,10); saveMonth(); await loadMonth(); });
  yearInput.addEventListener('change', async (e)=>{ state.y = clampYear(e.target.value); saveMonth(); await loadMonth(); });

  // –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
  document.addEventListener('keydown', (e)=>{
    if(e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
    if(e.key==='ArrowLeft'){ e.preventDefault(); goPrev(); }
    if(e.key==='ArrowRight'){ e.preventDefault(); goNext(); }
    if(e.key.toLowerCase()==='t'){ e.preventDefault(); goToday(); }
    if(e.key.toLowerCase()==='n' && isTrainer){ e.preventDefault(); openModal(yyyymmdd(new Date(state.y, state.m, new Date().getDate())), null); }
  });

  // —Ñ–∏–ª—å—Ç—Ä—ã
  onlyMine.addEventListener('change', ()=>{ state.filterMine = !!onlyMine.checked; renderGrid(); });
  searchInput.addEventListener('input', ()=>{ state.search = searchInput.value; renderGrid(); });

  // –∑–∞–≥—Ä—É–∑–∫–∞
  async function refresh(){ await Promise.all([loadMonth(), loadMine()]); }
  refresh();
})();
</script>
{% endblock %}

