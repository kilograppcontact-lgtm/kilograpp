<!doctype html>
<html lang="ru" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <title>Заявки на подписку — Админ-панель</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    /* Липкая шапка таблицы */
    .sticky-thead th { position: sticky; top: 0; z-index: 2; }
    .table-hover tbody tr:hover { background: rgba(33,37,41,.03); }
    .table-striped>tbody>tr:nth-of-type(odd)>* { background: rgba(33,37,41,.02); }

    /* Мягкие подложки для статусов */
    .row-pending td { border-top: 1px solid #ffe8a1; }
    .row-processed td { border-top: 1px solid #badbcc; }

    /* Карточки на мобильных */
    @media (max-width: 767.98px) {
      .desktop-only { display:none !important; }
    }
    @media (min-width: 768px) {
      .mobile-only { display:none !important; }
    }

    /* Шапка страницы */
    .page-header { gap: .75rem; }
    .badge-pill { border-radius: 999px; }

    /* Небольшой «ритм» */
    .card { border: 0; }
    .section-divider {
      background: var(--bs-light);
      font-weight: 600;
      color: var(--bs-dark);
    }
  </style>
</head>
<body>

  <div class="container py-4">

    <!-- Хлебные крошки -->
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item">
          <a href="{{ url_for('admin_dashboard') }}"><i class="bi bi-speedometer2 me-1"></i>Админ-панель</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">Заявки на подписку</li>
      </ol>
    </nav>

    {% set pending_count = applications | selectattr('status', 'equalto', 'pending') | list | length %}

    <!-- Заголовок + фильтры -->
    <div class="d-flex flex-wrap align-items-center justify-content-between page-header mb-3">
      <div class="d-flex align-items-center gap-2">
        <h3 class="mb-0 fw-semibold"><i class="bi bi-inbox-fill me-2"></i>Заявки на подписку</h3>
        {% if pending_count > 0 %}
          <span class="badge bg-warning text-dark badge-pill">{{ pending_count }} в ожидании</span>
        {% endif %}
      </div>

      <div class="d-flex align-items-center gap-2">
        <!-- Фильтр по статусу -->
        <div class="input-group">
          <label class="input-group-text" for="statusFilter"><i class="bi bi-funnel"></i></label>
          <select id="statusFilter" class="form-select">
            <option value="all" selected>Все статусы</option>
            <option value="pending">В ожидании</option>
            <option value="processed">Обработана</option>
          </select>
        </div>
        <!-- Поиск -->
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input id="searchInput" type="search" class="form-control" placeholder="Поиск: имя, email, телефон, ID…">
        </div>
      </div>
    </div>

    <!-- Flash-сообщения (если используешь flash) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'warning' if category=='error' else category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- ======= TABLE DESKTOP ======= -->
    <div class="card desktop-only shadow-sm">
      <div class="table-responsive">
        {% if applications %}
        <table class="table table-hover table-striped align-middle mb-0">
          <thead class="table-light sticky-thead">
            <tr>
              <th class="ps-3">ID</th>
              <th>Дата</th>
              <th>Пользователь</th>
              <th>Телефон</th>
              <th>Статус</th>
              <th class="pe-3 text-end" style="min-width: 240px;">Действие</th>
            </tr>
          </thead>
          <tbody id="appsTableBody">
            {% set current_section = None %}
            {% for app in applications %}
              {# Вставляем разделитель при смене статуса (учитывая сортировку status.asc) #}
              {% if app.status != current_section %}
                <tr class="section-divider">
                  <td colspan="6" class="ps-3">
                    {% if app.status == 'pending' %}В ожидании{% else %}Обработаны{% endif %}
                  </td>
                </tr>
                {% set current_section = app.status %}
              {% endif %}

              <tr class="app-row {% if app.status=='pending' %}row-pending{% else %}row-processed{% endif %}"
                  data-status="{{ app.status|e }}">
                <td class="ps-3"><span class="fw-semibold">#{{ app.id }}</span></td>

                <td>
                  {% if app.created_at %}
                    <span class="text-nowrap">
                      <i class="bi bi-calendar3 me-1 text-muted"></i>
                      {{ app.created_at.strftime('%d.%m.%Y %H:%M') }}
                    </span>
                  {% endif %}
                </td>

                <td>
                  {% if app.user %}
                    <div class="fw-semibold">
                      <a href="{{ url_for('admin_user_detail', user_id=app.user.id) }}" class="text-decoration-none">
                        <i class="bi bi-person-circle me-1"></i>{{ app.user.name }}
                      </a>
                    </div>
                    <div class="small text-muted">
                      <a href="mailto:{{ app.user.email }}" class="text-muted text-decoration-none">
                        <i class="bi bi-envelope-fill me-1"></i>{{ app.user.email }}
                      </a>
                    </div>
                  {% else %}
                    <span class="text-danger"><i class="bi bi-person-x-fill me-1"></i>Пользователь не найден</span>
                  {% endif %}
                </td>

                <td>
                  {% if app.phone_number %}
                    <div class="d-flex align-items-center gap-2">
                      <a href="tel:{{ app.phone_number }}" class="text-decoration-none">
                        <i class="bi bi-telephone-fill me-1"></i>{{ app.phone_number }}
                      </a>
                      <button type="button" class="btn btn-light btn-sm py-0 px-2 copy-btn"
                              data-copy="{{ app.phone_number }}" title="Скопировать">
                        <i class="bi bi-clipboard"></i>
                      </button>
                    </div>
                  {% endif %}
                </td>

                <td>
                  {% if app.status == 'pending' %}
                    <span class="badge bg-warning text-dark badge-pill">
                      <i class="bi bi-clock-history me-1"></i>В ожидании
                    </span>
                  {% else %}
                    <span class="badge bg-success badge-pill">
                      <i class="bi bi-check-circle-fill me-1"></i>Обработана
                    </span>
                  {% endif %}
                </td>

                <td class="pe-3 text-end">
                  <form action="{{ url_for('admin_update_application_status', app_id=app.id) }}"
                        method="POST" class="d-inline-flex gap-2 justify-content-end">
                    <select name="status" class="form-select form-select-sm w-auto" aria-label="Изменить статус">
                      <option value="pending"   {% if app.status == 'pending' %}selected{% endif %}>В ожидании</option>
                      <option value="processed" {% if app.status == 'processed' %}selected{% endif %}>Обработана</option>
                    </select>
                    <button type="submit" class="btn btn-sm btn-primary">
                      <i class="bi bi-save me-1"></i>Сохранить
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
          <div class="p-5 text-center">
            <i class="bi bi-inbox" style="font-size:3.5rem; opacity:.25;"></i>
            <h5 class="mt-3 mb-1">Нет заявок</h5>
            <p class="text-muted mb-0">Новые заявки появятся здесь автоматически.</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- ======= CARDS MOBILE ======= -->
    {% if applications %}
    <div class="mobile-only d-grid gap-3">
      {% set current_section_m = None %}
      {% for app in applications %}
        {% if app.status != current_section_m %}
          <div class="alert section-divider py-2 mb-0">
            {% if app.status == 'pending' %}В ожидании{% else %}Обработаны{% endif %}
          </div>
          {% set current_section_m = app.status %}
        {% endif %}

        <div class="card shadow-sm app-card" data-status="{{ app.status|e }}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="text-muted small">ID</div>
                <div class="fw-semibold">#{{ app.id }}</div>
              </div>
              <div>
                {% if app.status == 'pending' %}
                  <span class="badge bg-warning text-dark"><i class="bi bi-clock-history me-1"></i>В ожидании</span>
                {% else %}
                  <span class="badge bg-success"><i class="bi bi-check-circle-fill me-1"></i>Обработана</span>
                {% endif %}
              </div>
            </div>

            <hr class="my-3">

            <div class="mb-2">
              <div class="text-muted small">Дата</div>
              <div class="text-nowrap">
                {% if app.created_at %}
<i class="bi bi-calendar3 me-1"></i>{{ app.created_at.strftime('%d.%m.%Y %H:%M') }}
                {% endif %}
              </div>
            </div>

            <div class="mb-2">
              <div class="text-muted small">Пользователь</div>
              {% if app.user %}
                <div class="fw-semibold">
                  <a class="text-decoration-none" href="{{ url_for('admin_user_detail', user_id=app.user.id) }}">
                    <i class="bi bi-person-circle me-1"></i>{{ app.user.name }}
                  </a>
                </div>
                <div class="small">
                  <a href="mailto:{{ app.user.email }}" class="text-muted text-decoration-none">
                    <i class="bi bi-envelope-fill me-1"></i>{{ app.user.email }}
                  </a>
                </div>
              {% else %}
                <span class="text-danger"><i class="bi bi-person-x-fill me-1"></i>Пользователь не найден</span>
              {% endif %}
            </div>

            <div class="mb-3">
              <div class="text-muted small">Телефон</div>
              {% if app.phone_number %}
                <div class="d-flex align-items-center gap-2">
                  <a href="tel:{{ app.phone_number }}" class="text-decoration-none">
                    <i class="bi bi-telephone-fill me-1"></i>{{ app.phone_number }}
                  </a>
                  <button type="button" class="btn btn-light btn-sm py-0 px-2 copy-btn"
                          data-copy="{{ app.phone_number }}" title="Скопировать">
                    <i class="bi bi-clipboard"></i>
                  </button>
                </div>
              {% endif %}
            </div>

            <form action="{{ url_for('admin_update_application_status', app_id=app.id) }}"
                  method="POST" class="d-flex gap-2">
              <select name="status" class="form-select form-select-sm">
                <option value="pending"   {% if app.status == 'pending' %}selected{% endif %}>В ожидании</option>
                <option value="processed" {% if app.status == 'processed' %}selected{% endif %}>Обработана</option>
              </select>
              <button type="submit" class="btn btn-sm btn-primary w-auto">
                <i class="bi bi-save me-1"></i>Сохранить
              </button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
    {% endif %}

  </div><!-- /container -->

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      const searchInput   = document.getElementById('searchInput');
      const statusFilter  = document.getElementById('statusFilter');
      const tableRows     = Array.from(document.querySelectorAll('.app-row'));
      const cards         = Array.from(document.querySelectorAll('.app-card'));

      function visible(el, ok){ el.style.display = ok ? '' : 'none'; }
      function match(text, q){ return text.toLowerCase().includes(q); }

      function applyFilters() {
        const q = (searchInput?.value || '').trim().toLowerCase();
        const status = statusFilter?.value || 'all';

        const predicate = (el) => {
          const currentStatus = el.getAttribute('data-status') || '';
          const statusOk = (status === 'all') || (currentStatus === status);
          if (!q) return statusOk;
          const txt = el.textContent || '';
          return statusOk && match(txt, q);
        };

        tableRows.forEach(el => visible(el, predicate(el)));
        cards.forEach(el => visible(el, predicate(el)));

        // Скрывать/показывать разделители секций по необходимости на мобильных не требуется — они читаются как alerts
      }

      searchInput && searchInput.addEventListener('input', applyFilters);
      statusFilter && statusFilter.addEventListener('change', applyFilters);
      applyFilters();

      // Копирование телефона
      document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const v = btn.getAttribute('data-copy');
          try {
            await navigator.clipboard.writeText(v);
            const old = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-clipboard-check"></i>';
            setTimeout(() => btn.innerHTML = old, 1200);
          } catch(e) {}
        });
      });
    })();
  </script>
</body>
</html>
