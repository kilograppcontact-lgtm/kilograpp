{% extends 'base.html' %}
{% block content %}

{% if just_activated %}
<div id="subscriptionPopupOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div id="subscriptionPopupContent" class="card w-full max-w-lg p-6 sm:p-8 relative text-center animate-fade-in">

        <button onclick="closeSubscriptionPopup()" class="absolute top-4 right-4 text-slate-400 text-2xl hover:text-slate-600 transition-colors">&times;</button>

        <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-gradient-to-br from-green-400 to-blue-500 mb-5 shadow-lg">
            <span class="text-4xl text-white">üéâ</span>
        </div>

        <h2 class="text-2xl font-bold text-slate-900">–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!</h2>
        <p class="text-slate-600 mt-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π! –¢–µ–ø–µ—Ä—å –≤–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏, –≤–∫–ª—é—á–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∏–µ—Ç –∏ –≥–ª—É–±–æ–∫—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É.</p>

        <div class="mt-8 flex flex-col sm:flex-row gap-3 justify-center">
    <button onclick="closeSubscriptionPopup()" class="btn btn-primary">
        üöÄ –ù–∞—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
    </button>
    <a href="{{ url_for('welcome_guide') }}" class="btn btn-secondary">
        ü§î –ß—Ç–æ —è –ø–æ–ª—É—á–∏–ª?
    </a>
</div>
    </div>
</div>

<style>
  /* –≠—Ñ—Ñ–µ–∫—Ç ¬´–∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ¬ª + —Å–æ—Ö—Ä–∞–Ω—è–µ–º is-flipped */
  .flip-card{ perspective:1200px; transition:transform .4s ease; }
  .flip-card:hover{ transform:scale(1.03); }

  .flip-card-inner{
    transition: transform 1s ease;
    transform-style: preserve-3d;
    position: relative; width:100%; height:100%;
  }
  .flip-card.is-flipped .flip-card-inner{ transform: rotateY(180deg); }

  .flip-card-front, .flip-card-back{
    backface-visibility: hidden; -webkit-backface-visibility: hidden;
    position:absolute; inset:0; padding:1.5rem; border-radius:1.25rem;
    display:flex; flex-direction:column; justify-content:space-between;
    overflow:hidden;
    /* —Å–æ—á–Ω–∞—è —Ç–µ–Ω—å –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ */
    box-shadow: 0 12px 25px rgba(0,0,0,.20);
  }
  .flip-card-back{ transform: rotateY(180deg); overflow-y:auto; }

/* –°—Ç—Ä–µ–ª–∫–∞ –≤ –í–ï–†–•–ù–ï–ú –ü–†–ê–í–û–ú —É–≥–ª—É, ¬´—Å–º–æ—Ç—Ä–∏—Ç¬ª –≤ —É–≥–æ–ª (‚Üó), –∂–∏—Ä–Ω–∞—è */
.click-arrow{
  position:absolute; top: .85rem; right: .85rem;
  font-size: 1.4rem; font-weight: 800;
  transform: rotate(-45deg); /* –∏–∑ ‚Üí –¥–µ–ª–∞–µ–º ‚Üó */
  color: rgba(255,255,255,.55);
  text-shadow: 0 2px 6px rgba(0,0,0,.35);
  user-select: none; pointer-events: none;
  transition: transform .25s ease, color .25s ease, text-shadow .25s ease;
}
/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–∞—Ä—Ç—É */
.flip-card:hover .click-arrow{
  transform: rotate(-45deg) translate(4px,-4px) scale(1.15);
  color: #fff;
  text-shadow: 0 4px 12px rgba(0,0,0,.5);
}
/* –ù–∞ –æ–±–æ—Ä–æ—Ç–µ ‚Äî —Ç—ë–º–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ */
.flip-card-back .click-arrow{
  color: #475569;            /* slate-600 */
  text-shadow: none;
}
.flip-card:hover .flip-card-back .click-arrow{
  color: #0f172a;            /* slate-900 */
}

</style>

<style>
    /* –∫—Ä—É–ø–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤—ã–±–æ—Ä–∞ –ø–æ–ª–∞ */
.selection-card-gender{
  border: 2px solid var(--border-soft);
  border-radius: 0.85rem;
  background:
    radial-gradient(120px 120px at 90% 10%, rgba(59,130,246,.06), transparent 60%),
    linear-gradient(180deg, #fff, #f8fafc);
  transition: border-color .2s ease, transform .2s ease, box-shadow .2s ease, background .3s ease;
}
.selection-card-gender:hover{
  transform: translateY(-2px);
  box-shadow: 0 10px 22px rgba(0,0,0,.08);
  border-color: #cbd5e1; /* slate-300 */
}
.selection-card-gender.selected{
  background:
    radial-gradient(140px 140px at 90% 10%, rgba(59,130,246,.08), transparent 60%),
    linear-gradient(180deg, #ffffff, #f0f9ff);
}

/* ¬´—Ç–µ–ª–µ–≥—Ä–∞–º¬ª-–∞–Ω–∏–º–∞—Ü–∏—è: –ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞–Ω–∏–µ –∏ –≤—Å–ø–ª–µ—Å–∫ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ */
@keyframes tg-pop {
  0%   { transform: scale(1) rotate(0deg); }
  40%  { transform: scale(1.15) rotate(-6deg); }
  70%  { transform: scale(0.97) rotate(3deg); }
  100% { transform: scale(1) rotate(0deg); }
}
@keyframes burst {
  0%   { transform: scale(0); opacity: 0; }
  40%  { transform: scale(1); opacity: 1; }
  100% { transform: scale(1.4); opacity: 0; }
}

/* –∏—Å–∫–æ—Ä–∫–∏ */
.selection-card-gender .burst{
  position: absolute; width: 10px; height: 10px; border-radius: 9999px;
  background: currentColor; opacity: 0; pointer-events: none;
}
.selection-card-gender .b1{ color:#60a5fa; /* blue-400 */ top:0; right:10px; }
.selection-card-gender .b2{ color:#f472b6; /* pink-400 */ bottom:8px; right:0; }
.selection-card-gender .b3{ color:#22c55e; /* green-500 */ top:18px; left:4px; }

/* –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –≤—ã–±—Ä–∞–Ω–∞ */
.selection-card-gender.selected .icon-primary{
  animation: tg-pop .5s ease-out both;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.15));
}
.selection-card-gender.selected .burst{
  animation: burst .6s ease-out both;
}
.selection-card-gender.selected .b2{ animation-delay: .05s; }
.selection-card-gender.selected .b3{ animation-delay: .1s; }

</style>

<script>
    const popupOverlay = document.getElementById('subscriptionPopupOverlay');

   function closeSubscriptionPopup() {
    if (popupOverlay) {
        // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä, —á—Ç–æ–±—ã –æ–Ω "–∑–∞–ø–æ–º–Ω–∏–ª", —á—Ç–æ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ
        fetch('/api/dismiss_welcome_popup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).catch(err => console.error("Failed to dismiss popup on server:", err));

        // 2. –ü–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ, –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ
        popupOverlay.style.transition = 'opacity 0.3s ease';
        popupOverlay.style.opacity = '0';
        setTimeout(() => {
popupOverlay.style.display = 'none';
lockScroll(false);
        }, 300);
    }
}

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    if (popupOverlay) {
        popupOverlay.addEventListener('click', function(event) {
            if (event.target === popupOverlay) {
                closeSubscriptionPopup();
            }
        });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –Ω–∞–∂–∞—Ç–∏—é –Ω–∞ –∫–ª–∞–≤–∏—à—É Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeSubscriptionPopup();
        }
    });
</script>
{% endif %}
<style>
    /* –°—Ç–∏–ª—å –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    .locked-feature {
        position: relative;
        opacity: 0.6;
        filter: grayscale(80%);
        pointer-events: none; /* –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∫–ª–∏–∫–∏ –ø–æ –¥–æ—á–µ—Ä–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–∞–º */
    }
    .locked-overlay {
        position: absolute;
        inset: 0;
        background: rgba(241, 245, 249, 0.7); /* slate-100 —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é */
        border-radius: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 1rem;
        z-index: 10;
        pointer-events: auto; /* –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∏–∫–∏ –¥–ª—è –æ–≤–µ—Ä–ª–µ—è */
    }
    .locked-text {
        font-weight: 600;
        color: #1e293b; /* slate-800 */
    }
    .locked-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .flip-card-back {
  position: relative;
}
.flip-card-back::after{
  content:"";
  position:absolute; left:0; right:0; bottom:0; height:28px;
  pointer-events:none;
  background: linear-gradient(to bottom, rgba(243,244,246,0), rgba(243,244,246,1));
}


    .progress-bar-animate { transition: width 0.5s ease-out; }

  /* –û–±—â–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ */
  .animate-fade-in {
    animation: fadeIn 0.3s ease-out;
  }
  @keyframes fadeIn {
    from {opacity: 0; transform: scale(0.9);}
    to {opacity: 1; transform: scale(1);}
  }

  @media (prefers-reduced-motion: reduce) {
  * { animation: none !important; transition: none !important; }
}


  /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∏—Ä—É—é—â–µ–≥–æ —Ñ–æ–Ω–∞ */
  @keyframes pulse-background {
    0% { opacity: 0; }
    50% { opacity: 0.2; }
    100% { opacity: 0; }
  }
  .animate-pulse-background:hover {
    animation: pulse-background 1.5s infinite;
  }

  /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
  .btn-hover-animate {
    transition: all 0.3s ease;
    transform: translateY(0);
  }
  .btn-hover-animate:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
  .card-hover-animate {
    transition: all 0.3s ease;
  }
  .card-hover-animate:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∫–æ–Ω–æ–∫ */
  .icon-hover-animate {
    transition: transform 0.3s ease;
  }
  .icon-hover-animate:hover {
    transform: scale(1.1);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ */
  .tab-hover-animate {
    transition: all 0.2s ease;
  }
  .tab-hover-animate:hover {
    background-color: rgba(59, 130, 246, 0.1);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—ã */
  .form-input-hover {
    transition: all 0.2s ease;
  }
  .form-input-hover:hover {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞ */
  .list-item-hover {
    transition: all 0.2s ease;
  }
  .list-item-hover:hover {
    background-color: rgba(243, 244, 246, 0.5);
    transform: translateX(2px);
  }

  /* –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –≥—Ä—É–ø–ø—ã */
  .group-card-hover {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .group-card-hover:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Ü–µ–ª–µ–π/–ø–æ–ª–∞ */
  .selection-card {
    transition: all 0.3s ease;
  }
  .selection-card:hover {
    transform: scale(1.03);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
</style>
<style>
  :root {
    --brand-primary: #3b82f6; /* blue-500 */
    --brand-secondary: #6366f1; /* indigo-500 */
    --surface-ground: #f8fafc; /* slate-50 */
    --surface-card: #ffffff;
    --text-primary: #1e293b; /* slate-800 */
    --text-secondary: #64748b; /* slate-500 */
    --border-soft: #e2e8f0; /* slate-200 */
  }

  /* --- Base & Layout --- */
  body {
    background-color: var(--surface-ground);
    color: var(--text-primary);
  }

  .page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1.5rem 1rem;
  }

  /* --- Animations --- */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in {
    animation: fadeIn 0.5s ease-out forwards;
  }

  /* --- Card Component --- */
  .card {
    background-color: var(--surface-card);
    border-radius: 1rem; /* 16px */
    border: 1px solid var(--border-soft);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
    transition: all 0.3s ease-in-out;
  }
  .card:hover {
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
    transform: translateY(-2px);
  }

  /* --- Navigation Tabs --- */
  .nav-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    border-bottom: 1px solid var(--border-soft);
    margin-bottom: 2rem;
  }
  .nav-tab {
    padding: 0.75rem 1rem;
    font-weight: 500;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
  }
  .nav-tab:hover {
    color: var(--brand-primary);
  }
  .nav-tab.active {
    color: var(--brand-primary);
    border-bottom-color: var(--brand-primary);
  }

  /* --- Buttons --- */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 1.25rem;
    border-radius: 0.5rem;
    font-weight: 600;
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }
  .btn-primary {
    background-color: var(--brand-primary);
    color: white;
  }
  .btn-primary:hover {
    background-color: #2563eb; /* blue-600 */
  }
  .btn-secondary {
    background-color: var(--surface-ground);
    color: var(--text-primary);
    border-color: var(--border-soft);
  }
  .btn-secondary:hover {
    background-color: #f1f5f9; /* slate-100 */
    border-color: #cbd5e1; /* slate-300 */
  }

  /* --- Forms --- */
  .form-input {
    width: 100%;
    padding: 0.625rem 0.875rem;
    border: 1px solid var(--border-soft);
    border-radius: 0.5rem;
    background-color: #f8fafc;
    transition: all 0.2s ease;
  }
  .form-input:focus {
    outline: none;
    border-color: var(--brand-primary);
    background-color: white;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
  }
  .selection-card {
    padding: 1rem;
    border: 2px solid var(--border-soft);
    border-radius: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .selection-card:hover {
    border-color: var(--brand-secondary);
    background-color: #f0fdfa; /* light teal for hover */
  }
  .selection-card.selected {
    border-color: var(--brand-primary);
    background-color: #eff6ff; /* light blue */
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
  }

  /* --- Progress Bar --- */
  .progress-bar-bg {
    background-color: #e5e7eb; /* gray-200 */
    border-radius: 9999px;
    height: 0.75rem;
    overflow: hidden;
  }
  .progress-bar-fill {
    background-image: linear-gradient(to right, #fb923c, #f97316); /* orange-400 to orange-500 */
    height: 100%;
    border-radius: 9999px;
    transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1);
  }

.flip-card{
  background-color: transparent;
  width: 100%;
  /* responsive –≤—ã—Å–æ—Ç–∞: –æ—Ç –∫–æ–º–ø–∞–∫—Ç–Ω–æ–π –¥–æ ¬´–∫–∞—Ä—Ç–æ—á–Ω–æ–π¬ª, —Å —É—á—ë—Ç–æ–º —ç–∫—Ä–∞–Ω–∞ */
  height: clamp(220px, 42dvh, 360px);
  perspective: 1000px;
}
@media (max-width: 480px){
  .flip-card{ height: clamp(200px, 50dvh, 340px); }
}
.flip-card-inner{
  position: relative;
  width: 100%;
  height: 100%;
  text-align: center;
  transition: transform .6s;
  transform-style: preserve-3d;
}
.flip-card.is-flipped .flip-card-inner{ transform: rotateY(180deg); }

.flip-card-front, .flip-card-back{
  position:absolute; inset:0;
  -webkit-backface-visibility:hidden; backface-visibility:hidden;
  display:flex; flex-direction:column;
  border-radius:1rem; border:1px solid var(--border-soft);
  overflow:hidden;
}
.flip-card-front{ background-color: var(--surface-card); }
.flip-card-back{
  background-color:#f3f4f6; color:var(--text-primary);
  transform:rotateY(180deg);
  /* –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
  padding: clamp(1rem, 2.2vw, 1.5rem);
  justify-content:flex-start; overflow-y:auto;
}
.flip-card-back::-webkit-scrollbar{ width:6px; }
.flip-card-back::-webkit-scrollbar-track{ background:transparent; }
.flip-card-back::-webkit-scrollbar-thumb{
  background-color:rgba(0,0,0,.2); border-radius:10px; border:3px solid transparent;
}


    /* ==== Telegram attention ==== */
.tg-attn-btn{ position:relative; }
.tg-attn-btn .tg-icon{ font-size:1.35rem; line-height:1; }

.tg-attn-btn:not(.linked) .tg-icon{ color:#0ea5e9; }          /* sky-500 */
.tg-attn-btn.linked        .tg-icon{ color:#10b981; }          /* emerald-500 */

/* –î–≤–æ–π–Ω–∞—è ¬´–º–∞—è–∫¬ª-—Ä—è–±—å */
.tg-ping{
  position:absolute; inset:-2px; border-radius:9999px;
  border:2px solid rgba(14,165,233,.55);
  pointer-events:none;
  animation: tg-pulse-ring 2.2s cubic-bezier(.22,1,.36,1) infinite;
}
.tg-ping--1{ animation-delay: 0s;    }
.tg-ping--2{ animation-delay: .9s;   }

@keyframes tg-pulse-ring{
  0%   { transform:scale(.65); opacity:.9; }
  70%  { transform:scale(1.85); opacity:0; }
  100% { transform:scale(2.05); opacity:0; }
}

/* –ú—è–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ –∫–Ω–æ–ø–∫–∏ */
.tg-attn-btn:not(.linked)::after{
  content:""; position:absolute; inset:-8px; border-radius:9999px;
  box-shadow: 0 0 0 0 rgba(59,130,246,.0);
  animation: tg-glow 1.8s ease-in-out infinite;
}
@keyframes tg-glow{
  0%,100%{ box-shadow: 0 0 0 0 rgba(59,130,246,.0); }
  50%    { box-shadow: 0 0 0 12px rgba(59,130,246,.15); }
}

/* –õ—ë–≥–∫–æ–µ –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ (–Ω–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª—è–µ–º) */
.tg-attn-btn:not(.linked) .tg-icon{
  animation: tg-wiggle 3.2s ease-in-out 1s infinite;
}
@keyframes tg-wiggle{
  0%,100%{ transform:rotate(0); }
  10%    { transform:rotate(-12deg); }
  20%    { transform:rotate(6deg); }
  30%    { transform:rotate(-3deg); }
  40%    { transform:rotate(0); }
}

/* –ë–µ–π–¥–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ */
.tg-check{
  position:absolute; top:-4px; right:-4px;
  background:#10b981; color:#fff; font-weight:800;
  font-size:.66rem; line-height:1; padding:.275rem .4rem;
  border-radius:9999px; box-shadow:0 6px 14px rgba(16,185,129,.35);
}

</style>
<style>
/* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è + —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª + safe-area + dvh */
#tour-box{
  /* —à–∏—Ä–∏–Ω–∞ ¬´—É–ø—Ä—É–≥–∞—è¬ª, –Ω–æ –Ω–µ —à–∏—Ä–µ 420 –∏ –Ω–µ —É–∂–µ 280 */
  max-width: min(420px, 92vw);
  width: auto;
  /* –≤—ã—Å–æ—Ç–∞ —Å —É—á—ë—Ç–æ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –≤—ã—Å–æ—Ç—ã –≤—å—é–ø–æ—Ä—Ç–∞ (iOS/url-–±–∞—Ä/–∫–ª–∞–≤–∞) */
  max-height: min(70dvh, 460px);
  overflow-y: auto;
  overscroll-behavior: contain;
  scrollbar-gutter: stable both-edges;
  overflow-wrap: anywhere;
  padding:
    calc(16px + env(safe-area-inset-top, 0))
    clamp(12px, 2vw, 16px)
    calc(16px + env(safe-area-inset-bottom, 0));
  border-radius: 16px;
  /* –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∫–µ–≥–ª—å, –Ω–æ –±–µ–∑ —Å–∫–∞—á–∫–æ–≤ */
  font-size: clamp(14px, 1.2vw + 12px, 16px);
}
/* –ü–æ–¥—Å–≤–µ—Ç–∫—É –Ω–µ –¥–∞—ë–º ¬´–ø—Ä–∏–ª–µ–ø–ª—è—Ç—å—Å—è¬ª –∫ —Å–∞–º–æ–º—É –∫—Ä–∞—é —ç–∫—Ä–∞–Ω–∞ */
#tour-highlight{
  box-shadow: 0 0 0 8px rgba(99,102,241,.2);
  border-radius: 14px;
}

@media (max-width: 640px){
  #tour-box{
    max-width: calc(100vw - 20px);
    max-height: min(72dvh, 440px);
    border-radius: 14px;
    padding:
      calc(14px + env(safe-area-inset-top, 0))
      clamp(10px, 3vw, 14px)
      calc(14px + env(safe-area-inset-bottom, 0));
  }
}
/* ¬´–Ω–∏–∑–∫–∏–µ¬ª —ç–∫—Ä–∞–Ω—ã ‚Äî —á—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ —Ç–µ–∫—Å—Ç–∞ */
@media (max-height: 560px){
  #tour-box{ font-size: clamp(13px, 1vw + 11px, 15px); }
}

</style>
<style>
/* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–µ–∑ —Ñ–æ–Ω–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
#tour-dim{
  position: fixed; inset: 0;
  pointer-events: none;
  z-index: 9998;
}

/* —á–µ—Ç—ã—Ä–µ –ø–æ–ª–æ—Å—ã –≤–æ–∫—Ä—É–≥ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ */
#tour-dim .dim{
  position: absolute;
  background: rgba(0,0,0,.60);
  backdrop-filter: blur(3px);
  -webkit-backdrop-filter: blur(3px);
}

/* —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –≤—Å—ë —Å–ø—Ä—è—Ç–∞–Ω–æ (JS —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç —Ä–∞–∑–º–µ—Ä—ã) */
#tour-dim .dim-top    { top:0; left:0; width:100vw; height:0; }
#tour-dim .dim-right  { top:0; left:100vw; width:0; height:0; }
#tour-dim .dim-bottom { top:100vh; left:0; width:100vw; height:0; }
#tour-dim .dim-left   { top:0; left:0; width:0; height:0; }

/* —Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è —Ä–∞–º–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ —É —Ç–µ–±—è */
#tour-highlight{
  border: 2px solid #6366f1;
  border-radius: 14px;
  box-shadow: 0 0 0 8px rgba(99,102,241,.2);
  pointer-events: none;
}

  /* –§–∏–æ–ª–µ—Ç–æ–≤–∞—è —Ä–∞–º–∫–∞ –∫–∞–∫ –∏ –±—ã–ª–∞ (–≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã —Ä–∞–¥–∏—É—Å —Å–æ–≤–ø–∞–¥–∞–ª —Å --hole-r) */
  #tour-highlight{
    border: 2px solid #6366f1;
    border-radius: 14px;
    box-shadow: 0 0 0 8px rgba(99,102,241,.2);
    pointer-events: none;
  }
</style>
<style>
.progress-checkpoint {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 1.25rem; /* 20px */
    height: 1.25rem; /* 20px */
    background-color: white;
    border: 2px solid #6366f1; /* indigo-500 */
    border-radius: 9999px;
    z-index: 10;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.625rem; /* 10px */
    font-weight: 700;
    color: #6366f1;
}

.progress-checkpoint .tooltip {
    visibility: hidden;
    width: 140px;
    background-color: #1e293b; /* slate-800 */
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 6px 8px;
    position: absolute;
    z-index: 1;
    bottom: 150%;
    left: 50%;
    margin-left: -70px;
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 0.75rem;
    font-weight: 500;
    pointer-events: none;
}

.progress-checkpoint .tooltip::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #1e293b transparent transparent transparent;
}

.progress-checkpoint:hover .tooltip {
    visibility: visible;
    opacity: 1;
}
</style>

<style>
    /* 1. –î–µ–ª–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–µ—Ç–∫–æ–π, —á—Ç–æ–±—ã –≤—Å–µ —Å–ª–∞–π–¥—ã –±—ã–ª–∏ –≤ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ */
    #infoSlider {
        display: grid;
    }
    /* –ó–∞—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã (—Å–ª–∞–π–¥—ã, –∫–Ω–æ–ø–∫–∏) –∑–∞–Ω–∏–º–∞—Ç—å –æ–¥–Ω—É –∏ —Ç—É –∂–µ –æ–±–ª–∞—Å—Ç—å —Å–µ—Ç–∫–∏ */
    #infoSlider > * {
        grid-area: 1 / 1;
    }

    /* 2. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ —Å–ª–∞–π–¥—ã –ø—Ä–æ–∑—Ä–∞—á–Ω—ã –∏ –Ω–µ–≤–∏–¥–∏–º—ã */
    .slide-item {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ —É–∂–µ –±—ã–ª –≤ –≤–∞—à–∏—Ö –∫–ª–∞—Å—Å–∞—Ö Tailwind, —Ç–µ–ø–µ—Ä—å –æ–Ω –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç */
        /* transition-opacity duration-700 ease-in-out */
    }

    /* 3. –ê–∫—Ç–∏–≤–Ω–æ–º—É —Å–ª–∞–π–¥—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å */
    .slide-item.active {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }
</style>

<style>
    /* –ù–û–í–´–ô, –£–õ–£–ß–®–ï–ù–ù–´–ô –°–¢–ò–õ–¨ –î–õ–Ø –ü–û–î–°–í–ï–¢–ö–ò */
    @keyframes highlight-flash {
        0% {
            /* –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –±–µ–∑ —Ç–µ–Ω–∏, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä */
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            transform: scale(1);
        }
        50% {
            /* –°–µ—Ä–µ–¥–∏–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏–∏: —Ç–µ–Ω—å —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è, –±–ª–æ–∫ —á—É—Ç—å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è */
            box-shadow: 0 0 0 12px rgba(59, 130, 246, 0);
            transform: scale(1.02);
        }
        100% {
            /* –ö–æ–Ω–µ—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: —Ç–µ–Ω—å –∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∏—Å—á–µ–∑–∞—é—Ç */
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            transform: scale(1);
        }
    }
    .flash-highlight {
        /* –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –∫ –∫–ª–∞—Å—Å—É */
        animation: highlight-flash 1.2s ease-out;
    }
</style>
<div class="max-w-7xl mx-auto px-4 py-6">
<div id="profile-notifications" class="space-y-3 mb-4"></div>
<div id="infoSlider" class="relative rounded-xl shadow-lg mb-6 overflow-hidden">

    <div class="slide-item w-full transition-opacity duration-700 ease-in-out">
        <div class="relative bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl p-6 flex items-center min-h-44">
            <div class="flex items-center">
                <div class="hidden sm:block mr-5 text-4xl opacity-80">ü§ñ</div>
                <div>
                    <h3 class="font-bold text-xl">–û—Ü–µ–Ω–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞—à–µ–≥–æ –ò–ò –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ Kilo!</h3>
                    <p class="mt-1 text-white/90">–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ –º–∏—Ä–µ –∑–¥–æ—Ä–æ–≤—å—è –∏ —Ñ–∏—Ç–Ω–µ—Å–∞. –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –µ–¥—É –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.</p>
                    <a href="{{ url_for('ai_instructions_page') }}" class="inline-block mt-3 text-sm font-semibold bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
                        –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="slide-item w-full transition-opacity duration-700 ease-in-out">
        <div class="relative bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl p-6 flex items-center min-h-44">
            <div class="flex items-center">
                <div class="hidden sm:block mr-5 text-4xl opacity-80">‚åöÔ∏è</div>
                <div>
                    <h3 class="font-bold text-xl">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —ç–∫–æ—Å–∏—Å—Ç–µ–º—É Kilogr.app!</h3>
                    <p class="mt-1 text-white/90">–ü–æ–ª—É—á–∏–ª–∏ —Å–≤–æ–∏ —É–º–Ω—ã–µ –≤–µ—Å—ã –∏ —á–∞—Å—ã? –û–Ω–∏ –ø–æ–º–æ–≥—É—Ç –≤–∞–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –¥–æ—Å—Ç–∏–≥–∞—Ç—å —Ü–µ–ª–µ–π –µ—â–µ –±—ã—Å—Ç—Ä–µ–µ.</p>
                    <a href="{{ url_for('devices') }}" class="inline-block mt-3 text-sm font-semibold bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
                        –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ –Ω–∞—à–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="absolute bottom-3 right-5 flex items-center space-x-3">
        <button id="sliderPrevBtn" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–∞–π–¥" class="bg-white/20 hover:bg-white/40 rounded-full w-7 h-7 flex items-center justify-center text-white transition-colors">&larr;</button>
        <div id="sliderDots" class="flex items-center space-x-2">
            </div>
        <button id="sliderNextBtn" aria-label="–°–ª–µ–¥—É—é—â–∏–π —Å–ª–∞–π–¥" class="bg-white/20 hover:bg-white/40 rounded-full w-7 h-7 flex items-center justify-center text-white transition-colors">&rarr;</button>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const slides = document.querySelectorAll('#infoSlider .slide-item');
        const prevBtn = document.getElementById('sliderPrevBtn');
        const nextBtn = document.getElementById('sliderNextBtn');
        const dotsContainer = document.getElementById('sliderDots');
        let currentSlide = 0;
        let slideInterval;

        // –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫–∏-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
        slides.forEach((_, i) => {
            const dot = document.createElement('button');
            dot.classList.add('w-2', 'h-2', 'rounded-full', 'transition-colors');
            dot.setAttribute('aria-label', `–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–∞–π–¥—É ${i + 1}`);
            if (i === 0) {
                dot.classList.add('bg-white');
            } else {
                dot.classList.add('bg-white/50', 'hover:bg-white/75');
            }
            dot.addEventListener('click', () => {
                showSlide(i);
                resetInterval();
            });
            dotsContainer.appendChild(dot);
        });

        const dots = dotsContainer.querySelectorAll('button');

        // –°–¢–ê–õ–û
function showSlide(index) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥—ã: —É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å .active —É –≤—Å–µ—Ö,
    // –∫—Ä–æ–º–µ –Ω—É–∂–Ω–æ–≥–æ
    slides.forEach((slide, i) => {
        slide.classList.toggle('active', i === index);
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏ (–ª–æ–≥–∏–∫–∞ —Ç–∞ –∂–µ)
    dots.forEach((dot, i) => {
        dot.classList.toggle('bg-white', i === index);
        dot.classList.toggle('bg-white/50', i !== index);
    });

    currentSlide = index;
}

        function nextSlide() {
            showSlide((currentSlide + 1) % slides.length);
        }

        function prevSlide() {
            showSlide((currentSlide - 1 + slides.length) % slides.length);
        }

        function startInterval() {
             slideInterval = setInterval(nextSlide, 5000); // –ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        }

        function resetInterval() {
            clearInterval(slideInterval);
            startInterval();
        }

        prevBtn.addEventListener('click', () => {
            prevSlide();
            resetInterval();
        });

        nextBtn.addEventListener('click', () => {
            nextSlide();
            resetInterval();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        showSlide(0);
        startInterval();
    });
</script>
    <div class="flex flex-wrap gap-2 border-b mb-6 overflow-x-auto scrollbar-hide px-1">
    <a href="/profile" id="tab-profile-btn"
       class="px-4 py-2 font-medium {{ 'text-blue-600' if request.path == '/profile' else 'text-gray-500 hover:text-gray-700' }}">
      –ü—Ä–æ—Ñ–∏–ª—å
    </a>

  <a href="/metrics" id="tab-metrics-btn"
       class="px-4 py-2 font-medium {{ 'text-blue-600' if request.path == '/metrics' else 'text-gray-500 hover:text-gray-700' }}">
      –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏
    </a>

<a href="/activity" id="tab-activity-btn"
       class="px-4 py-2 font-medium {{ 'text-blue-600' if request.path == '/activity' else 'text-gray-500 hover:text-gray-700' }}">
      –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    </a>

<a href="/meals" id="tab-diet-btn"
       class="px-4 py-2 font-medium {{ 'text-blue-600' if request.path == '/meals' else 'text-gray-500 hover:text-gray-700' }}">
      –ü—Ä–∏—ë–º—ã –ø–∏—â–∏
    </a>

  </div>

{% if request.path == '/profile' %}
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">

<div class="lg:col-span-1 space-y-6">

<div id="body-measure-card" class="card p-6">
       <div class="relative text-center">
    <div class="absolute top-0 right-0 z-10">
        <button
            onclick="openTelegramModal()"
            title="–ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram"
            aria-label="–ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram"
            class="tg-attn-btn relative p-2 rounded-full hover:bg-slate-100 transition-colors {% if user.telegram_chat_id %}linked{% endif %}">

            <i class="bi bi-telegram tg-icon"></i>

            {% if not user.telegram_chat_id %}
            <span class="tg-ping tg-ping--1"></span>
            <span class="tg-ping tg-ping--2"></span>
            {% else %}
            {% endif %}
        </button>
    </div>


    {% if user.avatar %}
    <img loading="lazy" width="96" height="96"
            src="{{ url_for('serve_file', filename=user.avatar.filename) }}" alt="Avatar"
            class="w-24 h-24 mx-auto rounded-full ring-4 ring-offset-4 ring-blue-200 shadow-lg object-cover">
    {% else %}
    <img loading="lazy" width="96" height="96"
            src="https://www.svgrepo.com/show/452070/user-avatar.svg" alt="Default Avatar"
            class="w-24 h-24 mx-auto rounded-full ring-4 ring-offset-4 ring-gray-200 shadow-lg">
    {% endif %}

    <h2 class="mt-5 text-xl font-bold text-slate-900">{{ user.name }}</h2>
    <p class="text-sm text-slate-500">{{ user.email }}</p>

    {% if user.date_of_birth %}
    <p class="text-sm text-slate-500 mt-1">{{ calculate_age(user.date_of_birth) }} –ª–µ—Ç</p>
    {% endif %}

    <div class="mt-4">
    {% if user.subscription and user.subscription.status == 'active' %}
        <div class="p-4 rounded-lg bg-green-50 border border-green-200">
            <div class="flex items-start gap-4">
                <div class="text-green-500 mt-1">
                    <i class="bi bi-check-circle-fill text-2xl"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-green-800">–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞</h3>
                    {% if user.subscription.end_date %}
                        <p class="text-sm text-green-700">–í—ã –∏–º–µ–µ—Ç–µ –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º –¥–æ {{ user.subscription.end_date.strftime('%d.%m.%Y') }}.</p>
                    {% endif %}
                </div>
            </div>
        </div>

    {% elif user.subscription and user.subscription.status == 'frozen' %}
        <div class="p-4 rounded-lg bg-sky-50 border border-sky-200">
            <div class="flex items-start gap-4">
                <div class="text-sky-500 mt-1">
                    <i class="bi bi-pause-circle-fill text-2xl"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-sky-800">–ü–æ–¥–ø–∏—Å–∫–∞ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞</h3>
                    <p class="text-sm text-sky-700">–í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π –∑–∞–º–æ—Ä–æ–∑–∫–∏: {{ user.subscription.remaining_days_on_freeze }}.</p>
                </div>
            </div>
        </div>

    {% else %}
        <a href="{{ url_for('purchase_page') }}" class="group block p-4 rounded-lg bg-white border-2 border-dashed border-slate-300 hover:border-blue-500 hover:bg-blue-50 transition-all duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="font-semibold text-slate-800 group-hover:text-blue-800">–û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É</h3>
                    <p class="text-sm text-slate-500 group-hover:text-blue-700">–ü–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º</p>
                </div>
                <i class="bi bi-arrow-right-circle text-2xl text-slate-400 group-hover:text-blue-600 group-hover:translate-x-1 transition-transform"></i>
            </div>
        </a>
    {% endif %}
</div>


    <div class="mt-4">
        <button onclick="openEditProfileModal()" class="w-full bg-slate-100 text-slate-700 hover:bg-slate-200 text-sm font-semibold py-2 px-4 rounded-lg transition-colors">
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        </button>
    </div>
</div>

        <hr class="my-5 border-slate-200">

        <div>
            <div class="flex justify-between items-center cursor-pointer" id="metrics-header">
              <h3 class="text-base font-bold text-slate-800">üìä –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
              <button class="flex items-center gap-1 text-sm font-semibold text-blue-600 hover:text-blue-800">
  <span id="metrics-toggle-text">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</span>
  <svg id="metrics-toggle-icon"
       xmlns="http://www.w3.org/2000/svg"
       viewBox="0 0 24 24"
       fill="none"
       stroke="currentColor"
       class="w-5 h-5 transition-transform duration-300 rotate-180">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M19 9l-7 7-7-7"/>
  </svg>
</button>

            </div>

            {% if not latest_analysis %}
            <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–∑–º–µ—Ä—è—Ç—å—Å—è -->
            <div class="mt-4 p-3 rounded-xl border border-amber-200 bg-amber-50 flex items-start gap-3">
              <div class="shrink-0 mt-0.5">
                <i class="bi bi-lightbulb text-amber-600 text-lg"></i>
              </div>
              <div>
                <div class="font-semibold text-amber-800">–ï—â—ë –Ω–µ—Ç –∞–Ω–∞–ª–∏–∑–æ–≤ —Ç–µ–ª–∞</div>
                <div class="text-sm text-amber-700">
                  –ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è ‚Äî —ç—Ç–æ —É–ª—É—á—à–∏—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
                  <a class="underline font-semibold hover:no-underline"
                     href="{{ url_for('instructions_page') }}#scales">–ö–∞–∫ –∏–∑–º–µ—Ä—è—Ç—å?</a>
                </div>
              </div>
            </div>
            {% endif %}

            <div id="metrics-icons-view" class="mt-4 grid grid-cols-3 gap-3 text-center">
              {% set key_metrics = [('weight', '‚öñÔ∏è', '–í–µ—Å'), ('muscle_mass', 'üí™', '–ú—ã—à—Ü—ã'), ('fat_mass', 'üßà', '–ñ–∏—Ä')] %}
              {% for field, icon, label in key_metrics %}
                {% set value = latest_analysis[field] if latest_analysis else '‚Äî' %}
                <div class="p-2 bg-slate-50 rounded-lg border border-slate-200">
                    <div class="text-sm text-slate-500">{{ label }}</div>
                    <div class="text-xl font-bold text-slate-800 mt-1">{{ value|float|round(1) if value is not none else '' }}
</div>
                </div>
              {% endfor %}
            </div>
            <div id="metrics-details-view" class="hidden mt-4 space-y-3">
              {% set metrics = [
                  ('–†–æ—Å—Ç', 'height', 'üìè', '—Å–º',  True), ('–í–µ—Å', 'weight', '‚öñÔ∏è', '–∫–≥',  False),
                  ('–ú—ã—à—Ü—ã', 'muscle_mass', 'üí™', '–∫–≥',  True), ('–ñ–∏—Ä', 'fat_mass', 'üßà', '–∫–≥',  False),
                  ('–í–æ–¥–∞', 'body_water', 'üíß', '%',  True), ('–ú–µ—Ç–∞–±–æ–ª–∏–∑–º', 'metabolism', '‚ö°', '–∫–∫–∞–ª',True),
                  ('–ë–µ–ª–æ–∫', 'protein_percentage', 'ü•ö', '%',  True), ('–í–∏—Å—Ü. –∂–∏—Ä', 'visceral_fat_rating', 'üî•', '',   False),
                  ('–ò–ú–¢', 'bmi', 'üìê', '',   False)
              ] %}
              {% for label, field, icon, unit, good_up in metrics %}
                {% set cur = latest_analysis[field] if latest_analysis else none %}
                {% if cur is not none %}
                  <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                    <div class="flex items-center">
                      <span class="text-xl mr-3">{{ icon }}</span>
                      <div>
                        <div class="font-semibold text-slate-700">{{ label }}</div>
                        <div class="text-xl font-bold text-slate-900">{{ cur|round(1) }}<span class="text-sm font-medium text-slate-400 ml-1">{{ unit }}</span></div>
                      </div>
                    </div>
                    {% set prev = previous_analysis[field] if previous_analysis else none %}
                    {% if prev is not none %}{% set cur_f, prev_f = cur|float, prev|float %}{% set diff = cur_f - prev_f %}{% if diff != 0 %}{% set arrow, is_good = ('‚Üë', good_up) if diff > 0 else ('‚Üì', not good_up) %}<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold {% if is_good %} bg-green-100 text-green-700 {% else %} bg-red-100 text-red-700 {% endif %}">{{ arrow }} {{ diff|abs|round(1) }}{{ unit }}</span>{% endif %}{% endif %}
                  </div>
                {% endif %}
              {% endfor %}
              {% if user.analysis_comment %}<div class="!mt-5 p-4 rounded-lg bg-blue-50 border border-blue-200 text-sm text-blue-800"><strong class="font-semibold">üí¨ AI-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> {{ user.analysis_comment }}</div>{% endif %}
            </div>
            <div class="mt-4">
  <a href="{{ url_for('visualize') }}" class="inline-flex items-center px-5 py-3 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition">
    üé® –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
  </a>
</div>

        </div>
    </div>

<div id="upload-analysis-card" class="card p-6">
    <h3 class="text-lg font-bold text-slate-800 mb-3">–ù–æ–≤—ã–π –∑–∞–º–µ—Ä —Ç–µ–ª–∞</h3>
        <form id="uploadForm" action="/upload_analysis" method="POST" enctype="multipart/form-data">
              <input type="file" name="file" accept=".pdf,.png,.jpg,.jpeg" required class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
              <button type="submit" class="btn btn-primary w-full mt-3">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å</button>
        </form>
    </div>


    {% if not user.telegram_chat_id %}
    <div class="card p-6 bg-blue-50 border-blue-200 text-center">
        <h3 class="font-bold text-blue-800">–ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</h3>
        <p class="text-sm text-blue-700 mt-1 mb-4">–ü—Ä–∏–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –¥–∏–µ—Ç—É –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä—è–º–æ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä.</p>
        <button onclick="openTelegramModal()" class="btn btn-primary w-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4" /></svg>
            –ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram
        </button>
    </div>
    {% endif %}

    <div class="card p-6 relative">
        <div {% if not current_user.has_subscription %}class="locked-feature"{% endif %}>
            <h3 class="text-lg font-bold mb-3 text-slate-800">–°–æ–æ–±—â–µ—Å—Ç–≤–æ</h3>
            {% if user_joined_group %}
              <a href="{{ url_for('group_detail', group_id=user_joined_group.id) }}" class="block p-4 rounded-lg bg-gradient-to-br from-sky-500 to-indigo-500 text-white shadow-lg hover:shadow-xl transition-shadow">
                <span class="font-semibold text-lg">–ú–æ—è –≥—Ä—É–ø–ø–∞: {{ user_joined_group.name }}</span>
                {% if user_joined_group.description %}<p class="text-sm opacity-80 mt-1">{{ user_joined_group.description }}</p>{% endif %}
                <span class="block text-xs mt-3 opacity-90">–ü–µ—Ä–µ–π—Ç–∏ –≤ –≥—Ä—É–ø–ø—É ‚Üí</span>
              </a>
            {% else %}
              <div class="text-center p-4 border-2 border-dashed border-slate-300 rounded-lg">
                <p class="text-slate-600 mb-3">–í—ã –µ—â–µ –Ω–µ –≤ –≥—Ä—É–ø–ø–µ. –ù–∞–π–¥–∏—Ç–µ —Å–≤–æ—é –∫–æ–º–∞–Ω–¥—É!</p>
                <a href="{{ url_for('groups_list') }}" class="btn btn-primary w-full">–í—Å—Ç—É–ø–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å</a>
              </div>
            {% endif %}
        </div>
        {% if not current_user.has_subscription %}
        <div class="locked-overlay">
            <div class="locked-icon">üîí</div>
            <p class="locked-text">–î–æ—Å—Ç—É–ø –∫ –≥—Ä—É–ø–ø–∞–º</p>
            <p class="text-sm text-slate-600 mb-3">–æ—Ç–∫—Ä—ã—Ç –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ</p>
<a href="{{ url_for('purchase_page') }}" class="btn btn-primary btn-sm">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</a>
        </div>
        {% endif %}
    </div>


</div>
    <div class="lg:col-span-2 space-y-6">


     {# --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ü–†–û–ì–†–ï–°–°–ê --- #}
<div id="fat-loss-progress-card" class="card p-6 relative transition-shadow {% if fat_loss_progress %}cursor-pointer hover:shadow-lg{% else %}cursor-help{% endif %}">    {# –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ JS —á–µ—Ä–µ–∑ data-–∞—Ç—Ä–∏–±—É—Ç—ã #}
    {% if fat_loss_progress %}
        <div id="progress-data-container"
     data-initial-kg="{{ fat_loss_progress.initial_kg }}"
     data-goal-kg="{{ fat_loss_progress.goal_kg }}"
     data-analyses='{{ all_analyses_for_progress | tojson | safe }}'>
</div>
    {% endif %}

    <div class="flex justify-between items-center mb-1">
        <h3 class="text-lg font-bold text-slate-800">üî• –ü—Ä–æ–≥—Ä–µ—Å—Å –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è</h3>
        {% if fat_loss_progress %}
        <button onclick="confirmAndResetGoals()" title="–°–±—Ä–æ—Å–∏—Ç—å —Ü–µ–ª–∏ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ" class="text-slate-400 hover:text-red-600 transition-colors p-1 rounded-full">
            <i class="bi bi-arrow-counterclockwise text-lg"></i>
        </button>
        {% endif %}
    </div>

    {% if fat_loss_progress and current_user.has_subscription %}
        <p class="text-sm text-slate-500 mb-5">–í–∞—à –ø—É—Ç—å –æ—Ç —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ –∑–∞–º–µ—Ä–∞ –∫ —Ü–µ–ª–∏.</p>

        <div class="relative pt-6 pb-4">
            <div class="relative h-2.5 bg-slate-200 rounded-full">
                <div class="progress-bar-fill h-full rounded-full" style="width: {{ fat_loss_progress.percentage }}%;"></div>
                <div id="progress-checkpoints" class="absolute top-1/2 left-0 w-full h-full -translate-y-1/2"></div>
            </div>
        </div>

        <div class="flex justify-between items-center mt-2 text-sm font-medium">
            <span class="text-slate-500">–°—Ç–∞—Ä—Ç: {{ fat_loss_progress.initial_kg|round(1) }} –∫–≥</span>
            <span class="font-bold text-orange-600">{{ fat_loss_progress.percentage|round(1) }}%</span>
            <span class="text-slate-500">–¶–µ–ª—å: {{ fat_loss_progress.goal_kg|round(1) }} –∫–≥</span>
        </div>

        <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-3 text-center">
            <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                <div class="text-xs text-slate-500">–°–æ–∂–∂–µ–Ω–æ</div>
                <div class="text-lg font-bold text-green-600">{{ fat_loss_progress.burned_kg|round(2) }} –∫–≥</div>
            </div>
            <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                <div class="text-xs text-slate-500">–û—Å—Ç–∞–ª–æ—Å—å</div>
                <div class="text-lg font-bold text-red-600">{{ (fat_loss_progress.total_to_lose_kg - fat_loss_progress.burned_kg)|round(2) }} –∫–≥</div>
            </div>
            <div class="bg-slate-50 rounded-lg p-3 border border-slate-200 col-span-2 sm:col-span-1">
                <div class="text-xs text-slate-500">–¢–µ–∫—É—â–∏–π –≤–µ—Å –∂–∏—Ä–∞</div>
                <div class="text-lg font-bold text-slate-700">{{ fat_loss_progress.current_kg|round(1) }} –∫–≥</div>
            </div>
        </div>

    {% elif not current_user.has_subscription %}
        <div class="locked-overlay !static rounded-xl mt-4">
             <div class="locked-icon">üî•</div>
             <p class="locked-text">–ü—Ä–æ–≥—Ä–µ—Å—Å –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è</p>
             <p class="text-sm text-slate-600 mb-3">–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ</p>
            <a href="{{ url_for('purchase_page') }}" class="btn btn-primary btn-sm">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</a>
        </div>
    {% else %}
        <div id="start-progress-placeholder" class="text-center py-8 border-2 border-dashed border-slate-200 rounded-xl mt-4">
            <p class="font-semibold text-slate-600">–ù–∞—á–Ω–∏—Ç–µ —Å–≤–æ–π –ø—É—Ç—å –∫ —Ü–µ–ª–∏!</p>
            <p class="text-sm text-slate-500 mt-1">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–ª–∞, —á—Ç–æ–±—ã –º—ã —Ä–∞—Å—Å—á–∏—Ç–∞–ª–∏ —Ü–µ–ª–∏ –∏ –Ω–∞—á–∞–ª–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å.</p>
        </div>
    {% endif %}
</div>
{# --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ü–†–û–ì–†–ï–°–°–ê --- #}

<div class="card p-6 relative">
        <div {% if not current_user.has_subscription %}class="locked-feature"{% endif %}>
            <h3 class="text-lg font-bold text-slate-800 mb-4">–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
           <div class="grid md:grid-cols-3 gap-6 text-center">
    <div>
        <div class="text-sm font-semibold text-slate-600 mb-2">–í–µ—Å, –∫–≥</div>
        <div class="relative h-24 w-full">
            <canvas id="weightChart"></canvas>
        </div>
    </div>
    <div>
        <div class="text-sm font-semibold text-slate-600 mb-2">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–æ, –∫–∫–∞–ª</div>
        <div class="relative h-24 w-full">
            <canvas id="mealsChart"></canvas>
        </div>
    </div>
    <div>
        <div class="text-sm font-semibold text-slate-600 mb-2">–°–æ–∂–∂–µ–Ω–æ, –∫–∫–∞–ª</div>
        <div class="relative h-24 w-full">
            <canvas id="activityChart"></canvas>
        </div>
    </div>
</div>
        </div>
        {% if not current_user.has_subscription %}
        <div class="locked-overlay">
            <div class="locked-icon">üìä</div>
            <p class="locked-text">–í–∏–∑—É–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</p>
            <p class="text-sm text-slate-600 mb-3">–¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ</p>
<a href="{{ url_for('purchase_page') }}" class="btn btn-primary btn-sm">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å PRO</a>
        </div>
        {% endif %}
    </div>
    <div id="diet-card-container" class="card p-6 relative">

          <div id="diet-display-section" {% if not diet %}style="display: none;"{% endif %}>
              <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-bold text-slate-800">üìà –í–∞—à —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Ü–∏–æ–Ω</h3>
                  <button onclick="confirmAndResetDiet()" class="text-sm font-semibold text-red-500 hover:text-red-700">
                      –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å
                  </button>
              </div>

              {% if diet %}
              <a href="/diet" class="block space-y-4">
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center text-slate-700">
                      <div class="bg-green-50 py-2 rounded-lg border border-green-200"><div class="text-xs text-green-800">–ö–∞–ª–æ—Ä–∏–∏</div><div class="font-bold">{{ diet.total_kcal }} –∫–∫–∞–ª</div></div>
                      <div class="bg-blue-50 py-2 rounded-lg border border-blue-200"><div class="text-xs text-blue-800">–ë–µ–ª–∫–∏</div><div class="font-bold">{{ diet.protein }} –≥</div></div>
                      <div class="bg-yellow-50 py-2 rounded-lg border border-yellow-200"><div class="text-xs text-yellow-800">–ñ–∏—Ä—ã</div><div class="font-bold">{{ diet.fat }} –≥</div></div>
                      <div class="bg-purple-50 py-2 rounded-lg border border-purple-200"><div class="text-xs text-purple-800">–£–≥–ª–µ–≤–æ–¥—ã</div><div class="font-bold">{{ diet.carbs }} –≥</div></div>
                  </div>
                 {# —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫: diet.meals, diet –∏–ª–∏ —Å–ø–∏—Å–æ–∫ —Å meal_type #}
{% set meals_src = (diet.meals if diet is defined and diet.meals is defined and diet.meals else diet) %}
{% set order = [
  ('breakfast', 'üç≥ –ó–∞–≤—Ç—Ä–∞–∫'),
  ('lunch',     'üç≤ –û–±–µ–¥'),
  ('dinner',    'üçù –£–∂–∏–Ω'),
  ('snack',     'üçé –ü–µ—Ä–µ–∫—É—Å')
] %}

{% for key, label in order %}
  {# dict -> –±–µ—Ä—ë–º –ø–æ –∫–ª—é—á—É, list -> —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ meal_type #}
  {% if meals_src and meals_src.get is defined %}
    {% set meal_items = meals_src.get(key, []) %}
  {% else %}
    {% set meal_items = (meals_src | selectattr('meal_type','equalto', key) | list) if meals_src else [] %}
  {% endif %}

  <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
    <div class="font-semibold text-slate-700 mb-2 text-sm">{{ label }}</div>
    <ul class="space-y-1 text-sm text-slate-600">
      {% if meal_items and meal_items|length %}
        {% for itm in meal_items %}
          {% set grams = (itm.grams if itm.grams is defined else (itm.weight_g if itm.weight_g is defined else none)) %}
          {% set kcal  = (itm.kcal  if itm.kcal  is defined else (itm.calories if itm.calories is defined else none)) %}
          <li class="flex justify-between">
            <span>{{ itm.name }}</span>
            <span class="text-xs text-slate-500">
              {% if grams is not none %}{{ grams }}–≥{% if kcal is not none %}, {% endif %}{% endif %}
              {% if kcal  is not none %}{{ kcal }} –∫–∫–∞–ª{% endif %}
            </span>
          </li>
        {% endfor %}
      {% else %}
        <li class="text-slate-400 text-xs">–ù–µ—Ç –±–ª—é–¥ –≤ —ç—Ç–æ–º –ø—Ä–∏—ë–º–µ.</li>
      {% endif %}
    </ul>
  </div>
{% endfor %}

              </a>
              {% endif %}
          </div>

          <div id="diet-generation-section" {% if diet %}style="display: none;"{% endif %}>
              <div {% if not current_user.has_subscription %}class="locked-feature"{% endif %}>
                  <h3 class="text-lg font-bold text-slate-800 mb-4">üìà –°–æ–∑–¥–∞—Ç—å —Ä–∞—Ü–∏–æ–Ω</h3>

                  {% if latest_analysis and latest_analysis.height and latest_analysis.weight %}
                    <form id="dietForm" class="space-y-6">
                      <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">–í–∞—à–∞ —Ü–µ–ª—å</label>
                        <div class="grid grid-cols-3 gap-3">
                          {% for g in [{'label': '–ù–∞–±–æ—Ä', 'icon': 'üí™', 'value': 'muscle'},{'label': '–ü–æ—Ö—É–¥–µ–Ω–∏–µ', 'icon': 'üî•', 'value': 'loss'},{'label': '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ', 'icon': '‚öñÔ∏è', 'value': 'maintain'}] %}
                            <div class="selection-card text-center" data-group="goal" data-value="{{ g.value }}">
                              <div class="text-3xl">{{ g.icon }}</div><div class="text-sm mt-1 font-semibold">{{ g.label }}</div>
                            </div>
                          {% endfor %}
                        </div>
                        <input type="hidden" name="goal" id="goalInput">
                      </div>
                      <div>
  <label class="block text-sm font-medium mb-2 text-slate-700">–í–∞—à –ø–æ–ª</label>

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <!-- –ú—É–∂—Å–∫–æ–π -->
    <div
      class="selection-card selection-card-gender group relative p-5 h-40 overflow-hidden cursor-pointer"
      data-group="gender" data-value="male" role="button" aria-pressed="false"
    >
      <!-- —Å–≤–µ—á–µ–Ω–∏–µ/–ø–æ–¥—Å–≤–µ—Ç–∫–∞ -->
      <div class="absolute inset-0 rounded-xl pointer-events-none ring-2 ring-transparent transition-all
                  group-[.selected]:ring-blue-500 group-[.selected]:shadow-[0_12px_30px_rgba(59,130,246,.30)]"></div>

      <div class="flex items-center justify-between h-full">
        <div class="z-10">
          <div class="text-xs uppercase tracking-wide text-slate-500">–ü–æ–ª</div>
          <div class="text-xl font-extrabold text-slate-900">–ú—É–∂—Å–∫–æ–π</div>
          <div class="mt-2 text-xs text-slate-500">–Ω–∞–∂–∏–º–∞–π—Ç–µ ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –∂–∏–≤–∞—è</div>
        </div>

        <div class="relative w-24 h-24">
          <!-- –∞–∫—Ç–∏–≤–Ω—ã–π —Å–∏–ª—É—ç—Ç -->
          <i class="bi bi-gender-male icon-primary absolute left-1 top-1 text-6xl text-blue-600
                    transition-transform duration-300 ease-out"></i>
          <!-- –≤—Ç–æ—Ä–æ–π —Å–∏–ª—É—ç—Ç –¥–ª—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ -->
          <i class="bi bi-gender-female icon-secondary absolute -right-1 -bottom-1 text-5xl text-slate-300
                    opacity-70 rotate-12"></i>

          <!-- –∏—Å–∫–æ—Ä–∫–∏ -->
          <span class="burst b1"></span>
          <span class="burst b2"></span>
          <span class="burst b3"></span>
        </div>
      </div>
    </div>

    <!-- –ñ–µ–Ω—Å–∫–∏–π -->
    <div
      class="selection-card selection-card-gender group relative p-5 h-40 overflow-hidden cursor-pointer"
      data-group="gender" data-value="female" role="button" aria-pressed="false"
    >
      <div class="absolute inset-0 rounded-xl pointer-events-none ring-2 ring-transparent transition-all
                  group-[.selected]:ring-pink-500 group-[.selected]:shadow-[0_12px_30px_rgba(236,72,153,.28)]"></div>

      <div class="flex items-center justify-between h-full">
        <div class="z-10">
          <div class="text-xs uppercase tracking-wide text-slate-500">–ü–æ–ª</div>
          <div class="text-xl font-extrabold text-slate-900">–ñ–µ–Ω—Å–∫–∏–π</div>
          <div class="mt-2 text-xs text-slate-500">–Ω–∞–∂–∏–º–∞–π—Ç–µ ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –∂–∏–≤–∞—è</div>
        </div>

        <div class="relative w-24 h-24">
          <i class="bi bi-gender-female icon-primary absolute left-1 top-1 text-6xl text-pink-600
                    transition-transform duration-300 ease-out"></i>
          <i class="bi bi-gender-male icon-secondary absolute -right-1 -bottom-1 text-5xl text-slate-300
                    -rotate-12 opacity-70"></i>

          <span class="burst b1"></span>
          <span class="burst b2"></span>
          <span class="burst b3"></span>
        </div>
      </div>
    </div>
  </div>

  <input type="hidden" name="gender" id="genderInput">
</div>

                      <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <textarea name="preferences" rows="2" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–µ–∑ —Ä—ã–±—ã, –±–æ–ª—å—à–µ –∫—É—Ä–∏—Ü—ã"></textarea>
                      </div>
                      <button type="button" onclick="startDietGeneration()" class="btn btn-primary w-full">‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Ü–∏–æ–Ω</button>
                    </form>
                  {% else %}
                    <p class="text-center text-slate-500 py-8">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–ª–∞, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –≤–∞—Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Ü–∏–æ–Ω.</p>
                  {% endif %}
               </div>
               {% if not current_user.has_subscription %}
               <div class="locked-overlay">
                   <div class="locked-icon">üçΩÔ∏è</div>
                   <p class="locked-text">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –¥–∏–µ—Ç–∞</p>
                   <p class="text-sm text-slate-600 mb-3">–¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ</p>
                   <a href="#" class="btn btn-primary btn-sm">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</a>
               </div>
               {% endif %}
          </div>
      </div>
    </div>
  </div>

   {% elif request.path == '/metrics' %}
<div id="tab-metrics-panel" class="space-y-6 animate-fade-in">
    <div class="card p-6">
      <h2 class="text-xl font-bold mb-4">–ë–∞–ª–∞–Ω—Å –∫–∞–ª–æ—Ä–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
      {% if missing_meals or missing_activity %}
        <div class="text-center py-8 bg-yellow-50 border border-yellow-200 rounded-lg">
          <h3 class="font-semibold text-yellow-800">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞</h3>
          <p class="text-sm text-yellow-700 mt-1">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:</p>
          <ul class="list-disc list-inside text-sm text-yellow-700 mt-2">
            {% if missing_meals %}<li>–ü—Ä–∏—ë–º—ã –ø–∏—â–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</li>{% endif %}
            {% if missing_activity %}<li>–î–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</li>{% endif %}
          </ul>
        </div>
      {% else %}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
          <div class="bg-slate-50 p-4 rounded-lg"><div class="text-sm text-slate-500">–ú–µ—Ç–∞–±–æ–ª–∏–∑–º</div><div class="text-2xl font-bold text-slate-800">{{ metabolism }}</div><span class="text-xs text-slate-500">–∫–∫–∞–ª</span></div>
          <div class="bg-slate-50 p-4 rounded-lg"><div class="text-sm text-slate-500">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div><div class="text-2xl font-bold text-blue-600">+ {{ active_kcal }}</div><span class="text-xs text-slate-500">–∫–∫–∞–ª</span></div>
          <div class="bg-slate-50 p-4 rounded-lg"><div class="text-sm text-slate-500">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–æ</div><div class="text-2xl font-bold text-orange-600">- {{ total_meals }}</div><span class="text-xs text-slate-500">–∫–∫–∞–ª</span></div>
          <div class="bg-green-50 p-4 rounded-lg border border-green-200"><div class="text-sm text-green-700">–î–µ—Ñ–∏—Ü–∏—Ç</div><div class="text-2xl font-bold text-green-600">{{ deficit }}</div><span class="text-xs text-green-600">–∫–∫–∞–ª</span></div>
        </div>
      {% endif %}
    </div>

    <div class="grid md:grid-cols-2 gap-6">
        <div class="card p-6">
          <h3 class="text-lg font-bold mb-4">üèÉ‚Äç‚ôÇÔ∏è –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è</h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-slate-50 p-4 rounded-lg text-center"><div class="text-sm text-slate-500">–®–∞–≥–∏</div><div class="text-xl font-bold">{{ steps or '‚Äî' }}</div></div>
            <div class="bg-slate-50 p-4 rounded-lg text-center"><div class="text-sm text-slate-500">–î–∏—Å—Ç–∞–Ω—Ü–∏—è</div><div class="text-xl font-bold">{{ distance_km or '‚Äî' }} <span class="text-sm">–∫–º</span></div></div>
            <div class="bg-slate-50 p-4 rounded-lg text-center"><div class="text-sm text-slate-500">–ê–∫—Ç–∏–≤. –∫–∞–ª–æ—Ä–∏–∏</div><div class="text-xl font-bold">{{ active_kcal or '‚Äî' }}</div></div>
            <div class="bg-slate-50 p-4 rounded-lg text-center"><div class="text-sm text-slate-500">–ö–∞–ª–æ—Ä–∏–∏ –ø–æ–∫–æ—è</div><div class="text-xl font-bold">{{ resting_kcal or '‚Äî' }}</div></div>
          </div>
        </div>

        <div class="card p-6">
          <h3 class="text-lg font-bold mb-4">üçΩÔ∏è –ü—Ä–∏—ë–º—ã –ø–∏—â–∏ —Å–µ–≥–æ–¥–Ω—è</h3>
          {% if today_meals %}
          <div class="grid grid-cols-2 gap-4">
            {% for meal in today_meals %}
              <div class="bg-slate-50 p-4 rounded-lg text-center">
                <div class="text-sm text-slate-500 font-semibold">{{ meal.meal_type|capitalize }}</div>
                <div class="mt-1 text-xl font-bold">{{ meal.calories }} <span class="text-sm">–∫–∫–∞–ª</span></div>
              </div>
            {% endfor %}
          </div>
          {% else %}
            <p class="text-center text-slate-500 py-6">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏—ë–º–∞—Ö –ø–∏—â–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.</p>
          {% endif %}
        </div>
    </div>
  </div>

  {% elif request.path == '/activity' %}
<div id="tab-activity-panel" class="card p-6 animate-fade-in">
    <h2 class="text-xl font-bold mb-6">–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
    {% if today_activity %}
      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-slate-50 border border-slate-200 p-4 rounded-lg"><div class="text-sm text-slate-500">üëü –®–∞–≥–∏</div><div class="text-2xl font-bold mt-1">{{ today_activity.steps or '‚Äî' }}</div></div>
        <div class="bg-slate-50 border border-slate-200 p-4 rounded-lg"><div class="text-sm text-slate-500">üó∫Ô∏è –î–∏—Å—Ç–∞–Ω—Ü–∏—è</div><div class="text-2xl font-bold mt-1">{{ today_activity.distance_km or '‚Äî' }} –∫–º</div></div>
        <div class="bg-slate-50 border border-slate-200 p-4 rounded-lg"><div class="text-sm text-slate-500">üî• –ö–∞–ª–æ—Ä–∏–∏</div><div class="text-2xl font-bold mt-1">{{ today_activity.active_kcal or '‚Äî' }}</div></div>
        <div class="bg-slate-50 border border-slate-200 p-4 rounded-lg"><div class="text-sm text-slate-500">‚ù§Ô∏è –ü—É–ª—å—Å (—Å—Ä–µ–¥.)</div><div class="text-2xl font-bold mt-1">{{ today_activity.heart_rate_avg or '‚Äî' }} <span class="text-base">—É–¥/–º–∏–Ω</span></div></div>
      </div>

      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2 space-y-6">
          <div class="p-4 bg-slate-50 rounded-lg"><h3 class="font-semibold mb-2">–ì—Ä–∞—Ñ–∏–∫ —à–∞–≥–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é</h3><div class="h-48 flex items-center justify-center text-slate-400">[–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≥—Ä–∞—Ñ–∏–∫–∞]</div></div>
          <div class="p-4 bg-slate-50 rounded-lg"><h3 class="font-semibold mb-2">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏ –ø–æ –¥–Ω—è–º</h3><div class="h-48 flex items-center justify-center text-slate-400">[–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≥—Ä–∞—Ñ–∏–∫–∞]</div></div>
        </div>
        <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg h-fit">
          <h3 class="font-semibold text-blue-800">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö</h3>
          <div class="flex items-center mt-3">
             <div class="bg-white p-3 rounded-full mr-4 shadow">
                  <span class="text-xl">üì±</span>
             </div>
             <div>
                <div class="font-bold text-blue-900">{{ today_activity.source or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</div>
                <div class="text-sm text-blue-700">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ today_activity.date.strftime('%H:%M') }}</div>
             </div>
          </div>
        </div>
      </div>

    {% else %}
      <div class="text-center py-16">
        <div class="text-5xl text-slate-300 mb-4">üìä</div>
        <p class="text-slate-500 font-semibold">–î–∞–Ω–Ω—ã–µ –æ–± –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        <p class="text-sm text-slate-400 mt-2">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä, Apple Health –∏–ª–∏ Google Fit.</p>
      </div>
    {% endif %}
  </div>

{% elif request.path == '/meals' %}
<div id="tab-diet-panel" class="space-y-8 animate-fade-in">

    <div>
        <h2 class="text-2xl font-bold text-slate-800 mb-4">–°–≤–æ–¥–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
        <div class="card p-6">
            {% set all_items = meals.values() | sum(start=[]) %}

            {% set today_total_kcal    = all_items | sum(attribute='calories') %}
            {% set today_total_protein = all_items | sum(attribute='protein') %}
            {% set today_total_fat     = all_items | sum(attribute='fat') %}
            {% set today_total_carbs   = all_items | sum(attribute='carbs') %}

            {% set goal_kcal = latest_analysis.metabolism + 500 if latest_analysis and latest_analysis.metabolism else 2000 %}
            {% set progress_percent = (today_total_kcal / goal_kcal * 100) | round if goal_kcal > 0 else 0 %}

            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                <div>
                    <div class="text-sm text-slate-500">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–æ –∫–∞–ª–æ—Ä–∏–π</div>
                    <span class="text-3xl font-bold text-slate-900">{{ today_total_kcal }}</span>
                    <span class="text-lg text-slate-400 font-medium">/ {{ goal_kcal }} –∫–∫–∞–ª</span>
                </div>
                <div class="w-full sm:w-1/3">
                    <div class="w-full bg-slate-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: {{ progress_percent }}%"></div>
                    </div>
                </div>
            </div>

            <hr class="my-5 border-slate-200">

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="text-sm font-semibold text-blue-800">–ë–µ–ª–∫–∏</div>
                    <div class="text-xl font-bold text-blue-900 mt-1">{{ today_total_protein | round(1) }} –≥</div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <div class="text-sm font-semibold text-yellow-800">–ñ–∏—Ä—ã</div>
                    <div class="text-xl font-bold text-yellow-900 mt-1">{{ today_total_fat | round(1) }} –≥</div>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                    <div class="text-sm font-semibold text-purple-800">–£–≥–ª–µ–≤–æ–¥—ã</div>
                    <div class="text-xl font-bold text-purple-900 mt-1">{{ today_total_carbs | round(1) }} –≥</div>
                </div>
            </div>
        </div>
    </div>

    <div>
        <h2 class="text-2xl font-bold text-slate-800 mb-4">–ü—Ä–∏—ë–º—ã –ø–∏—â–∏</h2>
   <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
  {% for meal_name, key, gradient in [
    ('–ó–∞–≤—Ç—Ä–∞–∫','breakfast','from-amber-400 to-orange-500'),
    ('–û–±–µ–¥','lunch','from-green-400 to-emerald-500'),
    ('–£–∂–∏–Ω','dinner','from-blue-500 to-indigo-600'),
    ('–ü–µ—Ä–µ–∫—É—Å','snack','from-pink-400 to-rose-500')
  ] %}
    {% set item = meals.get(key, []) | first %}

    <div class="flip-card cursor-pointer" onclick="this.classList.toggle('is-flipped')">
      <div class="flip-card-inner rounded-2xl">
        <!-- FRONT -->
        <div class="flip-card-front relative overflow-hidden">
          <div class="p-6 bg-gradient-to-br {{ gradient }} text-white rounded-2xl h-full flex flex-col justify-between">

            <div>
              <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold tracking-wide">{{ meal_name }}</h3>
                {% if item %}
                  <span class="text-lg font-bold">{{ item.calories }}
                    <span class="text-sm font-normal opacity-80">–∫–∫–∞–ª</span>
                  </span>
                {% endif %}
              </div>
              <div class="mt-4">
                {% if item %}
                  <p class="text-lg font-semibold">{{ item.name or '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ' }}</p>
                  <p class="text-xs text-white/80 mt-1">(–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏)</p>
                {% else %}
                  <p class="text-white/80">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                {% endif %}
              </div>
            </div>

          </div>
          <div class="p-4 bg-white/80 backdrop-blur border-t border-white/30">
            <button onclick="event.stopPropagation(); openMealModal('{{ key }}','{{ meal_name }}')"
                    class="btn w-full {% if item %}btn-secondary{% else %}btn-primary{% endif %}">
              ‚úèÔ∏è {% if item %}–ò–∑–º–µ–Ω–∏—Ç—å{% else %}–î–æ–±–∞–≤–∏—Ç—å{% endif %}
            </button>
          </div>
        </div>

        <!-- BACK -->
        <div class="flip-card-back bg-white text-slate-800 relative">
          {% if item %}
            <div class="mb-3">
              <h4 class="font-bold text-lg">–í–µ—Ä–¥–∏–∫—Ç AI</h4>
              <p class="text-sm text-center mt-2 bg-slate-50 border border-slate-200 p-3 rounded-md">
                {{ item.verdict or '–ù–µ—Ç –≤–µ—Ä–¥–∏–∫—Ç–∞.' }}
              </p>
            </div>
            <div>
              <h4 class="font-bold text-lg mb-2">–ê–Ω–∞–ª–∏–∑</h4>
              <p class="text-xs text-slate-600 text-center">{{ item.analysis or '–ù–µ—Ç –∞–Ω–∞–ª–∏–∑–∞.' }}</p>
            </div>
          {% else %}
            <p>–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å", —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –±–ª—é–¥–∞ –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é.</p>
          {% endif %}
          <!-- —Å—Ç—Ä–µ–ª–∫–∞ –∏ –Ω–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ -->
          <div class="click-arrow">‚ûú</div>
        </div>

      </div>
    </div>
  {% endfor %}
</div>

    </div>
</div>
    </div>
</div>

{%- macro sum(items, attribute, sum_key=false) -%}
  {% if sum_key %}
    {{ items | map('sum', attribute=attribute) | sum }}
  {% else %}
    {{ items | sum(attribute=attribute) }}
  {% endif %}
{%- endmacro -%}
{% endif %}

<div id="mealModal" role="dialog" aria-modal="true" aria-labelledby="modalMealTitle"
     class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="closeMealModal()">
  <div class="card w-full max-w-md p-0 relative animate-fade-in" onclick="event.stopPropagation()">
    <button onclick="closeMealModal()" class="absolute top-3 right-4 text-slate-500 text-2xl hover:text-slate-700 z-20">&times;</button>

    <div class="p-6">
      <h2 class="text-xl font-bold">–ü—Ä–∏—ë–º –ø–∏—â–∏: <span id="modalMealTitle"></span></h2>
    </div>

    <div class="flex border-b border-slate-200 px-6">
      <button id="manualTabBtn" onclick="switchMealTab('manual')" class="meal-tab active">
        ‚úçÔ∏è –í—Ä—É—á–Ω—É—é
      </button>
      <button id="aiTabBtn" onclick="switchMealTab('ai')" class="meal-tab">
        üì∏ –ê–Ω–∞–ª–∏–∑ –ø–æ —Ñ–æ—Ç–æ {% if not current_user.has_subscription %}<span class="text-amber-500">(PRO)</span>{% endif %}
      </button>
    </div>

    <div class="p-6">
      <div id="manualTabContent">
        <form id="manualMealForm" method="POST" action="/meals" class="space-y-4">
          <input type="hidden" name="meal_type" id="manualMealType">

          <div>
            <label for="manualName" class="block text-sm font-medium mb-1 text-slate-700">–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞</label>
            <input type="text" id="manualName" name="name" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –û–≤—Å—è–Ω–∞—è –∫–∞—à–∞" required>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
                <label for="manualCalories" class="block text-sm font-medium mb-1 text-slate-700">–ö–∞–ª–æ—Ä–∏–∏</label>
                <input type="number" id="manualCalories" name="calories" class="form-input" placeholder="–∫–∫–∞–ª" required>
            </div>
            <div>
                <label for="manualProtein" class="block text-sm font-medium mb-1 text-slate-700">–ë–µ–ª–∫–∏</label>
                <input type="number" step="0.1" id="manualProtein" name="protein" class="form-input" placeholder="–≥—Ä–∞–º–º—ã" required>
            </div>
            <div>
                <label for="manualFat" class="block text-sm font-medium mb-1 text-slate-700">–ñ–∏—Ä—ã</label>
                <input type="number" step="0.1" id="manualFat" name="fat" class="form-input" placeholder="–≥—Ä–∞–º–º—ã" required>
            </div>
            <div>
                <label for="manualCarbs" class="block text-sm font-medium mb-1 text-slate-700">–£–≥–ª–µ–≤–æ–¥—ã</label>
                <input type="number" step="0.1" id="manualCarbs" name="carbs" class="form-input" placeholder="–≥—Ä–∞–º–º—ã" required>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-full">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
      </div>

      <div id="aiTabContent" class="hidden relative">
          <div {% if not current_user.has_subscription %}class="locked-feature"{% endif %}>
            <div class="space-y-4">
              <input type="file" id="mealFileInput" accept="image/*" class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
              <button id="analyzeMealBtn" onclick="analyzeMeal()" class="btn btn-primary w-full">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ</button>

              <div id="mealLoading" class="flex items-center justify-center space-x-2 hidden text-slate-500">
                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg>
                <span>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º...</span>
              </div>

              <div id="mealAnalysisResult" class="hidden space-y-3">
                 </div>
            </div>
          </div>
          {% if not current_user.has_subscription %}
            <div class="locked-overlay">
                <div class="locked-icon">üì∏</div>
                <p class="locked-text">AI-–∞–Ω–∞–ª–∏–∑ –ø–æ —Ñ–æ—Ç–æ</p>
                <p class="text-sm text-slate-600 mb-3">–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ</p>
                <a href="#" class="btn btn-primary btn-sm">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å PRO</a>
            </div>
          {% endif %}
      </div>
    </div>
  </div>
</div>

<div id="dietLoader" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-50 hidden">
  <svg class="animate-spin h-10 w-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
  <p class="mt-4 text-lg font-semibold text-slate-700">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∞—à –∏–¥–µ–∞–ª—å–Ω—ã–π —Ä–∞—Ü–∏–æ–Ω...</p>
  <p class="text-slate-500">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30 —Å–µ–∫—É–Ω–¥.</p>
</div>

<div id="telegramModal" role="dialog" aria-modal="true" aria-labelledby="telegramModalTitle"
     class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4"
     data-bot="{{ bot_username|default('TestKilogrBot') }}">
  <div class="card w-full max-w-2xl p-6 sm:p-8 relative animate-fade-in bg-white" onclick="event.stopPropagation()">

    <button onclick="closeTelegramModal()" class="absolute top-4 right-4 text-slate-400 text-2xl hover:text-slate-600 transition-colors" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
    <div class="flex items-center gap-3 mb-4">
      <div class="h-10 w-10 rounded-xl bg-sky-100 flex items-center justify-center text-sky-600">‚úàÔ∏è</div>
      <div>
        <h2 id="telegramModalTitle" class="text-lg sm:text-xl font-bold text-slate-900">–ü—Ä–∏–≤—è–∑–∫–∞ Telegram</h2>
        <p class="text-slate-600 text-sm">–°–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –¥–µ–ª–∏—Ç—å—Å—è –¥–∞–Ω–Ω—ã–º–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.</p>
      </div>
    </div>

    <div class="flex items-center gap-2 text-sm mb-5">
      <span class="relative flex h-2.5 w-2.5">
        <span class="absolute inline-flex h-full w-full rounded-full animate-ping bg-amber-400" id="tgStatusPing"></span>
        <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-amber-500" id="tgStatusDot"></span>
      </span>
      <span id="tgStatusText" class="text-slate-600">–°—Ç–∞—Ç—É—Å: ...</span>
      <span class="ml-auto text-xs text-slate-500">
        –ë–æ—Ç: <a id="tgBotLink" class="font-medium text-blue-600 hover:underline" target="_blank" rel="noopener"><span id="tgBotName"></span></a>
      </span>
    </div>

    <div id="tg-unlinked-view">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <ol class="text-xs text-slate-500 space-y-2">
            <li class="flex items-center gap-2"><span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-200 font-semibold">1</span> –û—Ç–∫—Ä–æ–π—Ç–µ Telegram</li>
            <li class="flex items-center gap-2"><span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-200 font-semibold">2</span> –ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ <span class="font-medium text-blue-600">@TestKilogrBot</span></li>
            <li class="flex items-center gap-2"><span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-200 font-semibold">3</span> –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–º—É –≤–∞—à –∫–æ–¥</li>
          </ol>
          <div class="space-y-3">
            <div id="tgCodeDisplay" class="font-mono text-2xl tracking-wider select-all px-4 py-3 rounded-xl bg-slate-50 border border-slate-200">...</div>
            <div class="flex gap-3">
              <button onclick="copyCode()" class="btn btn-secondary w-full">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
              <a id="tgDeepLink" class="btn btn-primary w-full text-center" target="_blank" rel="noopener">–ê–≤—Ç–æ–ø—Ä–∏–≤—è–∑–∫–∞</a>
            </div>
          </div>
        </div>
        <div class="rounded-xl border border-slate-200 p-4 bg-slate-50 flex flex-col items-center justify-center text-center">
            <div class="text-4xl mb-2">üîî</div>
            <h3 class="font-semibold text-slate-700">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
            <p class="text-xs text-slate-500 mt-1">–ü–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è–º–∏ –∑–¥–µ—Å—å.</p>
        </div>
      </div>
    </div>

    <div id="tg-linked-view" class="hidden">
      <div class="rounded-xl border border-slate-200 p-4 space-y-3">
        <div class="flex items-center justify-between py-2 border-b border-slate-200">
          <div class="text-sm">
            <div class="font-medium text-slate-800">–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</div>
            <div class="text-slate-500 text-xs">–û—Ç–∫–ª—é—á–∞–µ—Ç/–≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–∑–æ–º</div>
          </div>
          <button id="tgSwitchGlobal" role="switch" aria-checked="false" data-key="telegram_notify_enabled" class="w-12 h-7 rounded-full bg-slate-300 relative transition">
              <span class="knob absolute top-0.5 left-0.5 h-6 w-6 rounded-full bg-white shadow transition"></span>
          </button>
        </div>
        <div class="flex items-center justify-between">
          <div class="text-sm"><div class="font-medium text-slate-800">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div><div class="text-slate-500 text-xs">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 1 —á–∞—Å –∏ –≤ –º–æ–º–µ–Ω—Ç —Å—Ç–∞—Ä—Ç–∞</div></div>
          <button id="tgSwitchTrainings" role="switch" aria-checked="true" data-key="notify_trainings" class="w-12 h-7 rounded-full bg-emerald-500 relative transition"><span class="knob absolute top-0.5 left-0.5 h-6 w-6 rounded-full bg-white shadow transition"></span></button>
        </div>
        <div class="flex items-center justify-between">
            <div class="text-sm"><div class="font-medium text-slate-800">–ü—Ä–∏—ë–º—ã –ø–∏—â–∏</div><div class="text-slate-500 text-xs">–≤ 8:00 ¬∑ 12:00 ¬∑ 18:00</div></div>
            <button id="tgSwitchMeals" role="switch" aria-checked="true" data-key="notify_meals" class="w-12 h-7 rounded-full bg-emerald-500 relative transition"><span class="knob absolute top-0.5 left-0.5 h-6 w-6 rounded-full bg-white shadow transition"></span></button>
        </div>
        <div class="flex items-center justify-between">
          <div class="text-sm"><div class="font-medium text-slate-800">–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</div><div class="text-slate-500 text-xs">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 5 –¥–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è</div></div>
          <button id="tgSwitchSubscription" role="switch" aria-checked="true" data-key="notify_subscription" class="w-12 h-7 rounded-full bg-emerald-500 relative transition"><span class="knob absolute top-0.5 left-0.5 h-6 w-6 rounded-full bg-white shadow transition"></span></button>
        </div>
      </div>
       <div class="mt-4 text-center">
            <button onclick="unlinkTelegram()" class="text-sm font-medium text-red-500 hover:text-red-700 hover:underline">–û—Ç–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
       </div>
    </div>

  </div>
</div>


<div id="editProfileModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="closeEditProfileModal()">
  <div class="card w-full max-w-lg p-6 sm:p-8 relative animate-fade-in" onclick="event.stopPropagation()">
    <button onclick="closeEditProfileModal()" class="absolute top-4 right-4 text-slate-400 text-2xl hover:text-slate-600">&times;</button>
    <h2 class="text-xl font-bold mb-6">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h2>

    <form action="/edit_profile" method="POST" enctype="multipart/form-data" class="space-y-5">
        <div class="flex items-center gap-4">
            {% if user.avatar %}
              <img src="{{ url_for('serve_file', filename=user.avatar.filename) }}" alt="Avatar" class="w-16 h-16 rounded-full object-cover">
            {% else %}
              <img src="https://www.svgrepo.com/show/452070/user-avatar.svg" alt="Default Avatar" class="w-16 h-16 rounded-full">
            {% endif %}
            <div>
                <label for="avatar" class="block text-sm font-medium text-slate-700">–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
                <input type="file" name="avatar" id="avatar" accept="image/*" class="mt-1 text-sm text-slate-500 file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
        </div>

        <hr>

        <div class="grid sm:grid-cols-2 gap-4">
            <div>
                <label for="name" class="block text-sm font-medium mb-1 text-slate-700">–ò–º—è</label>
                <input type="text" name="name" id="name" value="{{ user.name }}" class="form-input" required
                       pattern="[^\d]*" title="–ò–º—è –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ü–∏—Ñ—Ä—ã.">
            </div>
            <div>
                <label for="email" class="block text-sm font-medium mb-1 text-slate-700">Email</label>
                <input type="email" name="email" id="email" value="{{ user.email }}" class="form-input" required>
            </div>
        </div>

        <div>
          <label for="date_of_birth" class="block text-sm font-medium mb-1 text-slate-700">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <input type="date" name="date_of_birth" id="date_of_birth" value="{{ user.date_of_birth.strftime('%Y-%m-%d') if user.date_of_birth else '' }}" class="form-input" required
                 title="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º.">
        </div>

        <div class="flex justify-end gap-3 pt-4">
            <button type="button" onclick="closeEditProfileModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
    </form>

    <hr class="my-6 border-slate-200">

    <h3 class="text-lg font-bold mb-4">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
    <form action="/change_password" method="POST" class="space-y-4">
        <div class="grid sm:grid-cols-2 gap-4">
             <div>
                <label for="new_password" class="block text-sm font-medium mb-1 text-slate-700">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                <input type="password" name="new_password" id="new_password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                       minlength="8" title="–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤.">
            </div>
            <div>
                <label for="confirm_password" class="block text-sm font-medium mb-1 text-slate-700">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                <input type="password" name="confirm_password" id="confirm_password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                       minlength="8">
            </div>
        </div>

        <div class="flex justify-end pt-2">
            <button type="submit" class="btn btn-primary">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
        </div>
    </form>
  </div>
</div>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
.meal-tab {
    padding: 0.75rem 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease;
    cursor: pointer;
}
.meal-tab:hover {
    color: var(--brand-primary);
}
.meal-tab.active {
    color: var(--brand-primary);
    border-bottom-color: var(--brand-primary);
}
</style>

<script>
    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –±–∞–Ω–Ω–µ—Ä–∞ ---
    const banner = document.getElementById('infoBanner');
    const restoreContainer = document.getElementById('restoreBannerContainer');
    if (banner && restoreContainer) {
        if (localStorage.getItem('infoBannerHidden') === 'true') {
            banner.style.display = 'none';
            restoreContainer.style.display = 'block';
        }
    }
    function hideBanner() {
        localStorage.setItem('infoBannerHidden', 'true');
        banner.style.transition = 'opacity 0.5s, transform 0.5s';
        banner.style.opacity = '0';
        banner.style.transform = 'scale(0.95)';
        setTimeout(() => {
            banner.style.display = 'none';
            restoreContainer.style.display = 'block';
        }, 500);
    }
    function showBanner() {
        localStorage.removeItem('infoBannerHidden');
        restoreContainer.style.display = 'none';
        banner.style.display = 'block';
        setTimeout(() => {
            banner.style.transition = 'opacity 0.5s, transform 0.5s';
            banner.style.opacity = '1';
            banner.style.transform = 'scale(1)';
        }, 10);
    }

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ ---
    let currentMealKey = '';

    function switchMealTab(tabName) {
        document.getElementById('manualTabContent').classList.add('hidden');
        document.getElementById('aiTabContent').classList.add('hidden');
        document.getElementById('manualTabBtn').classList.remove('active');
        document.getElementById('aiTabBtn').classList.remove('active');

        if (tabName === 'manual') {
            document.getElementById('manualTabContent').classList.remove('hidden');
            document.getElementById('manualTabBtn').classList.add('active');
        } else {
            document.getElementById('aiTabContent').classList.remove('hidden');
            document.getElementById('aiTabBtn').classList.add('active');
        }
    }

    function openMealModal(key, title) {
        currentMealKey = key;
        document.getElementById('modalMealTitle').textContent = title;
        document.getElementById('manualMealType').value = key;
        document.getElementById('mealAnalysisResult').innerHTML = '';
        document.getElementById('mealFileInput').value = '';
        document.getElementById('mealLoading').classList.add('hidden');
        document.getElementById('analyzeMealBtn').disabled = false;
        document.getElementById('manualMealForm').reset();
        switchMealTab('manual');
        openModal('mealModal');

    }

    function closeMealModal() {
   closeModal('mealModal');

    }

    function analyzeMeal() {
        const fileInput = document.getElementById('mealFileInput');
        if (!fileInput.files.length) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ –±–ª—é–¥–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        document.getElementById('analyzeMealBtn').disabled = true;
        document.getElementById('mealLoading').classList.remove('hidden');
        document.getElementById('mealAnalysisResult').innerHTML = '';

        fetch('/analyze_meal_photo', { method: 'POST', body: formData })
            .then(response => {
                if (response.status === 403) {
                    alert('–ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ.');
                    return null;
                }
                if (!response.ok) { throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞.'); }
                return response.json();
            })
            .then(data => {
                document.getElementById('mealLoading').classList.add('hidden');
                document.getElementById('analyzeMealBtn').disabled = false;
                if (!data) return;
                if (data.error) {
                    alert(`–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ${data.error}`);
                    return;
                }

                const resultHtml = `
                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                      <div class="text-lg font-bold text-slate-800">${data.name}</div>
                      <p class="text-sm text-slate-600 mt-2">${data.verdict}</p>
                      <div class="grid grid-cols-2 gap-2 text-center mt-3 text-sm">
                        <div class="bg-green-100 text-green-800 p-2 rounded-lg">–ö–∞–ª–æ—Ä–∏–∏: <span class="font-bold">${data.calories}</span> –∫–∫–∞–ª</div>
                        <div class="bg-blue-100 text-blue-800 p-2 rounded-lg">–ë–µ–ª–∫–∏: <span class="font-bold">${data.protein}</span> –≥</div>
                        <div class="bg-yellow-100 text-yellow-800 p-2 rounded-lg">–ñ–∏—Ä—ã: <span class="font-bold">${data.fat}</span> –≥</div>
                        <div class="bg-purple-100 text-purple-800 p-2 rounded-lg">–£–≥–ª–µ–≤–æ–¥—ã: <span class="font-bold">${data.carbs}</span> –≥</div>
                      </div>
                    </div>
                    <form id="confirmMealForm" method="POST" action="/meals">
                      <input type="hidden" name="meal_type" value="${currentMealKey}">
                      <input type="hidden" name="name" value="${data.name}">
                      <input type="hidden" name="verdict" value="${data.verdict}">
                      <input type="hidden" name="calories" value="${data.calories}">
                      <input type="hidden" name="protein" value="${data.protein}">
                      <input type="hidden" name="fat" value="${data.fat}">
                      <input type="hidden" name="carbs" value="${data.carbs}">
                      <input type="hidden" name="analysis" value="${data.analysis}">
                      <button type="submit" class="btn bg-green-600 text-white hover:bg-green-700 w-full mt-3">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏</button>
                    </form>
                `;
                document.getElementById('mealAnalysisResult').innerHTML = resultHtml;
                document.getElementById('mealAnalysisResult').classList.remove('hidden');
            })
            .catch(error => {
                document.getElementById('mealLoading').classList.add('hidden');
                document.getElementById('analyzeMealBtn').disabled = false;
                alert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}`);
            });
    }

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∏–µ—Ç—ã ---
    function startDietGeneration() {
        const goal = document.getElementById('goalInput').value;
        const gender = document.getElementById('genderInput').value;
        const preferences = document.querySelector('textarea[name="preferences"]').value;

        if (!goal || !gender) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –∏ –ø–æ–ª.');
            return;
        }

        const loader = document.getElementById('dietLoader');
        loader.classList.remove('hidden');

        const params = new URLSearchParams({ goal, gender, preferences });
        fetch('/generate_diet?' + params)
            .then(res => res.json())
            .then(data => {
                loader.classList.add('hidden');
                if (data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + JSON.stringify(data));
                }
            })
            .catch(err => {
                loader.classList.add('hidden');
                alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + err.message);
            });
    }

// --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ Telegram ---
let tgPollTimer = null;

// –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞ "–ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π" –≤–∏–¥
function switchToLinkedView() {
    document.getElementById('tg-unlinked-view').classList.add('hidden');
    document.getElementById('tg-linked-view').classList.remove('hidden');

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å—Ç–∞—Ç—É—Å
    const modalTitle = document.getElementById('telegramModalTitle');
    if (modalTitle) modalTitle.textContent = '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telegram';
    setTgStatusLinked();
    stopTgPolling();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    loadTgSettings();
}

// –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
async function openTelegramModal() {
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
    const statusRes = await fetch('/api/me/telegram/status');
    const statusData = await statusRes.json();

    const modal = document.getElementById('telegramModal');
    const bot = (modal?.dataset?.bot) || '';

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –±–æ—Ç–∞ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
    const botNameEl = document.getElementById('tgBotName');
    if (botNameEl) botNameEl.textContent = bot || '';
    const botLinkEl = document.getElementById('tgBotLink');
    if (botLinkEl && bot) botLinkEl.href = `https://t.me/${bot}`;

    if (statusData && statusData.linked) {
        // –ï—Å–ª–∏ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        openModal('telegramModal');
        switchToLinkedView();
    } else {
        // –ï—Å–ª–∏ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∫–æ–¥
        const codeRes = await fetch('/generate_telegram_code');
        const codeData = await codeRes.json();

        if (!codeData.code) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥.'); return; }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏
        document.getElementById('tg-linked-view').classList.add('hidden');
        document.getElementById('tg-unlinked-view').classList.remove('hidden');

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const modalTitle = document.getElementById('telegramModalTitle');
        if (modalTitle) modalTitle.textContent = '–ü—Ä–∏–≤—è–∑–∫–∞ Telegram';

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏ –¥–∏–ø–ª–∏–Ω–∫
        const codeEl = document.getElementById('tgCodeDisplay');
        if (codeEl) codeEl.textContent = codeData.code;
        const deepLinkEl = document.getElementById('tgDeepLink');
        if (deepLinkEl && bot) deepLinkEl.href = `https://t.me/${bot}?start=${encodeURIComponent(codeData.code)}`;

        setTgStatusWaiting();
        openModal('telegramModal');
        startTgPolling(); // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π –≤–µ—à–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑
    bindTgSwitches();
}


// --- –ù–û–í–û–ï: UI –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π
function renderSwitch(btn, isOn) {
  if (!btn) return;
  const knob = btn.querySelector('.knob');
  btn.classList.toggle('bg-emerald-500', !!isOn);
  btn.classList.toggle('bg-slate-300', !isOn);
  btn.setAttribute('aria-checked', isOn ? 'true' : 'false');
  if (knob) knob.style.transform = isOn ? 'translateX(20px)' : 'translateX(0px)';
}

let _tgSwitchesBound = false;
function bindTgSwitches() {
  if (_tgSwitchesBound) return; _tgSwitchesBound = true;
  const switches = ['tgSwitchGlobal','tgSwitchTrainings','tgSwitchSubscription','tgSwitchMeals'];
  switches.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('click', () => {
      const key = el.dataset.key;
      const isOn = el.getAttribute('aria-checked') !== 'true';
      renderSwitch(el, isOn);

      // –≤–∞–∂–Ω–æ–µ: ¬´–æ–±–Ω—É–ª—è–µ–º¬ª —Å—Ç–∞—Ä—ã–µ load-–æ—Ç–≤–µ—Ç—ã, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –ø–µ—Ä–µ–æ—Ç—â—ë–ª–∫–Ω—É–ª–∏ UI
      _appliedSeq = _loadSeq;

      const patch = { [key]: isOn };
      if (key === 'notify_subscription') patch.notify_promos = isOn;
      if (key === 'telegram_notify_enabled') patch.telegram_notifications_enabled = isOn;

      saveTgSettings(patch);
    }, { passive: true });
  });
}

function saveTgSettings(patch) {
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(async () => {
    const payload = { ...(patch || {}) };
    if ('notify_subscription' in payload) payload.notify_promos = payload.notify_subscription;
    if ('telegram_notify_enabled' in payload) payload.telegram_notifications_enabled = payload.telegram_notify_enabled;

    try {
      const r = await fetch('/api/me/telegram/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        credentials: 'same-origin',
        cache: 'no-store',
        body: JSON.stringify(payload)
      });
      let j = {}; try { j = await r.json(); } catch (_) {}
      if (!r.ok || j.ok === false) { console.warn('Save failed', r.status, j); return; }

      // –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç—è–Ω–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
      _appliedSeq = _loadSeq;
      await loadTgSettings();

    } catch (e) {
      console.error('Save error', e);
    }
  }, 150);
}



// seq –¥–ª—è –æ—Ç—Å–µ—á–µ–Ω–∏—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
let _loadSeq = 0;
let _appliedSeq = 0;

function loadTgSettings() {
  const seq = ++_loadSeq;
  return fetch('/api/me/telegram/settings', { credentials: 'same-origin', cache: 'no-store' })
    .then(r => r.json())
    .then(j => {
      // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
      if (seq <= _appliedSeq || !j || j.ok === false) return;

      _appliedSeq = seq;

      renderSwitch(document.getElementById('tgSwitchGlobal'),       toBool(j.telegram_notify_enabled ?? j.telegram_notifications_enabled));
      renderSwitch(document.getElementById('tgSwitchTrainings'),    toBool(j.notify_trainings));
      renderSwitch(document.getElementById('tgSwitchSubscription'), toBool(j.notify_subscription ?? j.notify_promos));
      renderSwitch(document.getElementById('tgSwitchMeals'),        toBool(j.notify_meals));
    })
    .catch(e => console.error('Load settings failed', e));
}



let _saveTimer = null;

function toBool(v){
  if (typeof v === 'boolean') return v;
  if (typeof v === 'number') return v !== 0;
  if (v == null) return false;
  const s = String(v).trim().toLowerCase();
  return s === '1' || s === 'true' || s === 'yes' || s === 'on' || s === 'y';
}




function closeTelegramModal() {
  closeModal('telegramModal');
  stopTgPolling();
}

function copyCode() {
  const code = document.getElementById('tgCodeDisplay').textContent;
  navigator.clipboard.writeText(code).then(() => {
    alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
  });
}

// --- —Å—Ç–∞—Ç—É—Å/–ø–æ–ª–ª–∏–Ω–≥ ---
function setTgStatusWaiting() {
  const dot = document.getElementById('tgStatusDot');
  const ping = document.getElementById('tgStatusPing');
  const text = document.getElementById('tgStatusText');
  if (dot) dot.className = 'relative inline-flex rounded-full h-2.5 w-2.5 bg-amber-500';
  if (ping) ping.className = 'absolute inline-flex h-full w-full rounded-full animate-ping bg-amber-400';
  if (text) text.textContent = '–°—Ç–∞—Ç—É—Å: –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω ¬∑ –û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ‚Ä¶';
}
function setTgStatusLinked() {
  const dot = document.getElementById('tgStatusDot');
  const ping = document.getElementById('tgStatusPing');
  const text = document.getElementById('tgStatusText');
  if (dot) dot.className = 'relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500';
  if (ping) ping.className = 'absolute inline-flex h-full w-full rounded-full bg-emerald-400'; // –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
  if (text) text.textContent = '–°—Ç–∞—Ç—É—Å: –ø—Ä–∏–≤—è–∑–∞–Ω';
}

function startTgPolling() {
  if (tgPollTimer) return;
  tgPollTimer = setInterval(checkTgStatus, 2000);
}
function stopTgPolling() {
  if (!tgPollTimer) return;
  clearInterval(tgPollTimer);
  tgPollTimer = null;
}
// –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
async function checkTgStatus() {
  try {
    const r = await fetch('/api/me/telegram/status', { headers: { 'Accept': 'application/json' } });
    if (!r.ok) return;
    const j = await r.json();
    if (j && j.linked) {
      // –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      switchToLinkedView();
    }
  } catch (_) { /* no-op */ }
}

// –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Ç–∞–∫–∂–µ –æ–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –±–æ–ª—å—à–µ–π —è—Å–Ω–æ—Å—Ç–∏
function setTgStatusWaiting() {
  const dot = document.getElementById('tgStatusDot');
  const ping = document.getElementById('tgStatusPing');
  const text = document.getElementById('tgStatusText');
  if (dot) dot.className = 'relative inline-flex rounded-full h-2.5 w-2.5 bg-amber-500';
  if (ping) ping.style.display = 'inline-flex';
  if (text) text.textContent = '–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ‚Ä¶';
}
function setTgStatusLinked() {
  const dot = document.getElementById('tgStatusDot');
  const ping = document.getElementById('tgStatusPing');
  const text = document.getElementById('tgStatusText');
  if (dot) dot.className = 'relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500';
  if (ping) ping.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—É–ª—å—Å–∞—Ü–∏–∏
  if (text) text.textContent = '–°—Ç–∞—Ç—É—Å: –ê–∫–∫–∞—É–Ω—Ç –ø—Ä–∏–≤—è–∑–∞–Ω';
}


    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.selection-card').forEach(card => {
            card.addEventListener('click', () => {
                const group = card.dataset.group;
                document.querySelectorAll(`.selection-card[data-group="${group}"]`).forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                document.getElementById(`${group}Input`).value = card.dataset.value;
            });
        });

        const metricsHeader = document.getElementById('metrics-header');
        if (metricsHeader) {
            const detailsView = document.getElementById('metrics-details-view');
            const iconsView = document.getElementById('metrics-icons-view');
            const toggleText = document.getElementById('metrics-toggle-text');
            const toggleIcon = document.getElementById('metrics-toggle-icon');
            metricsHeader.addEventListener('click', () => {
                const isCollapsed = detailsView.classList.contains('hidden');
                detailsView.classList.toggle('hidden', !isCollapsed);
                iconsView.classList.toggle('hidden', isCollapsed);
                toggleText.textContent = isCollapsed ? '–°–≤–µ—Ä–Ω—É—Ç—å' : '–í—Å–µ –¥–∞–Ω–Ω—ã–µ';
                toggleIcon.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(180deg)';
            });
        }
    });

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è ---
    const editProfileModal = document.getElementById('editProfileModal');
    function openEditProfileModal() {
        if (editProfileModal) {
            openModal('editProfileModal');

        }
    }
    function closeEditProfileModal() {
        if (editProfileModal) {
            closeModal('editProfileModal');

        }
    }

    function confirmAndResetDiet() {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–∞—Ü–∏–æ–Ω? –û–Ω –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω, –∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π.")) {

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–æ—á–∫–∏
            const dietCard = document.getElementById('diet-card-container');
            const loader = document.createElement('div');
            loader.className = 'absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center rounded-xl z-20';
            loader.innerHTML = '<svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>';
            dietCard.appendChild(loader);

            fetch('/reset_diet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // –ü—Ä—è—á–µ–º –±–ª–æ–∫ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –¥–∏–µ—Ç—ã
                    document.getElementById('diet-display-section').style.display = 'none';
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å —Ñ–æ—Ä–º–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                    document.getElementById('diet-generation-section').style.display = 'block';
                } else {
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + data.message);
                }
            })
            .catch(err => {
                alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å —Ä–∞—Ü–∏–æ–Ω.');
            })
            .finally(() => {
                // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                dietCard.removeChild(loader);
            });
        }
    }
</script>
<script>
  // --- –û–¢–í–Ø–ó–ö–ê TELEGRAM ---
  async function unlinkTelegram() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–≤—è–∑–∞—Ç—å Telegram-–∞–∫–∫–∞—É–Ω—Ç?')) return;

    const btn = event?.currentTarget;
    if (btn) {
      btn.disabled = true;
      const orig = btn.textContent;
      btn.dataset._orig = orig;
      btn.textContent = '–û—Ç–≤—è–∑—ã–≤–∞–µ–º...';
    }

    // –ü—Ä–æ–±—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π REST-—ç–Ω–¥–ø–æ–∏–Ω—Ç; –ø—Ä–∏ 404 ‚Äî –∑–∞–ø–∞—Å–Ω–æ–π
    const endpoints = [
      { url: '/api/me/telegram/unlink',  method: 'POST' }, // –ø–æ–¥ —Å–µ–º–µ–π—Å—Ç–≤–æ /api/me/telegram/*
      { url: '/unlink_telegram',         method: 'POST' }  // –∑–∞–ø–∞—Å–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç, –µ—Å–ª–∏ —É —Ç–µ–±—è –æ–Ω —Ç–∞–∫–æ–π
    ];

    let ok = false, lastErr = null, respJson = null;

    for (const ep of endpoints) {
      try {
        const r = await fetch(ep.url, {
          method: ep.method,
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          credentials: 'same-origin',
          cache: 'no-store',
          body: ep.method === 'POST' ? JSON.stringify({}) : undefined
        });
        // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª JSON ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å (–Ω–æ –Ω–µ —É–ø–∞–¥—ë–º, –µ—Å–ª–∏ –ø—É—Å—Ç–æ)
        try { respJson = await r.clone().json(); } catch (_) { respJson = null; }

        if (r.ok && (!respJson || respJson.ok !== false)) { ok = true; break; }
        lastErr = new Error(`HTTP ${r.status}${respJson?.error ? `: ${respJson.error}` : ''}`);
      } catch (e) {
        lastErr = e;
      }
    }

    if (!ok) {
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–≤—è–∑–∞—Ç—å Telegram.' + (lastErr ? `\n–ü—Ä–∏—á–∏–Ω–∞: ${lastErr.message}` : ''));
      if (btn) { btn.disabled = false; btn.textContent = btn.dataset._orig || '–û—Ç–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç'; }
      return;
    }

    // –£—Å–ø–µ—à–Ω–æ –æ—Ç–≤—è–∑–∞–ª–∏: –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –º–æ–¥–∞–ª–∫—É –Ω–∞ ¬´–Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω¬ª
    try { stopTgPolling(); } catch (_) {}
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–∂–æ–∫ ¬´–ø—Ä–∏–≤—è–∑–∞–Ω¬ª –≤ UI
    const unlinked = document.getElementById('tg-unlinked-view');
    const linked   = document.getElementById('tg-linked-view');
    if (linked)   linked.classList.add('hidden');
    if (unlinked) unlinked.classList.remove('hidden');

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É
    const dot  = document.getElementById('tgStatusDot');
    const ping = document.getElementById('tgStatusPing');
    const txt  = document.getElementById('tgStatusText');
    if (dot)  dot.className = 'relative inline-flex rounded-full h-2.5 w-2.5 bg-amber-500';
    if (ping) ping.style.display = 'inline-flex';
    if (txt)  txt.textContent = '–°—Ç–∞—Ç—É—Å: –ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω';

    // –°–±—Ä–æ—Å–∏–º —Ñ–ª–∞–≥ –±–∏–Ω–¥–∏–Ω–≥–∞, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∞ —Å–≤–∏—Ç—á–∏ –ø—Ä–∏–≤—è–∑–∞–ª–∏—Å—å –∑–∞–Ω–æ–≤–æ
    if (typeof _tgSwitchesBound !== 'undefined') _tgSwitchesBound = false;

    // –û–±–Ω–æ–≤–∏–º –∫–Ω–æ–ø–∫—É Telegram –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –ø—Ä–æ—Ñ–∏–ª—è (–µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å)
    try {
      const btnTg = document.querySelector('.tg-attn-btn');
      if (btnTg) btnTg.classList.remove('linked');
      const check = document.querySelector('.tg-check');
      if (check) check.remove();
    } catch(_) {}

    // –ú–æ–∂–Ω–æ –º—è–≥–∫–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å —Å–µ—Ä–≤–µ—Ä–∞ ‚Äî –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
    try { await loadTgSettings(); } catch (_) {}

    if (btn) {
      btn.disabled = false;
      btn.textContent = btn.dataset._orig || '–û—Ç–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
    }

    // –ü–æ –∂–µ–ª–∞–Ω–∏—é: –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ—Å—Ç
    // closeTelegramModal();
    // alert('Telegram-–∞–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–≤—è–∑–∞–Ω.');
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const w = document.getElementById('weightChart');
  if (!w) return;                      // –∫–∞–Ω–≤–∞—Å–æ–≤ –Ω–µ—Ç ‚Äî –∑–Ω–∞—á–∏—Ç –∏ –≥—Ä–∞—Ñ–∏–∫–∏ –Ω–µ –Ω—É–∂–Ω—ã
  if (!window.Chart) {                 // –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
    console.warn('Chart.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è');
    return;
  }
  fetch('/api/user/weekly_summary', { cache: 'no-store' })
    .then(r => r.json())
    .then(data => {
      if (!data || !Array.isArray(data.labels) || !data.datasets) return;
      // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø—Ä–∏–≤–µ–¥—ë–º –∫ —á–∏—Å–ª–∞–º
      const labels = data.labels;
      const ds = {
        weight: (data.datasets.weight || []).map(Number),
        consumed_kcal: (data.datasets.consumed_kcal || []).map(Number),
        burned_kcal: (data.datasets.burned_kcal || []).map(Number),
      };
      renderCharts({ labels, datasets: ds });
    })
    .catch(err => console.error('Failed to load chart data:', err));
});

function renderCharts({ labels, datasets }) {
  const commonOptions = {
    responsive: true, maintainAspectRatio: false, animation: false, devicePixelRatio: 2,
    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
    scales: { x: { grid: { display: false } }, y: { beginAtZero: false, ticks: { maxTicksLimit: 5 } } },
    elements: { point: { radius: 2 }, line: { borderWidth: 2, tension: 0.4 } }
  };

  new Chart(document.getElementById('weightChart'), {
    type: 'line',
    data: { labels, datasets: [{ label: '–í–µ—Å', data: datasets.weight,
      borderColor: 'rgb(59,130,246)', backgroundColor: 'rgba(59,130,246,0.1)', fill: true }] },
    options: commonOptions
  });

  new Chart(document.getElementById('mealsChart'), {
    type: 'bar',
    data: { labels, datasets: [{ label: '–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–æ', data: datasets.consumed_kcal,
      borderColor: 'rgb(249,115,22)', backgroundColor: 'rgba(249,115,22,0.5)' }] },
    options: commonOptions
  });

  new Chart(document.getElementById('activityChart'), {
    type: 'bar',
    data: { labels, datasets: [{ label: '–°–æ–∂–∂–µ–Ω–æ', data: datasets.burned_kcal,
      borderColor: 'rgb(22,163,74)', backgroundColor: 'rgba(22,163,74,0.5)' }] },
    options: commonOptions
  });
}
</script>


<div id="deficitHistoryModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="closeDeficitHistoryModal()">
  <div class="card w-full max-w-2xl p-0 relative animate-fade-in" onclick="event.stopPropagation()">

    <div class="p-5 border-b border-slate-200 flex justify-between items-center">
        <h2 class="text-xl font-bold">–ò—Å—Ç–æ—Ä–∏—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–µ—Ñ–∏—Ü–∏—Ç–∞</h2>
        <button onclick="closeDeficitHistoryModal()" class="text-slate-400 text-2xl hover:text-slate-600">&times;</button>
    </div>

    <div class="p-6 max-h-[70vh] overflow-y-auto">
        <div id="deficit-loader" class="text-center py-10">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
            <p class="mt-2 text-slate-500">–ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é...</p>
        </div>

        <div id="deficit-content" class="hidden">
            </div>
    </div>
  </div>
</div>
<script>
    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ ---
const deficitModal = document.getElementById('deficitHistoryModal');
const deficitLoader = document.getElementById('deficit-loader');
const deficitContent = document.getElementById('deficit-content');

function showDeficitHistory() {
    if (!deficitModal) return;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –∑–∞–≥—Ä—É–∑—á–∏–∫
    deficitModal.classList.remove('hidden');
    deficitModal.classList.add('flex');
    deficitLoader.classList.remove('hidden');
    deficitContent.classList.add('hidden');
    deficitContent.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ

    fetch('/api/user/deficit_history')
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                deficitContent.innerHTML = `<p class="text-center text-red-500">${data.error}</p>`;
            } else {
                let tableHtml = `
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-600 sticky top-0">
                            <tr>
                                <th class="p-2">–î–∞—Ç–∞</th>
                                <th class="p-2 text-right text-red-600">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–æ</th>
                                <th class="p-2 text-right text-green-600">–°–æ–∂–∂–µ–Ω–æ (–ë–∞–∑–∞ + –ê–∫—Ç)</th>
                                <th class="p-2 text-right text-blue-600">–î–µ—Ñ–∏—Ü–∏—Ç –∑–∞ –¥–µ–Ω—å</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let totalDeficit = 0;
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (—Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ)
                data.reverse().forEach(day => {
                    totalDeficit += day.deficit;

                    // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
                    // –ï—Å–ª–∏ —ç—Ç–æ –¥–µ–Ω—å –∑–∞–º–µ—Ä–∞, –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É
                    if (day.is_measurement_day) {
                        tableHtml += `
                            <tr class="bg-blue-50 border-b">
                                <td class="p-2 text-sm font-semibold text-blue-800" colspan="4">
                                    <div class="flex items-center gap-2">
                                        <i class="bi bi-rulers"></i>
                                        <span>–ù–æ–≤—ã–π –∑–∞–º–µ—Ä —Ç–µ–ª–∞</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                    // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

                    tableHtml += `
                        <tr class="border-b hover:bg-slate-50">
                            <td class="p-2 font-medium">${day.date}</td>
                            <td class="p-2 text-right">${day.consumed} –∫–∫–∞–ª</td>
                            <td class="p-2 text-right">${day.total_burned} –∫–∫–∞–ª</td>
                            <td class="p-2 text-right font-bold">${day.deficit} –∫–∫–∞–ª</td>
                        </tr>
                    `;
                });

                tableHtml += `
                        </tbody>
                        <tfoot>
                            <tr class="bg-slate-100 font-bold sticky bottom-0">
                                <td class="p-2" colspan="3">–ò—Ç–æ–≥–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ –¥–µ—Ñ–∏—Ü–∏—Ç–∞:</td>
                                <td class="p-2 text-right text-blue-700 text-base">${Math.round(totalDeficit)} –∫–∫–∞–ª</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
                deficitContent.innerHTML = tableHtml;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
            deficitLoader.classList.add('hidden');
            deficitContent.classList.remove('hidden');
        })
        .catch(err => {
            deficitContent.innerHTML = `<p class="text-center text-red-500">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –û—à–∏–±–∫–∞: ${err}</p>`;
            deficitLoader.classList.add('hidden');
            deficitContent.classList.remove('hidden');
        });
}

function closeDeficitHistoryModal() {
    if (deficitModal) {
        deficitModal.classList.add('hidden');
        deficitModal.classList.remove('flex');
    }
}

    function lockScroll(lock = true) {
  document.documentElement.style.overflow = lock ? 'hidden' : '';
}

function trapFocus(modalEl) {
  const focusables = modalEl.querySelectorAll(
    'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'
  );
  if (!focusables.length) return;
  const first = focusables[0], last = focusables[focusables.length - 1];
  modalEl.addEventListener('keydown', (e) => {
    if (e.key !== 'Tab') return;
    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault(); last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault(); first.focus();
    }
  });
  (first || modalEl).focus();
}

function openModal(id) {
  const m = document.getElementById(id);
  if (!m) return;
  m.classList.remove('hidden'); m.classList.add('flex');
  lockScroll(true);
  setTimeout(() => trapFocus(m), 0);
}

function closeModal(id) {
  const m = document.getElementById(id);
  if (!m) return;
  m.classList.add('hidden'); m.classList.remove('flex');
  lockScroll(false);
}

</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // –î–û: —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ selection-card.
    // –î–û–ü–û–õ–ù–ï–ù–ò–ï: –¥–ª—è –≥—Ä—É–ø–ø—ã gender ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ aria-pressed
    document.querySelectorAll('.selection-card-gender').forEach(card => {
      card.addEventListener('click', () => {
        // aria
        document.querySelectorAll('.selection-card-gender').forEach(c => c.setAttribute('aria-pressed','false'));
        card.setAttribute('aria-pressed','true');

        // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ (–ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º classflow)
                card.classList.add('selected');
      });
    });
  });
</script>
<!-- Onboarding Tour (vanilla JS, robust) -->
<div id="tour-dim" style="display:none">
  <div class="dim dim-top"></div>
  <div class="dim dim-right"></div>
  <div class="dim dim-bottom"></div>
  <div class="dim dim-left"></div>
</div>
<div id="tour-box" style="display:none; position:absolute; z-index:10000; background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.2); padding:16px; max-width:320px;"></div>
<div id="tour-highlight" style="display:none; position:absolute; z-index:9999; border:2px solid #6366f1; border-radius:14px; box-shadow:0 0 0 8px rgba(99,102,241,.2); pointer-events:none;"></div>

<script>
(function(){
  try{
    const uid = "{{ user.id if user else 'anon' }}";
    // const DONE = ...; // –ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ
    const ACTIVE = `dietaai_onboarding_active_${uid}`;
    const STEP = `dietaai_onboarding_step_${uid}`;

    // –ù–ï –∑–∞–≤–∏—Å—è –æ—Ç Jinja: —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞
    const path = window.location.pathname;

    // –ò–°–ü–û–õ–¨–ó–£–ï–ú –ù–û–í–£–Æ –ü–ï–†–ï–ú–ï–ù–ù–£–Æ –ò–ó –ë–≠–ö–ï–ù–î–ê
    const serverStart = {{ 'true' if (start_onboarding_tour|default(false)) else 'false' }};

    const urlParams = new URLSearchParams(location.search);
    const force = urlParams.get('tour') === '1';
    const debug = urlParams.get('debug') === '1';

    // –ü–†–û–í–ï–†–ö–ê –°–¢–ê–†–¢–ê –¢–ï–ü–ï–†–¨ –ó–ê–í–ò–°–ò–¢ –¢–û–õ–¨–ö–û –û–¢ –°–ï–†–í–ï–†–ê
    const shouldStart = force || serverStart;

    const steps = [
      {id:'welcome',  title:'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üëã', body:'–ó–∞ <b>30 —Å–µ–∫—É–Ω–¥</b> –ø–æ–∫–∞–∂—É –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã. –ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∫–∞–∂–∏ –º–Ω–µ¬ª.', route:'/profile',  target:null,                    placement:'center'},
      {id:'measure',  title:'–ó–∞–º–µ—Ä —Ç–µ–ª–∞',           body:'–í —ç—Ç–æ–º –±–ª–æ–∫–µ –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–º–µ—Ä–∞ —Ç–µ–ª–∞ ‚Äî –æ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ.', route:'/profile',  target:'#body-measure-card',  placement:'right'},
      {id:'diet',     title:'¬´–ü—Ä–∏—ë–º—ã –ø–∏—â–∏¬ª',        body:'–ó–∞–≥—Ä—É–∂–∞–π—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–≤–æ–¥–∏—Ç–µ —Å–æ—Å—Ç–∞–≤ ‚Äî —è –ø–æ—Å—á–∏—Ç–∞—é –∫–∫–∞–ª –∏ –ë–ñ–£ –∏ –¥–∞–º –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥.',               route:'/meals',    target:'#tab-diet-panel',     placement:'top'},
      {id:'activity', title:'¬´–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å¬ª',         body:'–î–æ–±–∞–≤–ª—è–π—Ç–µ —à–∞–≥–∏ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.',                 route:'/activity', target:'#tab-activity-panel', placement:'top'},
      {id:'metrics',  title:'¬´–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ç–µ–ª–∞¬ª',    body:'–°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ —Ç–µ–∫—É—â–∏–µ –∏ –ø—Ä–æ—à–ª—ã–µ –∑–∞–º–µ—Ä—ã. –ó–¥–µ—Å—å –≥—Ä–∞—Ñ–∏–∫–∏ –¥–∏–Ω–∞–º–∏–∫–∏.',                                route:'/metrics',  target:'#tab-metrics-panel',  placement:'top'}
    ];

    const dim = document.getElementById('tour-dim');
    const box = document.getElementById('tour-box');
    const hl  = document.getElementById('tour-highlight');

    let i = 0;

    function log(...a){ if(debug) console.log('[TOUR]', ...a); }

    function start(fromIdx){
      i = isNaN(fromIdx) ? 0 : fromIdx;
      localStorage.setItem(ACTIVE,'1');
      show();
      log('start', {i, path});
      // –º–∞–ª–µ–Ω—å–∫–∏–π –±–µ–π–¥–∂ –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∂–∏–≤
      if(force && !document.getElementById('tour-badge')){
        const b = document.createElement('div');
        b.id='tour-badge';
        b.textContent='–¢—É—Ä –∞–∫—Ç–∏–≤–µ–Ω';
        Object.assign(b.style,{position:'fixed',top:'10px',right:'10px',padding:'6px 10px',background:'#22c55e',color:'#fff',borderRadius:'12px',zIndex:10001,fontSize:'12px'});
        document.body.appendChild(b);
        setTimeout(()=>b.remove(),3000);
      }
    }

    // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø END
    function end(){
      hideAll();

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–º–µ—Ç–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä, —á—Ç–æ —Ç—É—Ä –ø—Ä–æ–π–¥–µ–Ω
      fetch('/api/onboarding/complete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
      }).catch(err => console.error('Failed to save tour status:', err));

      // localStorage.setItem(DONE,'1'); // –ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ
      localStorage.removeItem(ACTIVE);
      localStorage.removeItem(STEP);
      log('end');
    }

    function next(){
      if(i < steps.length - 1){ i++; go(); }
      else { end(); }
    }
    function prev(){
      if(i > 0){ i--; go(); }
    }
    function show(){ go(); }

    function go(){
      const s = steps[i];
      log('go step', i, s.id, 'current path:', path);
      if(path !== s.route){
        localStorage.setItem(STEP, String(i));
        const q = force ? (location.search.includes('tour=1') ? location.search : '?tour=1') : '';
        location.href = s.route + q;
        return;
      }
      dim.style.display='block';
      box.style.display='block';
      position(s);
      renderBox(s);
    }

    function renderBox(s){
      const isFirst = i===0, isLast = i===steps.length-1;
      box.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:6px;">${s.title}</div>
        <div style="color:#475569; font-size:14px; margin-bottom:10px;">${s.body}</div>
        <div style="display:flex; gap:8px; align-items:center;">
          ${i>0?'<button id="tour-prev" style="padding:8px 10px; font-size:12px; border-radius:12px; background:#f1f5f9; border:1px solid #e2e8f0;">–ù–∞–∑–∞–¥</button>':''}
          ${!isLast?'<button id="tour-skip" style="padding:8px 10px; font-size:12px; border-radius:12px; background:#f1f5f9; border:1px solid #e2e8f0;">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>':''}
          <button id="tour-next" style="margin-left:auto; padding:8px 12px; font-size:12px; border-radius:12px; background:#4f46e5; color:#fff; border:1px solid #4338ca;">${isFirst?'–ü–æ–∫–∞–∂–∏ –º–Ω–µ':(isLast?'–ì–æ—Ç–æ–≤–æ':'–ü–æ–Ω—è–ª, –¥–∞–ª—å—à–µ')}</button>
        </div>
        <div style="margin-top:6px; font-size:12px; color:#94a3b8;">–®–∞–≥ ${i+1} –∏–∑ ${steps.length}</div>
      `;
      document.getElementById('tour-next').onclick=next;
      const p=document.getElementById('tour-prev'); if(p) p.onclick=prev;
      const sk=document.getElementById('tour-skip'); if(sk) sk.onclick=end;
    }

// --- –•–µ–ª–ø–µ—Ä—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  const SAFE = 12; // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—ë–≤ —ç–∫—Ä–∞–Ω–∞

  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

  function measureBox(){
    const rect = document.getElementById('tour-box').getBoundingClientRect();
    return { w: rect.width || 320, h: rect.height || 180 };
  }

  function fits(pos, size, view){
    const right  = pos.left + size.w;
    const bottom = pos.top  + size.h;
    return (
      pos.left  >= view.left  + SAFE &&
      pos.top   >= view.top   + SAFE &&
      right     <= view.right - SAFE &&
      bottom    <= view.bottom- SAFE
    );
  }

  // –≤–µ—Ä–Ω—ë—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
  function candidatePlacements(pref){
    const all = ['right','left','top','bottom'];
    const order = [pref, ...all.filter(x => x !== pref)];
    // –ø–æ—Å–ª–µ–¥–Ω–∏–º –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–±—É–µ–º ¬´bottom-center –≤–Ω—É—Ç—Ä–∏ —ç–∫—Ä–∞–Ω–∞¬ª
    order.push('screen-bottom-center');
    return order;
  }

  // —Ä–∞—Å—á—ë—Ç –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
  function computePosFor(placement, targetRect, boxSize, view){
    const midX = targetRect.left + targetRect.width / 2;
    const midY = targetRect.top  + targetRect.height / 2;

    if(placement === 'right'){
      return {
        top:  clamp(targetRect.top + window.scrollY, view.top + SAFE, view.bottom - SAFE - boxSize.h),
        left: clamp(targetRect.right + 16 + window.scrollX, view.left + SAFE, view.right - SAFE - boxSize.w)
      };
    }
    if(placement === 'left'){
      return {
        top:  clamp(targetRect.top + window.scrollY, view.top + SAFE, view.bottom - SAFE - boxSize.h),
        left: clamp(targetRect.left - boxSize.w - 16 + window.scrollX, view.left + SAFE, view.right - SAFE - boxSize.w)
      };
    }
    if(placement === 'top'){
      return {
        top:  clamp(targetRect.top - boxSize.h - 16 + window.scrollY, view.top + SAFE, view.bottom - SAFE - boxSize.h),
        left: clamp(midX - boxSize.w/2 + window.scrollX, view.left + SAFE, view.right - SAFE - boxSize.w)
      };
    }
    if(placement === 'bottom'){
      return {
        top:  clamp(targetRect.bottom + 16 + window.scrollY, view.top + SAFE, view.bottom - SAFE - boxSize.h),
        left: clamp(midX - boxSize.w/2 + window.scrollX, view.left + SAFE, view.right - SAFE - boxSize.w)
      };
    }
    // –§–æ–ª–ª–±—ç–∫: –ø–æ–º–µ—Å—Ç–∏—Ç—å –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å–Ω–∏–∑—É (–≤–Ω—É—Ç—Ä–∏ —ç–∫—Ä–∞–Ω–∞)
    return {
      top:  view.bottom - SAFE - boxSize.h,
      left: view.left + (view.width - boxSize.w) / 2
    };
  }

function position(s){
  const t   = s.target ? document.querySelector(s.target) : null;
  const box = document.getElementById('tour-box');
  const hl  = document.getElementById('tour-highlight');

  // –ê–∫—Ç—É–∞–ª—å–Ω—ã–π ¬´–≤–∏–¥–∏–º—ã–π¬ª –≤—å—é–ø–æ—Ä—Ç (—Å —É—á—ë—Ç–æ–º –∫–ª–∞–≤—ã/URL-–±–∞—Ä–∞)
  function getView(){
    const vv = window.visualViewport;
    if (vv) {
      const top  = vv.pageTop  ?? window.scrollY;
      const left = vv.pageLeft ?? window.scrollX;
      const width  = vv.width;
      const height = vv.height;
      return {
        top, left, width, height,
        get right(){ return left + width; },
        get bottom(){ return top + height; }
      };
    }
    // —Ñ–æ–ª–ª–±—ç–∫
    const top = window.scrollY, left = window.scrollX;
    const width = window.innerWidth, height = window.innerHeight;
    return {
      top, left, width, height,
      get right(){ return left + width; },
      get bottom(){ return top + height; }
    };
  }

  const view = getView();

  // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–∞—Ä–≥–µ—Ç–∞ ‚Äî —Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞
  if(!t){
    const size = measureBox();
    box.style.display = 'block';
    box.style.top  = (view.top + (view.height - size.h)/2) + 'px';
    box.style.left = (view.left + (view.width  - size.w)/2) + 'px';
    hl.style.display = 'none';
    setDimHole(0, 0, 0, 0);
    return;
  }

  t.scrollIntoView({ behavior:'smooth', block:'center', inline:'nearest' });

  setTimeout(()=>{
    const r = t.getBoundingClientRect();       // viewport-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–ª–∏
    const v = getView();                        // –≤–æ–∑–º–æ–∂–µ–Ω —Ä–µ—Å–∞–π–∑/—Å—Ö–ª–æ–ø –±–∞—Ä–æ–≤

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞: –≤–Ω—É—Ç—Ä–∏ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
    const pad = 8;
    const hlTop  = clamp(r.top  + v.top - pad,  v.top + SAFE, v.bottom - SAFE - 20);
    const hlLeft = clamp(r.left + v.left - pad, v.left+ SAFE, v.right  - SAFE - 20);
    const hlW = Math.min(r.width  + pad*2, v.width  - SAFE*2);
    const hlH = Math.min(r.height + pad*2, v.height - SAFE*2);

    hl.style.display = 'block';
    hl.style.top = hlTop + 'px'; hl.style.left = hlLeft + 'px';
    hl.style.width = hlW + 'px'; hl.style.height = hlH + 'px';

    // ¬´–î—ã—Ä–∫–∞¬ª ‚Äî –≤–æ –≤—å—é–ø–æ—Ä—Ç–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö (visualViewport.width/height)
    const vw = (window.visualViewport?.width)  || window.innerWidth;
    const vh = (window.visualViewport?.height) || window.innerHeight;
    const holeX = clamp(r.left - pad, 0, vw);
    const holeY = clamp(r.top  - pad, 0, vh);
    const holeW = Math.min(r.width  + pad*2, vw - holeX);
    const holeH = Math.min(r.height + pad*2, vh - holeY);
    setDimHole(holeX, holeY, holeW, holeH);

    // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–æ–ª–æ–∂–∏—Ç—å –±–æ–∫—Å –≤–æ–∫—Ä—É–≥ —Ü–µ–ª–∏
    const boxSize  = measureBox();
    const preferred= s.placement || 'bottom';
    const variants = candidatePlacements(preferred);

    let placed = false;
    for (const p of variants){
      const pos = computePosFor(p, r, boxSize, v);
      const ok  = (p === 'screen-bottom-center') ? true : fits(pos, boxSize, v);
      if (ok){
        box.style.display = 'block';
        box.style.top  = clamp(pos.top,  v.top  + SAFE, v.bottom - SAFE - boxSize.h) + 'px';
        box.style.left = clamp(pos.left, v.left + SAFE, v.right  - SAFE - boxSize.w) + 'px';
        placed = true;
        break;
      }
    }
    if (!placed){
      const posTop  = v.top  + (v.height - boxSize.h)/2;
      const posLeft = v.left + (v.width  - boxSize.w)/2;
      box.style.top  = clamp(posTop,  v.top  + SAFE, v.bottom - SAFE - boxSize.h) + 'px';
      box.style.left = clamp(posLeft, v.left + SAFE, v.right  - SAFE - boxSize.w) + 'px';
    }
  }, 350);
}


    function hideAll(){
      dim.style.display='none';
      box.style.display='none';
      hl.style.display='none';
    }

let _raf = null;
function scheduleReposition(){
  if (_raf) return;
  _raf = requestAnimationFrame(()=>{ _raf = null; position(steps[i]); });
}

window.addEventListener('resize',  ()=>{ if(box.style.display!=='none') scheduleReposition(); });
window.addEventListener('scroll',  ()=>{ if(box.style.display!=='none') scheduleReposition(); }, { passive:true });
window.addEventListener('orientationchange', ()=>{ if(box.style.display!=='none') scheduleReposition(); });

if (window.visualViewport){
  visualViewport.addEventListener('resize', ()=>{ if(box.style.display!=='none') scheduleReposition(); });
  visualViewport.addEventListener('scroll', ()=>{ if(box.style.display!=='none') scheduleReposition(); }, { passive:true });
}

    // –°—Ç–∞—Ä—Ç –ø–æ—Å–ª–µ DOMContentLoaded, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –±—ã–ª –¥–æ–∫—É–º–µ–Ω—Ç
    document.addEventListener('DOMContentLoaded', ()=>{
      const active = localStorage.getItem(ACTIVE)==='1';
      const storedIdx = parseInt(localStorage.getItem(STEP)||'0',10);

      // shouldStart —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º
      if(shouldStart || active){
        // —á—É—Ç—å –ø–æ–∑–∂–µ, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ —É—Å–ø–µ–ª –¥–æ—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è
        setTimeout(()=> start(active ? storedIdx : 0), 500);
      } else {
        log('skip start: flags say not to start');
      }
    });

  }catch(err){
    console.error('[TOUR] Fatal error:', err);
  }
})();
</script>

<script>
    // –æ–¥–∏–Ω —Ä–∞–∑ —Å–æ–∑–¥–∞–¥–∏–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç—ã
const _dim = document.getElementById('tour-dim');
const _dimEls = {
  top:   _dim?.querySelector('.dim-top'),
  right: _dim?.querySelector('.dim-right'),
  bottom:_dim?.querySelector('.dim-bottom'),
  left:  _dim?.querySelector('.dim-left'),
};

function setDimHole(x, y, w, h){
  const vv = window.visualViewport;
  const vw = vv?.width  ?? window.innerWidth;
  const vh = vv?.height ?? window.innerHeight;

  // –≤–µ—Ä—Ö–Ω—è—è –ø–æ–ª–æ—Å–∞
  Object.assign(_dimEls.top.style, {
    top: '0px', left: '0px', width: '100vw', height: `${Math.max(0, y)}px`
  });

  // –ª–µ–≤–∞—è –ø–æ–ª–æ—Å–∞
  Object.assign(_dimEls.left.style, {
    top: `${y}px`, left: '0px',
    width: `${Math.max(0, x)}px`, height: `${h}px`
  });

  // –ø—Ä–∞–≤–∞—è –ø–æ–ª–æ—Å–∞
  const rx = Math.max(0, x + w);
  Object.assign(_dimEls.right.style, {
    top: `${y}px`, left: `${rx}px`,
    width: `${Math.max(0, vw - rx)}px`, height: `${h}px`
  });

  // –Ω–∏–∂–Ω—è—è –ø–æ–ª–æ—Å–∞
  const by = Math.max(0, y + h);
  Object.assign(_dimEls.bottom.style, {
    top: `${by}px`, left: '0px',
    width: '100vw', height: `${Math.max(0, vh - by)}px`
  });
}

</script>

<div id="uploadAnalysisPreloader" class="fixed inset-0 bg-white/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4 animate-fade-in">
  <div class="text-center">
    <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="mt-4 text-lg font-semibold text-slate-700">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...</p>
    <p class="text-slate-500">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.</p>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // --- –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê –î–õ–Ø –ó–ê–ì–†–£–ó–ö–ò –ê–ù–ê–õ–ò–ó–ê ---
    const uploadForm = document.getElementById('uploadForm');
    const preloader = document.getElementById('uploadAnalysisPreloader');
    const notificationContainer = document.getElementById('profile-notifications'); // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ div —Å id="profile-notifications" –µ—Å—Ç—å –≤ HTML

    if (uploadForm && preloader && notificationContainer) {
      uploadForm.addEventListener('submit', async function(event) {
        event.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

        const fileInput = uploadForm.querySelector('input[type="file"]');
        const submitButton = uploadForm.querySelector('button[type="submit"]');

        notificationContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ—à–∏–±–∫–∏

        if (!fileInput || fileInput.files.length === 0) {
          // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω, –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å
          const errorHtml = `
              <div class="p-4 text-sm rounded-lg bg-yellow-100 text-yellow-800 border border-yellow-200 animate-fade-in">
                <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.
              </div>
            `;
          notificationContainer.innerHTML = errorHtml;
          return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        preloader.classList.remove('hidden');
        preloader.classList.add('flex');
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.innerHTML = `<span class="inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span><span class="ml-2">–ê–Ω–∞–ª–∏–∑...</span>`;
        }

        const formData = new FormData(uploadForm);

        try {
          const response = await fetch('/upload_analysis', {
            method: 'POST',
            body: formData
          });
          const data = await response.json();

          if (response.ok && data.success) {
            // –ï—Å–ª–∏ –≤—Å–µ —Ö–æ—Ä–æ—à–æ, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            window.location.href = data.redirect_url;
          } else {
            // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–µ
            const errorHtml = `
              <div class="p-4 text-sm rounded-lg bg-red-100 text-red-800 border border-red-200 animate-fade-in">
                <b>–û—à–∏–±–∫–∞:</b> ${data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.'}
              </div>
            `;
            notificationContainer.innerHTML = errorHtml;
          }
        } catch (error) {
          // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ (—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏ —Ç.–¥.)
          const errorHtml = `<div class="p-4 text-sm rounded-lg bg-red-100 text-red-800 border border-red-200 animate-fade-in"><b>–û—à–∏–±–∫–∞:</b> –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.</div>`;
          notificationContainer.innerHTML = errorHtml;
        } finally {
          // –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ (—É—Å–ø–µ—Ö –∏–ª–∏ –æ—à–∏–±–∫–∞) —É–±–∏—Ä–∞–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
          preloader.classList.add('hidden');
          preloader.classList.remove('flex');
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å';
          }
        }
      });
    }
    // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê ---

    // –û—Å—Ç–∞–ª—å–Ω–æ–π –≤–∞—à JavaScript-–∫–æ–¥ –∏–∑ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    const popupOverlay = document.getElementById('subscriptionPopupOverlay');

    function closeSubscriptionPopup() {
      if (popupOverlay) {
        fetch('/api/dismiss_welcome_popup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        }).catch(err => console.error("Failed to dismiss popup on server:", err));
        popupOverlay.style.transition = 'opacity 0.3s ease';
        popupOverlay.style.opacity = '0';
        setTimeout(() => {
          popupOverlay.style.display = 'none';
          lockScroll(false);
        }, 300);
      }
    }

    if (popupOverlay) {
      popupOverlay.addEventListener('click', function(event) {
        if (event.target === popupOverlay) {
          closeSubscriptionPopup();
        }
      });
    }

    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeSubscriptionPopup();
      }
    });

    // ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π JS –∏–∑ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞ ...
    // (–ª–æ–≥–∏–∫–∞ –¥–ª—è –±–∞–Ω–Ω–µ—Ä–∞, –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω, —á–∞—Ä—Ç–∞ –∏ —Ç.–¥.)
  });

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ---
function confirmAndResetGoals() {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Ü–µ–ª–∏ –∏ –Ω–∞—á–∞—Ç—å –æ—Ç—Å—á–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–Ω–æ–≤–æ? –¢–µ–∫—É—â–∞—è –∏—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞, –∏ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–º–µ—Ä–æ–º –≤—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ç–∞—Ä—Ç–æ–≤—É—é —Ç–æ—á–∫—É.")) {
        fetch('/profile/reset_goals', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                const notificationContainer = document.getElementById('profile-notifications');
                if (notificationContainer) {
                    notificationContainer.innerHTML = `
                        <div class="p-4 text-sm rounded-lg bg-green-100 text-green-800 border border-green-200 animate-fade-in">
                            <b>–£—Å–ø–µ—Ö:</b> –í–∞—à–∏ —Ü–µ–ª–∏ —Å–±—Ä–æ—à–µ–Ω—ã. –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–µ–π—á–∞—Å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è.
                        </div>`;
                }
                setTimeout(() => window.location.reload(), 2000);
            } else {
                alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Ü–µ–ª–µ–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
            }
        })
        .catch(error => {
            console.error('Error resetting goals:', error);
            alert("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–±—Ä–æ—Å.");
        });
    }
}

// --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —á–µ–∫–ø–æ–π–Ω—Ç–æ–≤ –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–µ ---
document.addEventListener('DOMContentLoaded', function() {
    const progressDataContainer = document.getElementById('progress-data-container');
    if (!progressDataContainer) return;

    const checkpointsContainer = document.getElementById('progress-checkpoints');
    const analysesJson = progressDataContainer.dataset.analyses;
    const initialKg = parseFloat(progressDataContainer.dataset.initialKg);
    const goalKg = parseFloat(progressDataContainer.dataset.goalKg);

    if (!analysesJson || isNaN(initialKg) || isNaN(goalKg)) return;

    const totalToLose = initialKg - goalKg;
    if (totalToLose <= 0) return; // –ù–µ—á–µ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å

    try {
        const analyses = JSON.parse(analysesJson);
        if (!Array.isArray(analyses)) return;

        analyses.forEach((analysis, index) => {
            const fatMass = parseFloat(analysis.fat_mass);
            if (isNaN(fatMass)) return;

            const lostSoFar = initialKg - fatMass;
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0 –¥–æ 100, —á—Ç–æ–±—ã —á–µ–∫–ø–æ–π–Ω—Ç—ã –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã
            const positionPercent = Math.min(100, Math.max(0, (lostSoFar / totalToLose) * 100));

            const checkpoint = document.createElement('div');
            checkpoint.className = 'progress-checkpoint';
            checkpoint.style.left = `${positionPercent}%`;
            checkpoint.textContent = index + 1;

            const timestamp = new Date(analysis.timestamp);
            const formattedDate = timestamp.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });

            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.innerHTML = `
                <div>${formattedDate}</div>
                <div class="font-bold">${fatMass.toFixed(1)} –∫–≥ –∂–∏—Ä–∞</div>
            `;

            checkpoint.appendChild(tooltip);
            checkpointsContainer.appendChild(checkpoint);
        });

    } catch (e) {
        console.error("Failed to parse or render progress checkpoints:", e);
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ –∏—Ö ID
    const progressCard = document.getElementById('fat-loss-progress-card');
    const uploadCard = document.getElementById('upload-analysis-card');
    const placeholder = document.getElementById('start-progress-placeholder');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    if (progressCard && uploadCard && placeholder) {

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        progressCard.addEventListener('click', function() {

            // –≠—Ç–∞ –ª–æ–≥–∏–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –±–ª–æ–∫-–∑–∞–≥–ª—É—à–∫–∞
            // (—Ç.–µ. —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—â–µ –Ω–µ—Ç –∑–∞–º–µ—Ä–æ–≤)
            if (getComputedStyle(placeholder).display !== 'none') {

                // 1. –ü–ª–∞–≤–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–∫–∞–∑–∞–ª–∞—Å—å –ø–æ —Ü–µ–Ω—Ç—Ä—É —ç–∫—Ä–∞–Ω–∞
                uploadCard.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });

                // 2. –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–∞—à—É CSS-–∞–Ω–∏–º–∞—Ü–∏—é –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                uploadCard.classList.add('flash-highlight');

                // 3. –ß–µ—Ä–µ–∑ 1.2 —Å–µ–∫—É–Ω–¥—ã (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏) —É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å.
                // –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –∞–Ω–∏–º–∞—Ü–∏—é –º–æ–∂–Ω–æ –±—ã–ª–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ.
                setTimeout(() => {
                    uploadCard.classList.remove('flash-highlight');
                }, 1200);
            }
        });
    }

   // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è ---
    const dobInput = document.getElementById('date_of_birth');
    if (dobInput) {
        const today = new Date();
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ YYYY-MM-DD –¥–ª—è –∞—Ç—Ä–∏–±—É—Ç–∞ max
        const maxDate = today.toISOString().split('T')[0];
        dobInput.setAttribute('max', maxDate);
    }

    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');

    if (newPasswordInput && confirmPasswordInput) {
        const validatePasswords = () => {
            const newPassValue = newPasswordInput.value;
            const confirmPassValue = confirmPasswordInput.value;

            // 1. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –≤–≤–æ–¥–∏—Ç—å –ø–∞—Ä–æ–ª—å –≤ –ª—é–±–æ–µ –∏–∑ –ø–æ–ª–µ–π,
            //    –¥–µ–ª–∞–µ–º –æ–±–∞ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.
            if (newPassValue || confirmPassValue) {
                newPasswordInput.required = true;
                confirmPasswordInput.required = true;
            } else {
                //    –ï—Å–ª–∏ –æ–±–∞ –ø–æ–ª—è –ø—É—Å—Ç—ã, –æ–Ω–∏ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.
                newPasswordInput.required = false;
                confirmPasswordInput.required = false;
            }

            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±–∞ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã.
            if (newPassValue && confirmPassValue && newPassValue !== confirmPassValue) {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                confirmPasswordInput.setCustomValidity("–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.");
            } else {
                // –ï—Å–ª–∏ –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ, —É–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                confirmPasswordInput.setCustomValidity('');
            }
        };

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ –ª—é–±–æ–º –∏–∑ –ø–æ–ª–µ–π
        newPasswordInput.addEventListener('input', validatePasswords);
        confirmPasswordInput.addEventListener('input', validatePasswords);
    }
});
</script>
{% endblock %}
