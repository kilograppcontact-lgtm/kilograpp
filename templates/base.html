<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kilogr.app</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>[x-cloak] { display: none !important; }</style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Golos+Text:wght@400;500;600;700&display=swap" />
  <style>
    body {
      font-family: 'Golos Text', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(to bottom, #f0f4f8 0%, #ffffff 100%);
      min-height: 100vh;
      font-weight: 500;
      letter-spacing: 0.1px;
    }
    h1, h2, h3, h4 {
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    .nav-link, .mobile-nav-link, .btn {
      font-weight: 600;
    }
    .nav-link {
      @apply text-gray-600 font-medium hover:text-blue-600 transition duration-200;
    }
    .mobile-nav-link {
        @apply block text-gray-700 py-2 px-4 text-base hover:bg-gray-100 rounded-md;
    }
    .nav-link-active {
      @apply text-blue-600 font-semibold;
    }
    .hover-scale {
      transition: transform 0.2s ease;
    }
    .hover-scale:hover {
      transform: scale(1.04);
    }
  </style>
</head>
<body class="flex flex-col">
<header
  x-data="{ open:false }"
  x-effect="document.documentElement.style.overflow = open ? 'hidden' : ''"
  class="sticky top-0 z-50 bg-white shadow-sm border-b border-slate-200
         md:bg-white/70 md:backdrop-blur-xl md:supports-[backdrop-filter]:bg-white/60 md:border-white/20">

  <div class="h-0.5 w-full bg-gradient-to-r from-indigo-400 via-sky-400 to-emerald-400"></div>

  <div class="max-w-7xl mx-auto px-4">
    <div class="flex items-center justify-between py-3">
      <a href="/profile" class="flex items-center gap-2 hover:opacity-90 transition">
        <img
          src="{{ url_for('static', filename='logo.png') }}"
          alt="Kilogr.app"
          class="h-10 md:h-11 w-auto object-contain"
          loading="lazy"
        />
      </a>

      <nav class="hidden md:flex items-center gap-2">
        {% if session.user_id %}
          {% if current_user and current_user.email == 'admin@healthclub.local' %}
            <a href="/admin"
               class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-yellow-100 text-yellow-800 font-semibold hover:bg-yellow-200 transition">
              <i class="bi bi-shield-lock"></i>
              <span>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</span>
            </a>
          {% endif %}
          <a href="/manual_activity"
             class="inline-flex px-4 py-2 rounded-full text-sm font-medium transition
                    {% if request.path == '/manual_activity' %} bg-slate-900 text-white shadow {% else %} text-slate-600 hover:text-slate-900 hover:bg-slate-100 {% endif %}">
            –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
          </a>
          <a href="/trainings-calendar"
             class="inline-flex px-4 py-2 rounded-full text-sm font-medium transition
                    {% if request.path == '/trainings-calendar' %} bg-slate-900 text-white shadow {% else %} text-slate-600 hover:text-slate-900 hover:bg-slate-100 {% endif %}">
            –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
          </a>
          {% if is_trainer_user %}
          <a href="/trainings"
             class="inline-flex px-4 py-2 rounded-full text-sm font-medium transition
                    {% if request.path == '/trainings' %} bg-slate-900 text-white shadow {% else %} text-slate-600 hover:text-slate-900 hover:bg-slate-100 {% endif %}">
            –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
          </a>
          {% endif %}
          <a href="/logout"
             class="ml-2 inline-flex px-4 py-2 rounded-full text-sm font-semibold text-red-600 hover:bg-red-50 transition">
            –í—ã–π—Ç–∏
          </a>
        {% else %}
          <a href="/login"
             class="inline-flex px-4 py-2 rounded-full text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 transition">
            –í—Ö–æ–¥
          </a>
          <a href="/register"
             class="inline-flex px-4 py-2 rounded-full text-sm font-semibold text-white
                    bg-gradient-to-r from-indigo-500 via-blue-500 to-sky-500 hover:from-indigo-600 hover:via-blue-600 hover:to-sky-600 shadow-md transition">
            –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
          </a>
        {% endif %}
      </nav>

      <button
        @click="open = true"
        class="md:hidden inline-flex items-center justify-center h-10 w-10 rounded-xl text-slate-700 hover:bg-slate-100 transition"
        aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">
        <i class="bi bi-list text-2xl"></i>
      </button>
    </div>
  </div>

  <div x-show="open" x-cloak class="fixed inset-0 z-50 md:hidden" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-black/50" @click="open=false"
         x-transition:enter="transition-opacity ease-out duration-250"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"></div>
    <aside
      class="absolute right-0 top-0 h-full w-[88vw] max-w-[380px] bg-white shadow-2xl rounded-l-2xl p-5 flex flex-col will-change-transform will-change-opacity"
      x-transition:enter="transform transition ease-out duration-300"
      x-transition:enter-start="translate-x-full opacity-0"
      x-transition:enter-end="translate-x-0 opacity-100"
      x-transition:leave="transform transition ease-in duration-200"
      x-transition:leave-start="translate-x-0 opacity-100"
      x-transition:leave-end="translate-x-full opacity-0">
      <div class="flex items-center justify-between mb-3">
        <span class="text-sm font-semibold text-slate-500">–ú–µ–Ω—é</span>
        <button @click="open=false" class="h-9 w-9 rounded-lg hover:bg-slate-100 text-slate-700">
          <i class="bi bi-x-lg text-xl"></i>
        </button>
      </div>
      <nav class="space-y-2" x-data x-init="$watch('open', v => {})">
        {% if session.user_id %}
          {% if current_user and current_user.email == 'admin@healthclub.local' %}
          <a href="/admin"
             x-show="open"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             :style="{ transitionDelay: (0*60)+'ms' }"
             class="flex w-full items-center gap-3 h-12 px-4 rounded-xl border border-yellow-200 bg-yellow-50 text-yellow-800 font-semibold shadow-sm hover:bg-yellow-100 transition">
            <i class="bi bi-shield-lock text-lg"></i>
            <span>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</span>
          </a>
          {% endif %}
          <a href="/manual_activity"
             x-show="open"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             :style="{ transitionDelay: (1*60)+'ms' }"
             class="flex w-full items-center gap-3 h-12 px-4 rounded-xl border border-slate-200 bg-white text-slate-800 font-semibold shadow-sm hover:bg-slate-50 active:bg-slate-100 transition">
            <i class="bi bi-plus-circle text-lg"></i>
            <span>–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
          </a>
          <a href="/trainings-calendar"
             x-show="open"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             :style="{ transitionDelay: (2*60)+'ms' }"
             class="flex w-full items-center gap-3 h-12 px-4 rounded-xl border border-slate-200 bg-white text-slate-800 font-semibold shadow-sm hover:bg-slate-50 active:bg-slate-100 transition">
            <i class="bi bi-calendar3 text-lg"></i>
            <span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
          </a>
          {% if is_trainer_user %}
          <a href="/trainings"
             x-show="open"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             :style="{ transitionDelay: (3*60)+'ms' }"
             class="flex w-full items-center gap-3 h-12 px-4 rounded-xl border border-slate-200 bg-white text-slate-800 font-semibold shadow-sm hover:bg-slate-50 active:bg-slate-100 transition">
            <i class="bi bi-dumbbell text-lg"></i>
            <span>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</span>
          </a>
          {% endif %}
          <a href="/logout"
             x-show="open"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             :style="{ transitionDelay: (4*60)+'ms' }"
             class="flex w-full items-center gap-3 h-12 px-4 rounded-xl border border-red-200 bg-red-50 text-red-700 font-semibold shadow-sm hover:bg-red-100 transition">
            <i class="bi bi-box-arrow-right text-lg"></i>
            <span>–í—ã–π—Ç–∏</span>
          </a>
        {% else %}
          <a href="/login"
             x-show="open"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             :style="{ transitionDelay: (0*60)+'ms' }"
             class="flex w-full items-center gap-3 h-12 px-4 rounded-xl border border-slate-200 bg-white text-slate-800 font-semibold shadow-sm hover:bg-slate-50 active:bg-slate-100 transition">
            <i class="bi bi-person text-lg"></i>
            <span>–í—Ö–æ–¥</span>
          </a>
          <a href="/register"
             x-show="open"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             :style="{ transitionDelay: (1*60)+'ms' }"
             class="flex w-full items-center gap-3 h-12 px-4 rounded-xl border border-transparent text-white font-semibold shadow
                    bg-gradient-to-r from-indigo-500 via-blue-500 to-sky-500 hover:from-indigo-600 hover:via-blue-600 hover:to-sky-600 transition">
            <i class="bi bi-person-plus text-lg"></i>
            <span>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
          </a>
        {% endif %}
      </nav>
      <div class="mt-auto pt-4 text-xs text-slate-400" x-show="open"
           x-transition:enter="transition-opacity ease-out duration-300"
           x-transition:enter-start="opacity-0"
           x-transition:enter-end="opacity-100">
        ¬© 2025 <span class="font-semibold text-slate-500">Kilogr.app</span>
      </div>
    </aside>
  </div>
</header>

<main class="flex-grow">
    {% block content %}{% endblock %}
</main>

{% if renewal_reminder_due and subscription_days_left and subscription_days_left > 0 %}
<div id="renewalPopupOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
  <div id="renewalPopupContent" class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 sm:p-8 relative text-center" onclick="event.stopPropagation()">
    <button onclick="closeRenewalPopup()" class="absolute top-4 right-4 text-slate-400 text-2xl hover:text-slate-600 transition-colors" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
    <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-gradient-to-br from-amber-400 to-pink-500 mb-5 shadow-lg">
      <span class="text-4xl text-white">‚åõ</span>
    </div>
    <h2 class="text-2xl font-bold text-slate-900">–ü–æ–¥–ø–∏—Å–∫–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ {{ subscription_days_left }} –¥–Ω.</h2>
    <p class="text-slate-600 mt-2">–ù–µ —Ç–µ—Ä—è–π—Ç–µ –¥–æ—Å—Ç—É–ø –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º –∏ –ò–ò-–¥–∏–µ—Ç–∞–º ‚Äî –ø—Ä–æ–¥–ª–∏—Ç–µ —Å–µ–π—á–∞—Å.</p>
    <div class="mt-6 grid grid-cols-2 gap-3 text-left">
      <div class="p-4 rounded-xl border border-emerald-200 bg-emerald-50">
        <div class="text-xs font-semibold text-emerald-700">–°–æ–∂–∂–µ–Ω–æ –∂–∏—Ä–∞ –∑–∞ –º–µ—Å—è—Ü</div>
        <div class="mt-1 text-2xl font-extrabold text-emerald-700">
          {{ (monthly_summary.fat_delta * -1)|round(2) if monthly_summary.fat_delta < 0 else 0 }} <span class="text-base">–∫–≥</span>
        </div>
      </div>
      <div class="p-4 rounded-xl border border-indigo-200 bg-indigo-50">
        <div class="text-xs font-semibold text-indigo-700">–ü—Ä–∏—Ä–æ—Å—Ç –º—ã—à—Ü –∑–∞ –º–µ—Å—è—Ü</div>
        <div class="mt-1 text-2xl font-extrabold text-indigo-700">
          {{ (monthly_summary.muscle_delta > 0) and (monthly_summary.muscle_delta|round(2)) or 0 }} <span class="text-base">–∫–≥</span>
        </div>
      </div>
    </div>
    <div class="mt-8 flex flex-col sm:flex-row gap-3 justify-center">
      <a href="{{ url_for('purchase_page') }}" class="w-full sm:w-auto px-6 py-3 rounded-full text-white font-semibold bg-indigo-600 hover:bg-indigo-700 transition">–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</a>
      <button onclick="closeRenewalPopup()" class="w-full sm:w-auto px-6 py-3 rounded-full text-slate-700 font-semibold bg-slate-200 hover:bg-slate-300 transition">–ù–∞–ø–æ–º–Ω–∏—Ç—å –ø–æ–∑–∂–µ</button>
    </div>
  </div>
</div>
<script>
  function closeRenewalPopup() {
    const renewalOverlay = document.getElementById('renewalPopupOverlay');
    if (!renewalOverlay) return;
    fetch('/api/dismiss_renewal_reminder', { method: 'POST' }).catch(()=>{});
    renewalOverlay.style.transition = 'opacity 0.3s ease';
    renewalOverlay.style.opacity = '0';
    setTimeout(() => { renewalOverlay.style.display = 'none'; }, 300);
  }
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') closeRenewalPopup();
  });
</script>
{% endif %}

<div class="fixed bottom-5 right-5 z-40 flex flex-col items-end gap-4">

    {% if show_help_button %}
    <div x-data="{ open: true }" x-show="open"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-x-4"
         x-transition:enter-end="opacity-100 translate-x-0"
         class="group flex items-center gap-3">
      <div class="hidden sm:block px-3 py-1.5 text-sm font-medium rounded-full bg-white text-indigo-800 border border-indigo-200 shadow-lg">
        –° —á–µ–≥–æ –Ω–∞—á–∞—Ç—å?
      </div>
      <a href="{{ url_for('instructions_page') }}"
         class="relative inline-flex items-center justify-center w-14 h-14 rounded-full shadow-xl
                bg-white border border-slate-200 text-indigo-600 transition transform hover:scale-105 active:scale-95">
        <span class="absolute -top-0.5 -right-0.5 flex h-3 w-3">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-3 w-3 bg-indigo-500"></span>
        </span>
        <i class="bi bi-question-circle text-2xl"></i>
      </a>
    </div>
    {% endif %}

    <!-- —á–∞—Ç: x-init –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å —Å–µ—Ä–≤–µ—Ä–∞ -->
    <div x-data="chatWidget()" x-init="loadHistory()">
      <div x-show="open" x-cloak
           x-transition:enter="transition ease-out duration-300"
           x-transition:enter-start="opacity-0 translate-y-4"
           x-transition:enter-end="opacity-100 translate-y-0"
           x-transition:leave="transition ease-in duration-200"
           x-transition:leave-start="opacity-100 translate-y-0"
           x-transition:leave-end="opacity-0 translate-y-4"
           @click.outside="open = false"
           class="absolute bottom-[80px] right-0 w-[90vw] max-w-sm h-[70vh] max-h-[500px] bg-white rounded-2xl shadow-2xl flex flex-col border border-slate-200/80">

        <div class="flex-shrink-0 flex items-center justify-between p-3 border-b bg-slate-50 rounded-t-2xl">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-sky-400 flex items-center justify-center text-white">
              <i class="bi bi-stars"></i>
            </div>
            <div>
              <h3 class="font-bold text-slate-800 text-sm">AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h3>
              <p class="text-xs text-slate-500">–ü–æ–º–æ–≥—É —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π</p>
            </div>
          </div>
          <button @click="open = false" class="w-8 h-8 rounded-lg text-slate-500 hover:bg-slate-200/60 transition">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>

        <!-- —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è –∏–∑ messages -->
        <div x-ref="messages" class="flex-grow p-4 overflow-y-auto space-y-4">
          <template x-for="message in messages" :key="message._id">
            <div class="flex items-start gap-2.5" :class="message.role === 'user' ? 'justify-end' : ''">
              <div x-show="message.role === 'bot'" class="flex-shrink-0 w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-600"><i class="bi bi-robot"></i></div>
              <div class="leading-relaxed p-3 rounded-xl text-sm max-w-[85%]"
                   :class="message.role === 'user' ? 'rounded-br-none bg-indigo-500 text-white' : 'rounded-bl-none bg-slate-100 text-slate-800'">
                <div x-html="message.content"></div>
              </div>
            </div>
          </template>

          <div x-show="loading" class="flex items-start gap-2.5">
              <div class="flex-shrink-0 w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-600"><i class="bi bi-robot"></i></div>
              <div class="leading-relaxed p-3 rounded-xl rounded-bl-none bg-slate-100 text-slate-800 text-sm">
                <div class="flex items-center gap-1">
                    <span class="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style="animation-delay: 0s;"></span>
                    <span class="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></span>
                    <span class="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></span>
                </div>
              </div>
          </div>
        </div>

        <div class="flex-shrink-0 p-3 border-t bg-white rounded-b-2xl">
          <form @submit.prevent="sendMessage" class="flex items-center gap-2">
            <input x-model="userInput" type="text" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..."
                   class="w-full h-10 px-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition"
                   :disabled="loading">
            <button type="submit" class="w-10 h-10 flex-shrink-0 rounded-lg bg-indigo-500 text-white hover:bg-indigo-600 transition disabled:bg-indigo-300" :disabled="loading || userInput.trim() === ''">
              <i class="bi bi-send"></i>
            </button>
          </form>
        </div>
      </div>

<button id="main-chat-toggle-button" @click="open = !open"
              class="w-16 h-16 rounded-full bg-gradient-to-br from-indigo-500 to-sky-500 text-white shadow-xl
                     flex items-center justify-center transition transform hover:scale-105 active:scale-95">
        <i class="bi text-3xl transition-transform duration-300" :class="open ? 'bi-x-lg rotate-90' : 'bi-chat-dots'"></i>
      </button>
    </div>
</div>

<script>
  function chatWidget() {
    return {
      open: false,
      loading: false,        // true –∫–æ–≥–¥–∞ –∏–¥—ë—Ç —Å–µ—Ç–µ–≤–æ–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø–µ—á–∞—Ç—å
      userInput: '',
      messages: [],
      nextId: 1,
      isTyping: false,       // –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ "–ø–µ—á–∞—Ç–∏"
      typeSpeedMs: 18,       // —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏: –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ –Ω–∞ —Å–∏–º–≤–æ–ª (–ø–æ–¥–±–µ—Ä–∏—Ç–µ –ø–æ–¥ –≤–∫—É—Å)

      // ------- –û–±—â–∏–π –ø–∞—Ä—Å–µ—Ä –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π (–∫–∞–∫ —É –≤–∞—Å –±—ã–ª) -------
      formatMessageContent(raw) {
        if (!raw && raw !== "") return "";
        let escaped = (raw + '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');

        // **bold**
        escaped = escaped.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        // —Å—Ç—Ä–æ–∫–∏ -> p / li
        const lines = escaped.split(/\r?\n/);
        const transformed = lines.map(line => {
          const m = line.match(/^\s*[-*]\s+(.*)/);
          if (m) return `<li>${m[1]}</li>`;
          if (line.trim() === '') return '';
          return `<p>${line}</p>`;
        }).join('');

        if (transformed.includes('<li>')) {
          const liMatches = transformed.match(/<li>.*?<\/li>/gs) || [];
          const liHtml = liMatches.join('');
          const paras = transformed.replace(/<li>.*?<\/li>/gs, '');
          const result = (paras.trim() ? paras : '') + `<ul class="list-disc list-inside space-y-1 mt-2">${liHtml}</ul>`;
          return result;
        }

        return transformed;
      },

      scrollToBottom() {
        this.$nextTick(() => {
          if (!this.$refs.messages) return;
          this.$refs.messages.scrollTop = this.$refs.messages.scrollHeight;
        });
      },

      // ------- –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏) -------
      async loadHistory() {
        try {
          const resp = await fetch('/assistant/history');
          if (!resp.ok) throw new Error('Failed to load history');
          const data = await resp.json();
          const history = data.history || [];

          this.messages = history.map((m, idx) => {
            const role = (m.role === 'assistant' || m.role === 'bot') ? 'bot' : 'user';
            const content = this.formatMessageContent(m.content || '');
            return { _id: `h-${idx}-${this.nextId++}`, role, content };
          });

          if (this.messages.length === 0) {
            const welcome = "<p>–ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî Kilo, –≤–∞—à –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ Kilogr.app. üí™üòä</p>";
            this.messages.push({ _id: `welcome-${this.nextId++}`, role: 'bot', content: welcome });
          }
        } catch (err) {
          console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞:', err);
          this.messages = [{ _id: `err-${this.nextId++}`, role: 'bot', content: '<strong>–û—à–∏–±–∫–∞:</strong> –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é.' }];
        } finally {
          this.scrollToBottom();
        }
      },

      // ------- –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—á–∞—Ç–∏: –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –≤ messages[idx] -------
      async _typeOutMessage(idx, fullText) {
        // –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ —É–∂–µ –ø–µ—á–∞—Ç–∞–µ—Ç—Å—è ‚Äî –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ç–æ—Ä–æ–π —Ä–∞–∑
        if (this.isTyping) return;
        this.isTyping = true;
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ: loading true —É–∂–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–≤–æ–¥,
        // –Ω–æ –º—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –¥–µ–ª–∞–µ–º pointer-events: none –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–µ—Ä–µ–∑ css binding
        // –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (–µ—Å–ª–∏ –Ω–∞ –º–µ—Å—Ç–µ idx —Å–µ–π—á–∞—Å –ø—É—Å—Ç–æ)
        this.messages[idx].content = ''; // –±—É–¥–µ—Ç —É–∂–µ –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ –∫–æ–Ω—Ü–∞
        const total = fullText.length;
        let cur = '';
        for (let i = 0; i < total; i++) {
          cur += fullText[i];
          // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ (–±–µ–∑ markdown –ø–æ–∫–∞)
          const escapedPart = (cur + '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
          // –ó–∞–º–µ–Ω–∏–º –ø–µ—Ä–µ–Ω–æ—Å—ã –Ω–∞ <br> –≤–∏–∑—É–∞–ª—å–Ω–æ, –Ω–æ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ–º markdown –ø–æ–∫–∞
          const previewHtml = escapedPart.replace(/\r?\n/g, '<br>');
          this.messages[idx].content = previewHtml;
          // —Å–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑ –¥–ª—è –æ—â—É—â–µ–Ω–∏—è "–ø–µ—á–∞—Ç–∏"
          this.scrollToBottom();
          // –ø–∞—É–∑–∞
          await new Promise(res => setTimeout(res, this.typeSpeedMs));
        }
        // –ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–ª–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ markdown -> html
        this.messages[idx].content = this.formatMessageContent(fullText || '');
        this.isTyping = false;
        this.loading = false; // —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥
        this.scrollToBottom();
      },

      // ------- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ c –∞–Ω–∏–º–∞—Ü–∏–µ–π -------
      async sendMessage() {
        if (this.loading || this.isTyping) return;
        const text = this.userInput.trim();
        if (!text) return;

        // –ª–æ–∫–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º)
        const userMsg = { _id: `u-${this.nextId++}`, role: 'user', content: this.formatMessageContent(text) };
        this.messages.push(userMsg);
        this.userInput = '';
        this.scrollToBottom();

        // –∑–∞–±–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥ –∏ –ø–æ–∫–∞–∂–µ–º –∑–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        this.loading = true;

        try {
          const response = await fetch('/assistant/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text })
          });

          if (!response.ok) {
            const errText = await response.text().catch(()=>null);
            throw new Error(errText || 'Network response was not ok');
          }

          const data = await response.json();
          const replyRaw = data.reply || '...';

          // –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ ‚Äî –∏–º–µ–Ω–Ω–æ –µ–≥–æ –±—É–¥–µ–º "–ø–µ—á–∞—Ç—å"
          const botIndex = this.messages.length;
          this.messages.push({ _id: `b-${this.nextId++}`, role: 'bot', content: '' });

          // –î–µ–ª–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–µ—á–∞—Ç–∏
          // –ó–∞–º–µ—Ç–∏–º: –≤–æ –≤—Ä–µ–º—è –ø–µ—á–∞—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ class binding
          await this._typeOutMessage(botIndex, replyRaw);

        } catch (error) {
          console.error('Chat error:', error);
          // –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ ‚Äî –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
          this.messages.push({ _id: `err-${this.nextId++}`, role: 'bot', content: '<strong>–û—à–∏–±–∫–∞!</strong> –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç.' });
          this.loading = false;
          this.isTyping = false;
        } finally {
          // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –≤–≤–æ–¥ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
          this.loading = false;
          this.isTyping = false;
          this.scrollToBottom();
        }
      },

      // helper (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ)
      escapeHtml(text) {
        return (text + '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }
    }
  }
</script>


<footer class="bg-slate-900 text-slate-300 mt-12 border-t border-slate-700">
  <div class="max-w-7xl mx-auto px-4 py-12 sm:py-16">

    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-10">

      <div class="col-span-2 lg:col-span-2">
        <a href="/profile" class="flex items-center gap-2 mb-3 hover:opacity-90 transition">
          <img
            src="{{ url_for('static', filename='logo.png') }}"
            alt="Kilogr.app"
            class="h-10 md:h-11 w-auto object-contain"
          />
        </a>
        <p class="text-sm text-slate-400 max-w-xs mt-2">
          –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ –º–∏—Ä–µ —Ñ–∏—Ç–Ω–µ—Å–∞, –ø–∏—Ç–∞–Ω–∏—è –∏ –∑–¥–æ—Ä–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ –∂–∏–∑–Ω–∏.
        </p>
      </div>

      <div>
        <h4 class="text-sm font-bold text-white uppercase tracking-wider">–ü—Ä–æ–¥—É–∫—Ç</h4>
        <ul class="mt-4 space-y-3 text-sm">
          <li>
            <a href="/trainings-calendar" class="hover:text-white transition">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
          </li>
          <li>
            <a href="/trainings" class="hover:text-white transition">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</a>
          </li>
          <li>
            <a href="{{ url_for('purchase_page') }}" class="hover:text-white transition">–¢–∞—Ä–∏—Ñ—ã</a>
          </li>
        </ul>
      </div>

      <div>
        <h4 class="text-sm font-bold text-white uppercase tracking-wider">–†–µ—Å—É—Ä—Å—ã</h4>
        <ul class="mt-4 space-y-3 text-sm">
          <li>
            <a href="{{ url_for('instructions_page') }}" class="hover:text-white transition">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</a>
          </li>
          </ul>
      </div>

      <div>
        <h4 class="text-sm font-bold text-white uppercase tracking-wider">–ö–æ–º–ø–∞–Ω–∏—è</h4>
        <ul class="mt-4 space-y-3 text-sm">
          <li>
            <a href="/privacy" class="hover:text-white transition">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</a>
          </li>
          <li>
            <a href="/terms" class="hover:text-white transition">–£—Å–ª–æ–≤–∏—è —Å–µ—Ä–≤–∏—Å–∞</a>
          </li>
        </ul>
      </div>

    </div>

    <div class="mt-10 pt-8 border-t border-slate-700/50">
      <div class="flex flex-col sm:flex-row justify-between items-center">

        <div class="text-sm text-slate-400 text-center sm:text-left">
          ¬© 2025 <span class="font-semibold text-slate-200">Kilogr.app</span>. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
        </div>

        <div class="flex space-x-6 mt-4 sm:mt-0">
          <a href="https://instagram.com/kilogr.app" target="_blank" rel="noopener noreferrer" aria-label="Instagram"
             class="text-slate-400 hover:text-indigo-400 transition transform hover:scale-110">
            <i class="bi bi-instagram text-xl"></i>
          </a>
          <a href="https://t.me/kilogr.app" target="_blank" rel="noopener noreferrer" aria-label="Telegram"
             class="text-slate-400 hover:text-sky-400 transition transform hover:scale-110">
            <i class="bi bi-telegram text-xl"></i>
          </a>
          <a href="https://youtube.com/kilogr.app" target="_blank" rel="noopener noreferrer" aria-label="YouTube"
             class="text-slate-400 hover:text-red-500 transition transform hover:scale-110">
            <i class="bi bi-youtube text-xl"></i>
          </a>
        </div>

      </div>
    </div>

  </div>
</footer>

</body>
</html>
