{% extends "base.html" %}
{% set title = (group.name ~ " ‚Äî –≥—Ä—É–ø–ø–∞") %}

{% block content %}
<style>
  /* ---------- –ë–∞–∑–æ–≤—ã–µ –º–µ–ª–æ—á–∏ ---------- */
  .fade-in{animation:fadeIn .2s ease-out}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .card-hover{transition:transform .15s ease, box-shadow .15s ease}
  .card-hover:hover{transform:translateY(-2px);box-shadow:0 10px 22px -14px rgba(0,0,0,.35)}
  .chip{display:inline-flex;align-items:center;padding:.25rem .5rem;border-radius:9999px;font-size:.75rem;font-weight:600}

  /* ---------- –ß–∞—Ç: –ø–µ—Ä–µ–Ω–æ—Å—ã, —Ä–∞–∑–º–µ—Ä—ã, —Ä–µ–∞–∫—Ü–∏–∏ ---------- */
  #chat-widget-container{transition:opacity .25s ease, transform .25s ease}

  /* –í–ê–ñ–ù–û: –Ω–∏ –≤ –∫–æ–µ–º —Å–ª—É—á–∞–µ –Ω–µ –ª–æ–º–∞–µ–º —Å–ª–æ–≤–∞ –Ω–∞ —Å–∏–º–≤–æ–ª—ã */
  #chat-messages-container{
    overflow-wrap: normal !important;
    word-break: normal !important;
  }

  /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–∂–∏–º–∞—Ç—å—Å—è */
  .msg-wrap{
    max-width:90%;
    flex:0 0 auto !important;    /* –∑–∞–ø—Ä–µ—Ç–∏—Ç—å shrink */
    min-width:6ch !important;     /* –±–∞–∑–æ–≤—ã–π –º–∏–Ω–∏–º—É–º —à–∏—Ä–∏–Ω—ã –±–ª–æ–∫–∞-—Å—Ç—Ä–æ–∫–∏ */
  }

  .chat-bubble{
    display:inline-flex !important;
    align-items:center;
    padding:8px 12px;
    max-width:85%;
    min-width:6ch !important;     /* ¬´—Ç–∞–±–ª–µ—Ç–∫–∞¬ª –Ω–µ —É–∂–µ 6 —Å–∏–º–≤–æ–ª–æ–≤ */
    min-height:2rem !important;   /* –∫–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
    white-space:pre-wrap;          /* —É–≤–∞–∂–∞–µ–º \n –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
    overflow-wrap: normal !important;
    word-break: keep-all !important; /* –Ω–µ —Ä–∞–∑–±–∏–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ —Å–ª–æ–≤–∞ */
    hyphens: manual;               /* –±–µ–∑ –∞–≤—Ç–æ-–¥–µ—Ñ–∏—Å–∞—Ü–∏–∏ */
    border-radius:20px; line-height:1.35;
    flex:0 0 auto !important;      /* –ø—É–∑—ã—Ä—å —Å–∞–º —Å–µ–±—è –Ω–µ —Å–∂–∏–º–∞–µ—Ç */
  }

  .chat-bubble-me{
    background-image:linear-gradient(90deg,#3b82f6,#6366f1);
    color:#fff;
  }
  .chat-bubble-other{background:#eef2ff;color:#111827}

  .chat-img{
    max-width:85%;
    max-height:60vh;
    width:auto;height:auto;
    display:block;border-radius:12px;object-fit:contain
  }
  .reaction-display{user-select:none}

  /* ---------- –õ–∞–π—Ç–±–æ–∫—Å ---------- */
  #image-lightbox{position:fixed;inset:0;display:none;justify-content:center;align-items:center;z-index:1000;cursor:zoom-out;background:rgba(0,0,0,.85)}
  #image-lightbox.visible{display:flex}
  #image-lightbox img{max-width:90%;max-height:90%;object-fit:contain;border-radius:10px;box-shadow:0 0 28px rgba(0,0,0,.5)}
  #lightbox-close{position:absolute;top:18px;right:26px;color:#fff;font-size:36px;font-weight:800}

  /* ---------- –•–µ–¥–µ—Ä ---------- */
  .header-grad{
    background:linear-gradient(120deg,#6366f1 0%,#8b5cf6 40%,#ec4899 100%);
  }

  /* ---------- –ü—Ä–∏—è—Ç–Ω–∞—è —Ä–∞–º–∫–∞/—à—ç–ª–ª —á–∞—Ç–∞ ---------- */
  .chat-shell{
    background:linear-gradient(180deg,#ffffff 0%, #fafafa 100%);
    border:1px solid rgba(15,23,42,.08);
    border-radius:14px;
    box-shadow: 0 20px 40px -24px rgba(2,6,23,.35), 0 1px 0 rgba(255,255,255,.9) inset;
    backdrop-filter:saturate(1.05);
  }
  .chat-header{
    background:linear-gradient(180deg,#f8fafc 0%, #eef2ff 100%);
    border-bottom:1px solid rgba(99,102,241,.15);
    border-top-left-radius:14px;border-top-right-radius:14px;
  }
  .chat-footer{
    background:#f8fafc;
    border-top:1px solid #e5e7eb;
    border-bottom-left-radius:14px;border-bottom-right-radius:14px;
  }

  /* ---------- –°–∫—Ä–æ–ª–ª –¥–ª—è —á–∞—Ç–∞ ---------- */
  #chat-messages-container::-webkit-scrollbar{width:8px}
  #chat-messages-container::-webkit-scrollbar-thumb{background:#e2e8f0;border-radius:9999px}
  #chat-messages-container:hover::-webkit-scrollbar-thumb{background:#cbd5e1}
</style>
<style>
  /* === Chat overflow fix === */
  /* –†–∞–∑—Ä–µ—à–∞–µ–º –ª–æ–º–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∏–Ω–∞—á–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–æ */
  #chat-messages-container{
    overflow-wrap: break-word !important;
    word-break: normal !important;
  }

  /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç—Ä–æ–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: –ø–æ–∑–≤–æ–ª—è–µ–º —Å–∂–∏–º–∞—Ç—å—Å—è –≤–Ω—É—Ç—Ä–∏ flex,
     –∏–Ω–∞—á–µ –¥–ª–∏–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã —Ä–∞—Å—à–∏—Ä—è—é—Ç –≤—Å—é —Å—Ç—Ä–æ–∫—É */
  .msg-wrap{
    max-width: 100% !important;
    min-width: 0 !important;          /* –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è flex-–ø–µ—Ä–µ–Ω–æ—Å–æ–≤ */
    flex: 0 1 auto !important;        /* –º–æ–∂–Ω–æ —Å–ª–µ–≥–∫–∞ —Å–∂–∏–º–∞—Ç—å—Å—è */
  }

  /* –°–∞–º –ø—É–∑—ã—Ä—å: –º–∏–Ω–∏–º—É–º –¥–ª—è ¬´–æ–∫/–π–æ—É/—ç–º–æ–¥–∑–∏¬ª, –Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏–º –¥–ª–∏–Ω–Ω—ã–µ –∫—É—Å–∫–∏ */
  .chat-bubble{
    display: inline-flex !important;
    align-items: center;
    padding: 8px 12px;
    max-width: 85%;
    min-width: 6ch !important;        /* –Ω–µ —Å–ø–ª—é—â–∏–≤–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏–µ */
    min-height: 2rem !important;
    white-space: pre-wrap;

    overflow-wrap: break-word !important;  /* –ª–æ–º–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
    word-break: normal !important;
    word-break: break-word !important;     /* Safari fallback */
    hyphens: auto;

    border-radius: 20px;
    line-height: 1.35;
    flex: 0 0 auto !important;        /* —à–∏—Ä–∏–Ω–∞ –ø—É–∑—ã—Ä—è –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è min/max */
    box-sizing: border-box;
  }

  /* –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π: –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ –≤—ã—Ö–æ–¥—è—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã */
  .chat-img{ max-width: 85%; height: auto; }

</style>

<div class="max-w-7xl mx-auto px-3 sm:px-4 py-6 space-y-6">

  {# -------- Flash-—Å–æ–æ–±—â–µ–Ω–∏—è -------- #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="space-y-2">
        {% for category, message in messages %}
          <div class="px-3 py-2 text-xs rounded-lg
                      {% if category == 'error' %} bg-red-100 text-red-800
                      {% elif category == 'success' %} bg-green-100 text-green-800
                      {% elif category == 'warning' %} bg-yellow-100 text-yellow-800
                      {% else %} bg-blue-100 text-blue-800 {% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# -------- –•–µ–¥–µ—Ä –≥—Ä—É–ø–ø—ã -------- #}
  <section class="relative overflow-hidden rounded-3xl text-white">
    <div class="header-grad">
      <div class="relative z-10 p-5 md:p-7 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex items-start gap-3 md:gap-4">
          <div class="shrink-0">
            <img src="{{ url_for('serve_file', filename=group.trainer.avatar.filename) if group.trainer and group.trainer.avatar else url_for('static','default-avatar.png') }}"
                 class="w-12 h-12 md:w-14 md:h-14 rounded-full object-cover ring-2 ring-white/50" alt="–¢—Ä–µ–Ω–µ—Ä">
          </div>
          <div>
            <h1 class="text-2xl md:text-3xl font-bold tracking-tight">{{ group.name }}</h1>
            <p class="text-white/90 text-sm mt-1 line-clamp-2">
              {{ group.description or "–ì—Ä—É–ø–ø–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π, –∑–∞–¥–∞—á –∏ –æ–±—â–µ–Ω–∏—è." }}
            </p>
            <div class="mt-2 flex flex-wrap items-center gap-2">
              <span class="chip bg-white/15 backdrop-blur text-white border border-white/20">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {{ group.members|length }}</span>
              <span class="chip bg-white/15 backdrop-blur text-white border border-white/20">
                –û–±—ä—è–≤–ª–µ–Ω–∏–π: {{ (all_posts | selectattr('is_announcement','==',true) | list | length) }}
              </span>
              <span class="chip bg-white/15 backdrop-blur text-white border border-white/20">
                –ó–∞–¥–∞—á: {{ (all_posts | selectattr('is_announcement','==',false) | list | length) }}
              </span>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          {% if current_user.is_trainer and group.trainer_id == current_user.id %}
            <span class="chip bg-white text-indigo-700"><i class="bi bi-shield-check mr-1"></i>–¢—Ä–µ–Ω–µ—Ä</span>
          {% endif %}

          {% if not is_member and not (current_user.is_trainer and group.trainer_id == current_user.id) %}
            <form action="{{ url_for('join_group', group_id=group.id) }}" method="POST">
              <button type="submit"
                      class="px-4 py-2 rounded-xl bg-white text-indigo-700 hover:bg-white/90 font-semibold shadow-sm">
                –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
              </button>
            </form>
          {% elif is_member and not (current_user.is_trainer and group.trainer_id == current_user.id) %}
            <form action="{{ url_for('leave_group', group_id=group.id) }}" method="POST">
              <button type="submit"
                      class="px-4 py-2 rounded-xl bg-white/15 text-white border border-white/30 hover:bg-white/25 font-semibold">
                –ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É
              </button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  {# -------- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç: –ª–µ–Ω—Ç–∞ + —Å–∞–π–¥–±–∞—Ä -------- #}
  <div class="grid lg:grid-cols-[1fr,360px] gap-6 items-start">

    {# ---------- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê (–ª–µ–Ω—Ç–∞) ---------- #}
    <section class="space-y-4">

      {# Composer: —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–Ω–µ—Ä –≥—Ä—É–ø–ø—ã #}
      {% if current_user.is_trainer and group.trainer_id == current_user.id %}
      <div class="card card-hover p-4 fade-in">
        <h3 class="font-semibold text-gray-800 mb-3">–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</h3>
        <form action="{{ url_for('create_group_task', group_id=group.id) }}" method="POST" class="space-y-3 text-sm">
          <div class="grid md:grid-cols-2 gap-3">
            <input type="text" name="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" required
                   class="w-full px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <div class="flex items-center gap-3">
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" name="is_announcement" id="is-announcement"
                       class="h-4 w-4 text-yellow-500 rounded border-gray-300 focus:ring-yellow-400">
                <span class="text-gray-700">–û–±—ä—è–≤–ª–µ–Ω–∏–µ</span>
              </label>
              <input type="date" name="due_date"
                     class="px-3 py-2 rounded-xl border border-gray-300 focus:ring-2 focus:ring-indigo-500"
                     title="–°—Ä–æ–∫ (–¥–ª—è –∑–∞–¥–∞—á)">
            </div>
          </div>
          <textarea name="description" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (Markdown/—Ç–µ–∫—Å—Ç)"
                    class="w-full px-3 py-2 rounded-xl border border-gray-300 focus:ring-2 focus:ring-indigo-500"></textarea>
          <div class="text-right">
            <button type="submit" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700 shadow">
              –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
            </button>
          </div>
        </form>
      </div>
      {% endif %}

      {# –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ª–µ–Ω—Ç—ã #}
      <div class="card p-2 md:p-3">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <div class="inline-flex bg-gray-100 rounded-xl p-1 w-full sm:w-auto">
            <button type="button" data-filter="all"
                    class="tab-btn px-3 py-1.5 rounded-lg text-gray-700 font-medium bg-white shadow-sm">
              –í—Å–µ
            </button>
            <button type="button" data-filter="tasks"
                    class="tab-btn px-3 py-1.5 rounded-lg text-gray-600">
              –ó–∞–¥–∞—á–∏
            </button>
            <button type="button" data-filter="announcements"
                    class="tab-btn px-3 py-1.5 rounded-lg text-gray-600">
              –û–±—ä—è–≤–ª–µ–Ω–∏—è
            </button>
          </div>

          <div class="relative w-full sm:w-64">
            <i class="bi bi-search absolute left-3 top-2.5 text-gray-400"></i>
            <input id="feed-search" type="text" placeholder="–ü–æ–∏—Å–∫ –≤ –ª–µ–Ω—Ç–µ‚Ä¶"
                   class="w-full pl-9 pr-3 py-2 rounded-xl border border-gray-300 focus:ring-2 focus:ring-indigo-500">
          </div>
        </div>
      </div>

      {# –õ–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤ #}
      {% set hasAny = (all_posts|length) %}
      <div id="feed" class="space-y-3">
        {% if hasAny %}
          {% for item in all_posts %}
            {% set is_ann = item.is_announcement %}
            <article class="card card-hover p-4 feed-item"
                     data-type="{{ 'announcements' if is_ann else 'tasks' }}"
                     data-title="{{ (item.title or '')|lower }}"
                     data-desc="{{ (item.description or '')|striptags|lower }}">
              <div class="flex items-start justify-between gap-3">
                <div class="flex items-start gap-3">
                  <div class="mt-0.5">
                    {% if is_ann %}
                      <span class="chip bg-yellow-100 text-yellow-800"><i class="bi bi-megaphone-fill mr-1"></i>–û–±—ä—è–≤–ª–µ–Ω–∏–µ</span>
                    {% else %}
                      <span class="chip bg-purple-100 text-purple-800"><i class="bi bi-list-check mr-1"></i>–ó–∞–¥–∞—á–∞</span>
                    {% endif %}
                  </div>
                  <div>
                    <h4 class="text-base sm:text-lg font-semibold text-gray-900">{{ item.title }}</h4>
                    {% if item.description %}
                      <div class="prose prose-sm max-w-none text-gray-700 mt-1">{{ item.description | safe }}</div>
                    {% endif %}
                    <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-gray-500">
                      {% if not is_ann %}
                        <span class="chip bg-gray-100 text-gray-700">
                          <i class="bi bi-hourglass-split mr-1"></i>
                          –°—Ä–æ–∫: {{ item.due_date.strftime('%d.%m.%Y') if item.due_date else '–Ω–µ —É–∫–∞–∑–∞–Ω' }}
                        </span>
                      {% endif %}
                      <span class="chip bg-gray-100 text-gray-700">
                        <i class="bi bi-calendar-event mr-1"></i>
                        –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {{ item.created_at.strftime('%d.%m.%Y %H:%M') if item.created_at else '‚Äî' }}
                      </span>
                    </div>
                  </div>
                </div>

                {% if current_user.is_trainer and group.trainer_id == current_user.id %}
                <form action="{{ url_for('delete_group_task', task_id=item.id) }}" method="POST" class="shrink-0">
                  <button type="submit" class="p-2 rounded-lg text-rose-500 hover:bg-rose-50" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </form>
                {% endif %}
              </div>
            </article>
          {% endfor %}
        {% else %}
          <div class="card p-10 text-center">
            <i class="bi bi-card-text text-5xl text-gray-300 mb-3"></i>
            <div class="text-xl font-semibold text-gray-700">–õ–µ–Ω—Ç–∞ –≥—Ä—É–ø–ø—ã –ø—É—Å—Ç–∞</div>
            <p class="text-gray-500 mt-2">
              {% if current_user.is_trainer and group.trainer_id == current_user.id %}
                –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –≤—ã—à–µ.
              {% else %}
                –¢—Ä–µ–Ω–µ—Ä –ø–æ–∫–∞ –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª –∑–∞–ø–∏—Å–∏. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ—è–≤—è—Ç—Å—è ‚Äî –≤—ã —É–≤–∏–¥–∏—Ç–µ –∏—Ö –∑–¥–µ—Å—å.
              {% endif %}
            </p>
          </div>
        {% endif %}
      </div>
    </section>

    {# ---------- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê (—Å–∞–π–¥–±–∞—Ä) ---------- #}
    <aside class="space-y-4">
      <div class="card p-4">
        <h3 class="font-semibold text-gray-800 mb-3">–û –≥—Ä—É–ø–ø–µ</h3>
        <div class="space-y-4">
          <div><p class="text-sm italic text-gray-600">‚Äú{{ group.description or '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è' }}‚Äù</p></div>
          <div class="border-t pt-3">
            <p class="text-xs text-gray-500 mb-1">–¢—Ä–µ–Ω–µ—Ä</p>
            <div class="flex items-center gap-2">
              <img src="{{ url_for('serve_file', filename=group.trainer.avatar) if group.trainer and group.trainer.avatar else url_for('static', filename='default-avatar.png') }}"
                   class="w-8 h-8 rounded-full object-cover" alt="–¢—Ä–µ–Ω–µ—Ä">
              <span class="text-sm font-semibold text-gray-800">{{ group.trainer.name if group.trainer else '‚Äî' }}</span>
            </div>
          </div>

          <div>
            <details class="group">
              <summary class="cursor-pointer text-sm font-semibold text-gray-800 flex items-center justify-between">
                –£—á–∞—Å—Ç–Ω–∏–∫–∏ ({{ group.members|length }})
                <i class="bi bi-chevron-down text-gray-400 group-open:rotate-180 transition"></i>
              </summary>
              <ul class="mt-2 max-h-40 overflow-auto space-y-1.5 pl-1">
                {% for m in group.members %}
                  <li class="flex items-center gap-2 text-sm">
                    <img src="{{ url_for('serve_file', filename=m.user.avatar.filename) if m.user.avatar else url_for('static','default-avatar.png') }}"
                         class="w-6 h-6 rounded-full object-cover" alt="">
                    <span class="text-gray-700">{{ m.user.name }}</span>
                    {% if m.user_id == current_user.id %}
                      <span class="text-indigo-600 text-xs font-semibold">(–í—ã)</span>
                    {% endif %}
                  </li>
                {% else %}
                  <li class="text-xs text-gray-500 italic">–ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</li>
                {% endfor %}
              </ul>
            </details>
          </div>

          {% if not is_member and not (current_user.is_trainer and group.trainer_id == current_user.id) %}
            <form action="{{ url_for('join_group', group_id=group.id) }}" method="POST">
              <button type="submit" class="w-full px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">
                –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –≥—Ä—É–ø–ø–µ
              </button>
            </form>
          {% elif is_member and not (current_user.is_trainer and group.trainer_id == current_user.id) %}
            <form action="{{ url_for('leave_group', group_id=group.id) }}" method="POST">
              <button type="submit" class="w-full px-4 py-2 rounded-xl bg-rose-600 text-white font-semibold hover:bg-rose-700">
                –ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É
              </button>
            </form>
          {% endif %}
        </div>
      </div>

      {% if group_member_stats %}
      <div class="card p-4">
        <h3 class="font-semibold text-gray-800 mb-3">–ü—Ä–æ–≥—Ä–µ—Å—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>
        <div class="space-y-3">
          {% for s in group_member_stats %}
            {% if not s.is_trainer_in_group %}
              <div class="p-3 border rounded-xl">
                <div class="flex items-center gap-3 mb-2">
                  <img src="{{ url_for('serve_file', filename=s.user.avatar.filename) if s.user.avatar else url_for('static','default-avatar.png') }}"
                       class="w-8 h-8 rounded-full object-cover" alt="">
                  <span class="text-sm font-semibold text-gray-800">{{ s.user.name }}</span>
                </div>

                {% if s.fat_loss_progress %}
                  {% set p = s.fat_loss_progress %}
                  <div class="text-sm">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                      <span>–ñ–∏—Ä (–∫–≥)</span>
                      <span>{{ "%.1f"|format(p.current_kg) }} / <b class="text-emerald-600">{{ "%.1f"|format(p.goal_kg) }}</b></span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden">
                      <div class="progress-bar-fill bg-indigo-600 h-5 flex items-center justify-center text-[11px] text-white font-bold"
                           style="width: {{ p.percentage|int }}%">
                        {{ p.percentage|int }}%
                      </div>
                    </div>
                    <div class="text-right text-[11px] text-gray-500 mt-1">
                      –°—Ç–∞—Ä—Ç: {{ "%.1f"|format(p.initial_kg) }} –∫–≥
                    </div>
                  </div>
                {% else %}
                  <div class="text-xs text-gray-500 bg-gray-50 p-2 rounded-lg text-center">
                    –¶–µ–ª—å –ø–æ —Å–Ω–∏–∂–µ–Ω–∏—é –∂–∏—Ä–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.
                  </div>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </aside>
  </div>
</div>

{# -------- Lightbox -------- #}
<div id="image-lightbox" onclick="closeLightbox()">
  <span id="lightbox-close">&times;</span>
  <img id="lightbox-image" src="" alt="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
</div>

{# -------- –ü–ª–∞–≤–∞—é—â–∏–π —á–∞—Ç -------- #}
<button id="chat-toggle-button"
        class="fixed bottom-6 right-6 bg-indigo-600 hover:bg-indigo-700 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center z-40">
  <i class="bi bi-chat-dots-fill text-2xl"></i>
</button>

<div id="chat-widget-container"
     class="hidden fixed bottom-6 right-6 w-[92vw] max-w-sm h-[65vh] rounded-xl flex flex-col z-40 origin-bottom-right opacity-0 scale-95 chat-shell">
  <div class="flex items-center justify-between p-3 chat-header">
    <h3 class="font-semibold text-gray-800">–û–±—Å—É–∂–¥–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ</h3>
    <button id="chat-widget-close-button" class="text-gray-500 hover:text-gray-800 text-2xl leading-none" aria-label="–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç—ã">&times;</button>
  </div>

  <div id="chat-messages-container" class="flex-1 p-3 overflow-y-auto bg-white/60 space-y-1 flex flex-col">
    <p id="chat-placeholder" class="text-gray-500 text-center italic text-xs m-auto">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π‚Ä¶</p>
  </div>

  <div class="p-3 chat-footer">
    {% if (current_user.is_trainer and group.trainer_id == current_user.id) or is_member %}
    <form id="chat-form" action="{{ url_for('post_group_image_message', group_id=group.id) }}" method="POST" enctype="multipart/form-data">
      <div class="flex items-center border border-gray-300 rounded-lg shadow-sm focus-within:ring-1 focus-within:ring-indigo-500 bg-white">
        <textarea name="text" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" class="flex-1 p-2 rounded-l-lg bg-transparent focus:outline-none text-sm resize-none"></textarea>
        <button type="button" onclick="document.getElementById('image-upload-widget').click()" class="p-2 text-gray-500 hover:text-indigo-600" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
          <i class="fas fa-paperclip text-base"></i>
        </button>
        <input id="image-upload-widget" type="file" name="image" class="hidden" accept="image/*">
        <button type="submit" class="p-2 text-gray-600 hover:text-indigo-600" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
          <i class="fas fa-paper-plane text-base"></i>
        </button>
      </div>
      <span id="file-name-widget" class="block text-xs text-gray-500 mt-1 pl-1"></span>
    </form>
    {% else %}
      <div class="text-center text-sm text-gray-500">–¢–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç.</div>
    {% endif %}
  </div>
</div>

<script>
function escapeHtml(s){
  return String(s || '').replace(/[&<>"']/g, m => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
  ));
}

/* –†–µ–∞–∫—Ü–∏–∏ */
function likeMessage(messageId) {
  fetch(`/group_message/${messageId}/react`, { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'} })
    .then(r => r.json())
    .then(d => {
      if (!d.success) return;
      const root = document.querySelector(`#message-${messageId}`);
      if (!root) return;
      let badge = root.querySelector('.reaction-display');
      const column = root.querySelector('.msg-wrap .flex.flex-col');
      if (d.new_like_count > 0) {
        if (!badge && column) {
          column.insertAdjacentHTML('beforeend', `
            <div class="reaction-display mt-1 self-end">
              <div class="bg-white border border-gray-200 rounded-full px-1.5 py-0.5 shadow-sm text-xs text-gray-600 flex items-center select-none">
                <span class="reaction-icon text-red-500">üëç</span>
                <span class="reaction-count ml-0.5">${d.new_like_count}</span>
              </div>
            </div>
          `);
        } else if (badge) {
          const countEl = badge.querySelector('.reaction-count');
          const iconEl = badge.querySelector('.reaction-icon');
          if (countEl) countEl.textContent = d.new_like_count;
          if (iconEl) iconEl.classList.add('text-red-500');
        }
      } else {
        if (badge) badge.remove();
      }
    });
}

/* –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è */
function renderMessage(msg, last) {
  const changeUser = !last || last.user.name !== msg.user.name || last.is_current_user !== msg.is_current_user;
  const showAvatar = changeUser;
  const justify = msg.is_current_user ? 'justify-end' : 'justify-start';
  const rowDir = msg.is_current_user ? 'flex-row-reverse' : '';

  const reactionHtml = (msg.reactions_count > 0) ? `
    <div class="reaction-display mt-1 self-end">
      <div class="bg-white border border-gray-200 rounded-full px-1.5 py-0.5 shadow-sm text-xs text-gray-600 flex items-center select-none">
        <span class="reaction-icon ${msg.current_user_reacted ? 'text-red-500' : ''}">üëç</span>
        <span class="reaction-count ml-0.5">${msg.reactions_count}</span>
      </div>
    </div>` : '';

  const contentHtml = msg.image_url
    ? `<div class="rounded-xl overflow-hidden shadow-md cursor-zoom-in" onclick="openLightbox('${msg.image_url}')">
         <img src="${msg.image_url}" class="chat-img" alt="">
       </div>`
    : `<div class="chat-bubble ${msg.is_current_user ? 'chat-bubble-me' : 'chat-bubble-other'}">${escapeHtml(msg.text)}</div>`;

  return `
    <div id="message-${msg.id}" class="w-full flex ${justify}">
      <div ondblclick="likeMessage(${msg.id})" class="msg-wrap flex items-end gap-1.5 group relative ${rowDir}">
        <div class="w-6 h-6 flex-shrink-0">
          ${showAvatar ? `<img src="${msg.user.avatar_url}" class="w-full h-full rounded-full object-cover" alt="">` : ''}
        </div>
        <div class="flex flex-col ${msg.is_current_user ? 'items-end' : 'items-start'}">
          ${(showAvatar && !msg.is_current_user) ? `<span class="text-[11px] text-gray-500 ml-2 mb-0.5">${escapeHtml(msg.user.name)}</span>` : ''}
          ${contentHtml}
          ${reactionHtml}
        </div>
      </div>
    </div>`;
}

/* –§–∏–ª—å—Ç—Ä—ã –ª–µ–Ω—Ç—ã */
document.addEventListener('DOMContentLoaded', () => {
  const feed = document.getElementById('feed');
  const tabs = document.querySelectorAll('.tab-btn');
  const search = document.getElementById('feed-search');

  function applyFilter() {
    const active = document.querySelector('.tab-btn.bg-white')?.dataset.filter || 'all';
    const q = (search?.value || '').trim().toLowerCase();
    feed?.querySelectorAll('.feed-item').forEach(card => {
      const type = card.dataset.type;
      const hay = (card.dataset.title || '') + ' ' + (card.dataset.desc || '');
      const okType = (active === 'all') || (type === active);
      const okSearch = !q || hay.includes(q);
      card.style.display = (okType && okSearch) ? '' : 'none';
    });
  }

  tabs.forEach(b => {
    b.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('bg-white','shadow-sm','text-gray-700','font-medium'));
      b.classList.add('bg-white','shadow-sm','text-gray-700','font-medium');
      applyFilter();
    });
  });
  search?.addEventListener('input', applyFilter);
  applyFilter();
});

/* –ß–∞—Ç */
document.addEventListener('DOMContentLoaded', function() {
  const groupId = {{ group.id }};
  let polling = null;
  const messagesEl = document.getElementById('chat-messages-container');
  const chatForm = document.getElementById('chat-form');

  function refreshMessages() {
    fetch(`/api/groups/${groupId}/messages`)
      .then(r => r.json())
      .then(list => {
        messagesEl.innerHTML = '';
        if (!Array.isArray(list) || list.length === 0) {
          messagesEl.innerHTML = '<p class="text-gray-500 text-center italic text-xs m-auto">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
          return;
        }
        let last = null;
        list.forEach(m => {
          messagesEl.insertAdjacentHTML('beforeend', renderMessage(m, last));
          last = m;
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
  }

  if (chatForm) {
    chatForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const fd = new FormData(chatForm);
      const textEl = chatForm.querySelector('textarea');
      const fileEl = chatForm.querySelector('input[type="file"]');
      const fileNameSpan = document.getElementById('file-name-widget');

      if (!textEl.value.trim() && !fileEl.value) return;

      fetch(chatForm.action, { method:'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' }})
        .then(r => r.json())
        .then(d => {
          if (!d.success) return alert(d.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
          const ph = document.getElementById('chat-placeholder'); if (ph) ph.remove();
          messagesEl.insertAdjacentHTML('beforeend', renderMessage(d.message, null));
          messagesEl.scrollTop = messagesEl.scrollHeight;
          textEl.value=''; fileEl.value=''; if(fileNameSpan) fileNameSpan.textContent='';
        });
    });
  }

  const upload = document.getElementById('image-upload-widget');
  if (upload) upload.addEventListener('change', function() {
    const s = document.getElementById('file-name-widget');
    if (s) s.textContent = this.files[0] ? `–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${this.files[0].name}` : '';
  });

  const btnOpen = document.getElementById('chat-toggle-button');
  const box = document.getElementById('chat-widget-container');
  const btnClose = document.getElementById('chat-widget-close-button');

  function toggleChat() {
    const hidden = box.classList.contains('hidden');
    if (hidden) {
      box.classList.remove('hidden'); btnOpen.classList.add('hidden');
      setTimeout(() => { box.classList.remove('opacity-0','scale-95'); }, 10);
      refreshMessages(); polling = setInterval(refreshMessages, 5000);
      setTimeout(() => { messagesEl.scrollTop = messagesEl.scrollHeight; }, 150);
    } else {
      box.classList.add('opacity-0','scale-95');
      setTimeout(() => { box.classList.add('hidden'); btnOpen.classList.remove('hidden'); }, 220);
      if (polling) clearInterval(polling);
    }
  }

  btnOpen?.addEventListener('click', toggleChat);
  btnClose?.addEventListener('click', toggleChat);

  /* –õ–∞–π—Ç–±–æ–∫—Å */
  const lightbox = document.getElementById('image-lightbox');
  const lightboxImg = document.getElementById('lightbox-image');
  window.openLightbox = (src) => { if(!lightbox || !lightboxImg) return; lightboxImg.src = src; lightbox.classList.add('visible'); }
  window.closeLightbox = () => { if(!lightbox || !lightboxImg) return; lightbox.classList.remove('visible'); lightboxImg.src=''; }
  lightbox?.addEventListener('click', (e) => { if (e.target === lightbox) window.closeLightbox(); });

  /* Esc –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ª–∞–π—Ç–±–æ–∫—Å –∏–ª–∏ —á–∞—Ç */
  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    if (lightbox?.classList.contains('visible')) return window.closeLightbox();
    if (!box?.classList.contains('hidden')) toggleChat();
  });
});
</script>
{% endblock %}
