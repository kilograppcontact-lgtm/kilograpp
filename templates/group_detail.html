{% extends "base.html" %}
{% set title = group.name ~ " — Отряд" %}

{% block content %}
<style>
  /* Анимации */
  .fade-in { animation: fadeIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Карточки */
  .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); overflow: hidden; }

  /* Лидерборд */
  .leaderboard-row { transition: all 0.3s ease; }
  .leaderboard-row:hover { background-color: #f8fafc; }
  .rank-badge { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 12px; font-weight: 800; }
  .rank-1 { background: #FEF3C7; color: #D97706; } /* Gold */
  .rank-2 { background: #F3F4F6; color: #4B5563; } /* Silver */
  .rank-3 { background: #FFEDD5; color: #C2410C; } /* Bronze */
  .rank-N { background: #F1F5F9; color: #64748B; }

  /* Лента */
  .feed-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
  .comment-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }

  .post-img {
    max-height: 500px; width: 100%; object-fit: cover; border-radius: 12px; margin-top: 12px; cursor: zoom-in;
  }

  /* Комментарии */
  .comment-section { background: #f9fafb; border-top: 1px solid #f3f4f6; }
  .comment-bubble { background: #fff; border: 1px solid #e5e7eb; border-radius: 0 16px 16px 16px; padding: 8px 12px; display: inline-block; }

  /* Хедер */
  .header-bg {
    background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
    color: white;
  }
</style>

<div class="max-w-4xl mx-auto px-4 py-6 space-y-6">

  {# --- 1. ШАПКА ГРУППЫ --- #}
  <div class="card header-bg p-6 relative overflow-hidden">
    <div class="relative z-10 flex flex-col md:flex-row items-center gap-6">
      <div class="shrink-0 relative">
        <img src="{{ url_for('serve_file', filename=group.trainer.avatar.filename) if group.trainer and group.trainer.avatar else url_for('static', filename='default-avatar.png') }}"
             class="w-20 h-20 rounded-full border-4 border-white/20 object-cover">
        <div class="absolute -bottom-2 -right-2 bg-white text-indigo-600 text-xs font-bold px-2 py-1 rounded-full shadow">
          COACH
        </div>
      </div>

      <div class="text-center md:text-left flex-1">
        <h1 class="text-3xl font-black tracking-tight">{{ group.name }}</h1>
        <p class="text-white/80 mt-1 text-sm max-w-xl mx-auto md:mx-0">
          {{ group.description or "Добро пожаловать в командный центр! Здесь мы делимся успехами и поддерживаем друг друга." }}
        </p>
        <div class="mt-4 flex flex-wrap justify-center md:justify-start gap-3">
          <div class="inline-flex items-center px-3 py-1 rounded-full bg-white/20 backdrop-blur-sm text-sm font-medium border border-white/10">
            <i class="bi bi-people-fill mr-2"></i> {{ group.members|length }} участников
          </div>
          {% if current_user.is_trainer and group.trainer_id == current_user.id %}
            <a href="{{ url_for('admin_groups_list') }}" class="inline-flex items-center px-3 py-1 rounded-full bg-white text-indigo-700 text-sm font-bold shadow hover:bg-gray-100 transition">
              <i class="bi bi-gear-fill mr-2"></i> Настройки
            </a>
          {% endif %}
        </div>
      </div>
    </div>

    <i class="bi bi-shield-check absolute -right-6 -bottom-10 text-[10rem] text-white/5 rotate-12 pointer-events-none"></i>
  </div>

  {# --- 1.5. РАСПИСАНИЕ ТРЕНИРОВОК --- #}
  <div class="card p-5">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
        <i class="bi bi-calendar-check-fill text-indigo-500"></i> Расписание тренировок
      </h2>
      {% if current_user.is_trainer and group.trainer_id == current_user.id %}
        <button onclick="document.getElementById('training-modal').classList.remove('hidden')"
                class="text-sm bg-indigo-50 text-indigo-700 px-3 py-1 rounded-lg font-bold hover:bg-indigo-100 transition">
          + Назначить
        </button>
      {% endif %}
    </div>

    {% if upcoming_trainings %}
      <div class="grid gap-3 sm:grid-cols-2">
        {% for t in upcoming_trainings %}
          <div class="border border-gray-100 rounded-xl p-3 bg-gray-50 flex flex-col relative overflow-hidden">
            <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-500/5 rounded-bl-full -mr-8 -mt-8"></div>

            <div class="flex justify-between items-start z-10">
              <div>
                <div class="text-xs font-bold text-indigo-600 uppercase tracking-wide mb-1">
                  {{ t.date.strftime('%d.%m') }} • {{ t.start_time.strftime('%H:%M') }}
                </div>
                <h3 class="font-bold text-gray-900 leading-tight">{{ t.title }}</h3>
              </div>
              {% if t.meeting_link and t.meeting_link != '#' %}
                <a href="{{ t.meeting_link }}" target="_blank" class="w-8 h-8 flex items-center justify-center bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 transition">
                  <i class="bi bi-camera-video-fill text-xs"></i>
                </a>
              {% endif %}
            </div>

            <div class="mt-2 text-xs text-gray-500 line-clamp-2">
              {{ t.description or "Описание отсутствует" }}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-6 text-gray-400 text-sm">
        Нет запланированных тренировок
      </div>
    {% endif %}
  </div>

  {# --- 2. ЛИДЕРБОРД --- #}
  <div class="card p-5">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
        <i class="bi bi-trophy-fill text-amber-500"></i> Топ участников
      </h2>
      <button onclick="toggleLeaderboard()" id="lb-toggle-btn" class="text-sm text-indigo-600 font-semibold hover:text-indigo-800 transition">
        Показать всех
      </button>
    </div>

    <div class="space-y-2" id="leaderboard-container">
      {% for s in group_member_stats %}
        {% set is_me = (s.user.id == current_user.id) %}
        {% set score = (s.fat_loss_progress.current_kg | int * 10) if s.fat_loss_progress else 0 %} {# Пример скоринга #}

        <div class="leaderboard-row flex items-center justify-between p-2 rounded-xl {{ 'hidden' if loop.index > 3 else '' }} {{ 'bg-indigo-50 border border-indigo-100' if is_me else '' }}"
             data-rank="{{ loop.index }}">
          <div class="flex items-center gap-3">
            <div class="rank-badge rank-{{ loop.index if loop.index <= 3 else 'N' }}">
              {{ loop.index }}
            </div>
            <img src="{{ url_for('serve_file', filename=s.user.avatar.filename) if s.user.avatar else url_for('static', filename='default-avatar.png') }}"
                 class="w-8 h-8 rounded-full object-cover border border-gray-200">
            <div>
              <div class="text-sm font-bold text-gray-800">
                {{ s.user.name }} {{ '(Вы)' if is_me else '' }}
              </div>
            </div>
          </div>

          <div class="text-sm font-bold text-gray-600 bg-gray-100 px-2 py-1 rounded-lg">
            {{ score }} pts
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  {# --- 3. ЛЕНТА (FEED) --- #}
  <div class="space-y-6">

    {% if current_user.is_trainer and group.trainer_id == current_user.id %}
    <div class="card p-4">
      <div class="flex gap-3">
        <img src="{{ url_for('serve_file', filename=current_user.avatar.filename) if current_user.avatar else url_for('static', filename='default-avatar.png') }}"
             class="w-10 h-10 rounded-full object-cover">
        <div class="flex-1">
          <form id="create-post-form" onsubmit="submitPost(event)">
            <textarea name="text" rows="2" placeholder="Что нового в команде, тренер?"
                      class="w-full bg-gray-50 border-0 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 resize-none"></textarea>

            <div id="image-preview-container" class="hidden mt-2 relative w-fit">
              <img id="image-preview" src="" class="h-20 rounded-lg border">
              <button type="button" onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow">&times;</button>
            </div>

            <div class="flex items-center justify-between mt-3">
              <button type="button" onclick="document.getElementById('post-image-input').click()"
                      class="text-gray-500 hover:text-indigo-600 transition text-sm flex items-center gap-1">
                <i class="bi bi-image"></i> Фото
              </button>
              <input type="file" name="image" id="post-image-input" class="hidden" accept="image/*" onchange="previewImage(this)">

              <button type="submit" class="bg-indigo-600 text-white px-4 py-1.5 rounded-lg text-sm font-bold hover:bg-indigo-700 transition">
                Опубликовать
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}

    <div id="feed-container" class="space-y-4">
      <div class="text-center py-10">
        <div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent text-indigo-600 rounded-full" role="status"></div>
        <p class="mt-2 text-gray-500 text-sm">Загрузка ленты...</p>
      </div>
    </div>

  </div>
</div>

{# --- Lightbox --- #}
<div id="image-lightbox" onclick="closeLightbox()" class="fixed inset-0 z-50 hidden bg-black/90 flex items-center justify-center cursor-zoom-out p-4">
  <img id="lightbox-image" src="" class="max-w-full max-h-full rounded-lg shadow-2xl">
</div>

{# --- Модальное окно создания тренировки --- #}
<div id="training-modal" class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
  <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl transform transition-all scale-100">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-black text-gray-900">Новая тренировка</h3>
      <button onclick="document.getElementById('training-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
        <i class="bi bi-x-lg text-lg"></i>
      </button>
    </div>

    <form onsubmit="submitTraining(event)" class="space-y-4">
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Название</label>
        <input type="text" name="title" required value="Групповая тренировка" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Дата</label>
          <input type="date" name="date" required class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none">
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Время (Начало)</label>
          <input type="time" name="start_time" required class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none">
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Время (Конец)</label>
          <input type="time" name="end_time" required class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none">
        </div>
        <div>
           <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ссылка (Zoom/Meet)</label>
           <input type="url" name="meeting_link" placeholder="https://..." class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none">
        </div>
      </div>

      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Описание</label>
        <textarea name="description" rows="2" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none resize-none"></textarea>
      </div>

      <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">
        Создать событие
      </button>
    </form>
  </div>
</div>

<script>
  const GROUP_ID = {{ group.id }};
  const CURRENT_USER_ID = {{ current_user.id }};

  // --- ЛОГИКА ТРЕНИРОВОК ---
  async function submitTraining(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    try {
      const res = await fetch(`/groups/${GROUP_ID}/trainings/new`, {
        method: 'POST',
        body: formData
      });
      const data = await res.json();

      if (data.ok) {
        window.location.reload(); // Простая перезагрузка для отображения в списке
      } else {
        alert(data.error);
      }
    } catch (err) {
      alert('Ошибка создания');
    }
  }

  // --- ЛОГИКА ЛИДЕРБОРДА ---
  let lbExpanded = false;
  function toggleLeaderboard() {
    lbExpanded = !lbExpanded;
    const rows = document.querySelectorAll('.leaderboard-row');
    const btn = document.getElementById('lb-toggle-btn');

    rows.forEach((row, index) => {
      if (index >= 3) {
        row.classList.toggle('hidden', !lbExpanded);
      }
    });
    btn.innerText = lbExpanded ? "Свернуть" : "Показать всех";
  }

  // --- ЛОГИКА СОЗДАНИЯ ПОСТА ---
  function previewImage(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('image-preview').src = e.target.result;
        document.getElementById('image-preview-container').classList.remove('hidden');
      }
      reader.readAsDataURL(input.files[0]);
    }
  }

  function clearImage() {
    document.getElementById('post-image-input').value = '';
    document.getElementById('image-preview-container').classList.add('hidden');
  }

  async function submitPost(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    if (!formData.get('text').trim() && !formData.get('image').size) return;

    try {
      const res = await fetch(`/api/groups/${GROUP_ID}/post`, {
        method: 'POST',
        body: formData
      });
      const data = await res.json();

      if (data.ok) {
        form.reset();
        clearImage();
        loadFeed(); // Перезагрузить ленту
      } else {
        alert(data.error);
      }
    } catch (err) {
      console.error(err);
      alert('Ошибка отправки');
    }
  }

  // --- ЛОГИКА ЛЕНТЫ (FEED) ---

  // Загрузка
  async function loadFeed() {
    const container = document.getElementById('feed-container');
    try {
      const res = await fetch(`/api/groups/${GROUP_ID}/feed`);
      const data = await res.json();

      if (data.ok) {
        renderFeed(data.feed);
      }
    } catch (err) {
      container.innerHTML = `<div class="text-center text-red-500 py-10">Ошибка загрузки ленты</div>`;
    }
  }

  // Рендеринг списка
  function renderFeed(posts) {
    const container = document.getElementById('feed-container');

    if (posts.length === 0) {
      container.innerHTML = `
        <div class="text-center py-10 text-gray-400">
          <i class="bi bi-chat-square-quote text-4xl mb-2 block"></i>
          Пока новостей нет
        </div>`;
      return;
    }

    container.innerHTML = posts.map(post => {
      const isSystem = post.type === 'system';
      const userAvatar = post.avatar ? `/files/${post.avatar}` : '/static/default-avatar.png';
      const postImage = post.image ? `/files/${post.image}` : null;

      // Блок комментариев
      const commentsHtml = post.comments.map(c => `
        <div class="flex gap-2 mb-3">
          <img src="${c.avatar ? `/files/${c.avatar}` : '/static/default-avatar.png'}" class="comment-avatar shrink-0">
          <div class="text-sm">
            <div class="bg-gray-100 px-3 py-2 rounded-2xl rounded-tl-none inline-block">
              <span class="font-bold text-gray-900 text-xs">${c.user_name}</span>
              <p class="text-gray-800 mt-0.5">${c.text}</p>
            </div>
            <div class="text-[10px] text-gray-400 mt-1 ml-1">${c.timestamp}</div>
          </div>
        </div>
      `).join('');

      return `
        <article class="card fade-in" id="post-${post.id}">
          <div class="p-4">
            <div class="flex items-center gap-3 mb-3">
              ${isSystem
                ? `<div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600"><i class="bi bi-trophy-fill"></i></div>`
                : `<img src="${userAvatar}" class="feed-avatar">`
              }
              <div>
                <div class="font-bold text-gray-900 text-sm flex items-center gap-2">
                  ${post.user_name}
                  ${!isSystem ? '<i class="bi bi-patch-check-fill text-indigo-500 text-xs"></i>' : ''}
                </div>
                <div class="text-xs text-gray-500">${post.timestamp}</div>
              </div>
            </div>

            <div class="text-gray-800 text-sm leading-relaxed whitespace-pre-wrap">${post.text}</div>

            ${postImage ? `<img src="${postImage}" class="post-img" onclick="openLightbox(this.src)">` : ''}

            <div class="mt-4 flex items-center gap-4 border-t pt-3">
              <button onclick="toggleLike(${post.id})" class="flex items-center gap-1.5 text-sm font-semibold transition ${post.is_liked ? 'text-red-500' : 'text-gray-500 hover:text-gray-700'}">
                <i class="bi ${post.is_liked ? 'bi-heart-fill' : 'bi-heart'}"></i>
                <span class="likes-count">${post.likes_count > 0 ? post.likes_count : 'Нравится'}</span>
              </button>

              <button onclick="focusComment(${post.id})" class="flex items-center gap-1.5 text-sm font-semibold text-gray-500 hover:text-gray-700 transition">
                <i class="bi bi-chat"></i>
                <span>${post.comments.length > 0 ? post.comments.length : 'Комментировать'}</span>
              </button>
            </div>
          </div>

          <div class="comment-section p-4 ${post.comments.length === 0 ? '' : 'pt-2'}">
            <div id="comments-list-${post.id}">
              ${commentsHtml}
            </div>

            <form onsubmit="submitComment(event, ${post.id})" class="flex gap-2 mt-2">
              <img src="{{ url_for('serve_file', filename=current_user.avatar.filename) if current_user.avatar else url_for('static', filename='default-avatar.png') }}" class="w-8 h-8 rounded-full object-cover">
              <div class="flex-1 relative">
                <input type="text" name="text" placeholder="Написать комментарий..."
                       class="w-full bg-white border border-gray-300 rounded-full py-1.5 px-4 text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                <button type="submit" class="absolute right-2 top-1.5 text-indigo-600 hover:text-indigo-800">
                  <i class="bi bi-send-fill"></i>
                </button>
              </div>
            </form>
          </div>
        </article>
      `;
    }).join('');
  }

  // Лайк
  async function toggleLike(postId) {
    // Оптимистичное обновление
    const btn = document.querySelector(`#post-${postId} button`);
    const icon = btn.querySelector('i');
    const countSpan = btn.querySelector('.likes-count');

    const isLiked = icon.classList.contains('bi-heart-fill');
    let count = parseInt(countSpan.innerText) || 0;

    // Toggle visual
    if (isLiked) {
      icon.classList.replace('bi-heart-fill', 'bi-heart');
      btn.classList.replace('text-red-500', 'text-gray-500');
      count = Math.max(0, count - 1);
    } else {
      icon.classList.replace('bi-heart', 'bi-heart-fill');
      btn.classList.replace('text-gray-500', 'text-red-500');
      count++;
    }
    countSpan.innerText = count > 0 ? count : 'Нравится';

    // API call
    try {
      await fetch(`/group_message/${postId}/react`, { method: 'POST' });
    } catch(e) {
      console.error(e);
      // Revert if error (omitted for brevity)
    }
  }

  // Комментарий
  function focusComment(postId) {
    const input = document.querySelector(`#post-${postId} input[name="text"]`);
    if (input) input.focus();
  }

  async function submitComment(e, postId) {
    e.preventDefault();
    const input = e.target.text;
    const text = input.value.trim();
    if (!text) return;

    // Очистить инпут сразу
    input.value = '';

    try {
      const res = await fetch(`/api/groups/${GROUP_ID}/reply`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ parent_id: postId, text: text })
      });
      const data = await res.json();

      if (data.ok) {
        // Добавить коммент в DOM
        const c = data.comment;
        const html = `
          <div class="flex gap-2 mb-3 fade-in">
            <img src="${c.avatar ? `/files/${c.avatar}` : '/static/default-avatar.png'}" class="comment-avatar shrink-0">
            <div class="text-sm">
              <div class="bg-gray-100 px-3 py-2 rounded-2xl rounded-tl-none inline-block">
                <span class="font-bold text-gray-900 text-xs">${c.user_name}</span>
                <p class="text-gray-800 mt-0.5">${c.text}</p>
              </div>
              <div class="text-[10px] text-gray-400 mt-1 ml-1">Только что</div>
            </div>
          </div>
        `;
        document.getElementById(`comments-list-${postId}`).insertAdjacentHTML('beforeend', html);
      }
    } catch(err) {
      alert('Ошибка');
    }
  }

  // Lightbox
  function openLightbox(src) {
    document.getElementById('lightbox-image').src = src;
    document.getElementById('image-lightbox').classList.remove('hidden');
  }
  function closeLightbox() {
    document.getElementById('image-lightbox').classList.add('hidden');
  }

  // INIT
  document.addEventListener('DOMContentLoaded', loadFeed);

</script>
{% endblock %}